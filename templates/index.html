<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí≥ Gestion des D√©penses</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0f172a;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-color: #6366f1;
            --secondary-dark: #4f46e5;
            --accent-color: #06d6a0;
            --accent-gradient: linear-gradient(135deg, #06d6a0 0%, #10b981 100%);
            --surface-color: #ffffff;
            --background-color: #f8fafc;
            --background-gradient: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            --border-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-primary-rgb: 15, 23, 42;
            --text-secondary: #475569;
            --text-light: #94a3b8;
            --on-surface: #ffffff;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            
            /* Paleta de botones minimalista */
            --btn-primary-bg: #1e293b;
            --btn-primary-hover: #334155;
            --btn-primary-text: #ffffff;
            
            --btn-secondary-bg: #f1f5f9;
            --btn-secondary-hover: #e2e8f0;
            --btn-secondary-text: #334155;
            
            --btn-success-bg: #10b981;
            --btn-success-hover: #059669;
            --btn-success-text: #ffffff;
            
            --btn-danger-bg: #ef4444;
            --btn-danger-hover: #dc2626;
            --btn-danger-text: #ffffff;
            
            --btn-neutral-bg: #64748b;
            --btn-neutral-hover: #475569;
            --btn-neutral-text: #ffffff;
            
            --shadow-light: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-strong: 0 8px 32px rgba(0,0,0,0.12);
            --elevation-2: 0 2px 4px rgba(0,0,0,0.1);
            --elevation-3: 0 4px 8px rgba(0,0,0,0.15);
            --elevation-4: 0 8px 16px rgba(0,0,0,0.2);
            
            --radius-small: 6px;
            --radius-medium: 12px;
            --radius-large: 16px;
            --border-radius-large: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        /* === MULTI-SELECT ELEGANTE === */
        .multiselect-container {
            position: relative;
            width: 100%;
        }
        
        .multiselect-display {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-medium);
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            min-height: 48px;
        }
        
        .multiselect-display:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .multiselect-display.active {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        
        .multiselect-selected {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .multiselect-selected.placeholder {
            color: var(--text-light);
            font-weight: 400;
        }
        
        .multiselect-arrow {
            color: var(--text-secondary);
            transition: transform 0.3s ease;
            font-size: 12px;
        }
        
        .multiselect-display.active .multiselect-arrow {
            transform: rotate(180deg);
        }
        
        .multiselect-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--surface-color);
            border: 2px solid var(--secondary-color);
            border-radius: var(--radius-medium);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
            max-height: 280px;
            overflow-y: auto;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .multiselect-dropdown.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .multiselect-search {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--surface-color);
            z-index: 1;
        }
        
        .multiselect-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .multiselect-search input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .multiselect-options {
            padding: 8px;
        }
        
        .multiselect-option {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: var(--radius-small);
            transition: all 0.2s ease;
            gap: 10px;
        }
        
        .multiselect-option:hover {
            background: rgba(99, 102, 241, 0.08);
        }
        
        .multiselect-option.selected {
            background: rgba(99, 102, 241, 0.12);
            font-weight: 500;
        }
        
        .multiselect-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .multiselect-option.selected .multiselect-checkbox {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .multiselect-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .multiselect-option.selected .multiselect-checkbox::after {
            opacity: 1;
        }
        
        .multiselect-label {
            flex: 1;
            color: var(--text-primary);
        }
        
        .multiselect-actions {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            background: var(--background-color);
        }
        
        .multiselect-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius-small);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .multiselect-btn-all {
            background: rgba(99, 102, 241, 0.1);
            color: var(--secondary-color);
        }
        
        .multiselect-btn-all:hover {
            background: rgba(99, 102, 241, 0.2);
        }
        
        .multiselect-btn-clear {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }
        
        .multiselect-btn-clear:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        /* === SELECTOR D√çA DE CORTE === */
        .cutoff-day-selector {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            border: 2px solid rgba(99, 102, 241, 0.25);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .cutoff-day-selector:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }
        
        .cutoff-day-label {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .cutoff-day-label strong {
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        .cutoff-day-label small {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
            opacity: 0.9;
        }
        
        .cutoff-day-input {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .cutoff-day-input input[type="number"] {
            width: 85px;
            padding: 12px 16px;
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            color: var(--secondary-color);
            background: var(--surface-color);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }
        
        .cutoff-day-input input[type="number"]:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }
        
        .cutoff-day-input input[type="number"]:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            transform: scale(1.05);
        }
        
        .cutoff-day-input input[type="number"]::-webkit-inner-spin-button,
        .cutoff-day-input input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            height: 36px;
        }
        
        .btn-confirm-cutoff {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            white-space: nowrap;
        }
        
        .btn-confirm-cutoff:hover {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px) scale(1.03);
        }
        
        .btn-confirm-cutoff:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        @media (max-width: 768px) {
            .cutoff-day-selector {
                flex-direction: column;
                align-items: flex-start;
                padding: 16px 20px;
                gap: 16px;
            }
            
            .cutoff-day-input {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn-confirm-cutoff {
                flex: 1;
                min-width: 120px;
            }
        }

        /* ============= NAVBAR MODERNA PROFESIONAL ============= */
        /* === HEADER MINIMALISTA PROFESIONAL === */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 24px;
            z-index: 1000;
            box-shadow: 0 4px 24px rgba(99, 102, 241, 0.4);
        }

        .sidebar-toggle-header {
            position: absolute;
            left: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.18);
            border: 2px solid rgba(255, 255, 255, 0.35);
            border-radius: 14px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .sidebar-toggle-header:hover {
            background: rgba(255, 255, 255, 0.28);
            transform: scale(1.08);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .sidebar-toggle-header:active {
            transform: scale(0.95);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 14px;
            background: rgba(255, 255, 255, 0.12);
            padding: 10px 28px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .header-icon {
            font-size: 32px;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header-text {
            color: white;
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.03em;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .header-spacer {
            flex: 1;
        }
        
        /* Legacy navbar styles - ocultar */
        .app-navbar {
            display: none;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .navbar-brand-icon {
            font-size: 1.5rem;
        }
        
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .navbar-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.12));
            border: 2px solid rgba(99, 102, 241, 0.25);
            border-radius: 16px;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .user-badge:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), rgba(139, 92, 246, 0.18));
            border-color: var(--secondary-color);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }
        
        .user-avatar {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.9);
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .user-name-navbar {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.9rem;
            letter-spacing: -0.01em;
        }
        
        .user-role-navbar {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.85;
        }
        
        .logout-btn-navbar {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(220, 38, 38, 0.12));
            color: #dc2626;
            border: 2px solid rgba(239, 68, 68, 0.25);
            border-radius: 14px;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.1);
            letter-spacing: -0.01em;
        }
        
        .logout-btn-navbar:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-color: transparent;
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
        }
        
        .logout-btn-navbar:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }
        
        /* Hamburger Menu Button */
        .hamburger-btn {
            display: none;
            flex-direction: column;
            gap: 5px;
            padding: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .hamburger-line {
            width: 24px;
            height: 2px;
            background: var(--text-primary);
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .hamburger-btn.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .hamburger-btn.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger-btn.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }
        
        /* === LAYOUT CMS PROFESIONAL === */
        .cms-layout {
            display: flex;
            min-height: 100vh;
            padding-top: 64px;
        }

        /* Sidebar CMS */
        .cms-sidebar {
            position: fixed;
            left: 0;
            top: 64px;
            width: 280px;
            height: calc(100vh - 64px);
            background: linear-gradient(180deg, #ffffff 0%, #f8f9ff 100%);
            border-right: 2px solid rgba(99, 102, 241, 0.1);
            padding: 24px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            overflow-y: auto;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.04);
        }

        /* Perfil usuario en sidebar */
        .sidebar-user-profile {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            margin: 0 16px 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.12));
            border-radius: 16px;
            border: 2px solid rgba(99, 102, 241, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-user-profile:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), rgba(139, 92, 246, 0.18));
            border-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .sidebar-user-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            border: 3px solid rgba(255, 255, 255, 0.9);
        }

        .sidebar-user-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sidebar-user-name {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1rem;
            letter-spacing: -0.01em;
        }

        .sidebar-user-role {
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.85;
        }

        .cms-sidebar.collapsed {
            left: -280px;
        }

        .sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 16px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            border-radius: 14px;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 2px solid transparent;
            letter-spacing: -0.01em;
        }

        .sidebar-item:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            border-color: rgba(99, 102, 241, 0.2);
            transform: translateX(4px);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
            transform: translateX(4px);
        }

        .sidebar-item.sidebar-logout {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.08));
            border-color: rgba(239, 68, 68, 0.2);
            color: #dc2626;
        }

        .sidebar-item.sidebar-logout:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }

        .sidebar-item-icon {
            font-size: 22px;
            width: 28px;
            text-align: center;
        }

        .sidebar-item-text {
            flex: 1;
            font-weight: 600;
        }

        .sidebar-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.2), transparent);
            margin: 16px 0;
        }

        .sidebar-section-title {
            padding: 12px 18px 8px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
        }

        /* Main content ajustado */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .content-view {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-view.active {
            display: block;
        }

        /* Toggle sidebar button */
        .sidebar-toggle {
            position: fixed;
            left: 292px;
            top: 72px;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 101;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            display: none; /* Oculto en desktop, visible en mobile */
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .sidebar-toggle.collapsed {
            left: 12px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============= RESPONSIVE CMS SIDEBAR ============= */
        @media (max-width: 1200px) {
            .cms-sidebar {
                left: -280px;
            }

            .cms-sidebar.collapsed {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .sidebar-toggle {
                display: flex; /* Mostrar en tablet/mobile */
                left: 12px;
            }

            .sidebar-toggle.collapsed {
                left: 292px;
            }

            .sidebar-toggle-header {
                display: flex; /* Mostrar hamburger en header m√≥vil */
            }
        }

        /* ============= RESPONSIVE MOBILE ============= */
        @media (max-width: 968px) {
            .app-navbar {
                padding: 0 16px;
            }
            
            .hamburger-btn {
                display: flex;
                order: 3;
            }
            
            .navbar-brand {
                order: 1;
                font-size: 1.1rem;
            }
            
            .navbar-user {
                order: 2;
                flex: 1;
                justify-content: flex-end;
                margin-right: 16px;
            }
            
            .navbar-menu {
                position: fixed;
                top: 70px;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                flex-direction: column;
                gap: 0;
                padding: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
                border-bottom: 1px solid rgba(226, 232, 240, 0.8);
                transform: translateY(-100%);
                opacity: 0;
                pointer-events: none;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .navbar-menu.active {
                transform: translateY(0);
                opacity: 1;
                pointer-events: all;
            }
            
            .nav-btn {
                width: 100%;
                justify-content: flex-start;
                padding: 14px 16px;
                border-radius: 8px;
            }
            
            .user-badge {
                padding: 6px 12px;
                gap: 8px;
            }
            
            .user-details {
                display: none;
            }
            
            .user-avatar {
                width: 36px;
                height: 36px;
            }
            
            .logout-btn-navbar {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .app-navbar {
                height: 60px;
                padding: 0 12px;
            }
            
            .cms-layout {
                padding-top: 60px;
            }
            
            .navbar-brand {
                font-size: 1rem;
            }
            
            .navbar-menu {
                top: 60px;
            }
            
            .user-badge {
                padding: 4px 8px;
            }
            
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.85rem;
            }
            
            .logout-btn-navbar span {
                display: none;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px 0;
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 400;
        }

        /* Filtros de fecha */
        .date-filters {
            margin-bottom: 28px;
            padding: 28px 32px;
            background: var(--surface-color);
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(99, 102, 241, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .date-filters:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .date-filters-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.1);
        }

        .date-filters-header h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            letter-spacing: -0.02em;
        }

        .date-filters-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.5;
            opacity: 0.85;
        }

        .date-inputs-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }

        .date-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: var(--radius-medium);
            border: 1px solid rgba(99, 102, 241, 0.1);
            transition: all 0.2s ease;
        }

        .date-input-row:hover {
            background: rgba(99, 102, 241, 0.08);
            border-color: rgba(99, 102, 241, 0.2);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .date-input-inline {
            display: flex;
            align-items: center;
            gap: 24px;
            justify-content: space-between;
        }

        .date-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .date-input-group .date-input-label {
            min-width: 100px;
            white-space: nowrap;
        }

        .date-input-group .date-input-field {
            flex: 1;
            max-width: 200px;
        }

        .date-input-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 100px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .date-input-field {
            flex: 1;
            max-width: 200px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-filter-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: var(--radius-medium);
            border: 1px solid rgba(99, 102, 241, 0.1);
            transition: all 0.2s ease;
        }

        .user-filter-section:hover {
            background: rgba(99, 102, 241, 0.08);
            border-color: rgba(99, 102, 241, 0.2);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }
        
        /* Filtros multiselect minimalistas */
        .multiselect-wrapper {
            position: relative;
            margin-top: 8px;
        }
        
        .multiselect-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            max-height: 180px;
            overflow-y: auto;
            padding: 8px;
            background: var(--surface-color);
            border-radius: var(--radius-small);
            border: 1px solid var(--border-color);
        }
        
        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--background-color);
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            font-size: 0.85rem;
        }
        
        .multiselect-option:hover {
            background: rgba(99, 102, 241, 0.08);
            border-color: rgba(99, 102, 241, 0.2);
        }
        
        .multiselect-option input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--secondary-color);
        }
        
        .multiselect-option.selected {
            background: rgba(99, 102, 241, 0.12);
            border-color: var(--secondary-color);
            font-weight: 500;
        }
        
        .multiselect-option label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            font-weight: inherit;
        }
        
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            justify-content: flex-end;
        }
        
        .filter-actions .btn-mini {
            padding: 6px 12px;
            font-size: 0.75rem;
            border-radius: var(--radius-small);
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-actions .btn-mini:hover {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .filter-summary {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(16, 185, 129, 0.08);
            border-radius: var(--radius-small);
            font-size: 0.8rem;
            color: var(--success-color);
            font-weight: 500;
        }

        .actions-section {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            padding-top: 16px;
            margin-top: 16px;
            border-top: 2px solid rgba(99, 102, 241, 0.1);
        }

        .filter-group input[type="date"],
        .filter-group select,
        .date-input-field input[type="date"] {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 0.95rem;
            background: var(--surface-color);
            transition: all 0.2s ease;
            width: 100%;
        }

        .filter-group input[type="date"]:focus,
        .filter-group select:focus,
        .date-input-field input[type="date"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
            transform: translateY(-1px);
        }

        .filter-group select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 36px;
        }

        .btn-filter {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            color: var(--text-primary);
            border: 2px solid rgba(99, 102, 241, 0.2);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            white-space: nowrap;
            letter-spacing: -0.01em;
        }

        .btn-filter:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.12));
            border-color: var(--secondary-color);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.2);
        }

        .btn-filter:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .btn-today {
            background: linear-gradient(135deg, var(--btn-primary-bg), var(--secondary-color));
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-today:hover {
            background: linear-gradient(135deg, var(--btn-primary-hover), #5b21b6);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            transform: translateY(-2px) scale(1.03);
        }

        .btn-clear-dates {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.08));
            color: #dc2626;
            border: 2px solid rgba(239, 68, 68, 0.2);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.1);
        }

        .btn-clear-dates:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(220, 38, 38, 0.12));
            border-color: #ef4444;
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.25);
            transform: translateY(-2px) scale(1.02);
        }

        .btn-confirm {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-confirm:hover {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px) scale(1.03);
        }

        .btn-confirm:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        /* Estilos para checkbox del dashboard */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius-small);
            transition: all 0.2s ease;
            min-height: 44px; /* Mejor √°rea de toque en m√≥viles */
            width: 100%;
        }

        .checkbox-container:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--success-color);
            cursor: pointer;
            flex-shrink: 0; /* Evita que el checkbox se encoja */
        }

        .checkbox-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 4px;
            line-height: 1.4;
            flex: 1; /* Toma el espacio disponible */
        }

        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .checkbox-container {
                padding: 12px;
                gap: 10px;
                min-height: 48px; /* √Årea de toque m√°s grande en m√≥viles */
            }

            .checkbox-container input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }

            .checkbox-label {
                font-size: 0.95rem;
                gap: 6px;
            }

            .date-input-inline {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .date-input-group {
                justify-content: space-between;
            }

            .date-input-group .date-input-label {
                min-width: 90px;
                font-size: 0.85rem;
            }

            .date-input-group .date-input-field {
                max-width: 160px;
            }
        }


        /* Sistema de botones unificado */
        .action-section {
            margin: 32px 0;
            padding: 24px;
            background: var(--surface-color);
            border-radius: var(--radius-large);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .action-section h3 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
        }

        .export-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .main-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        /* Jerarqu√≠a de botones simplificada */
        .btn-primary {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            border: 1px solid var(--btn-primary-bg);
            padding: 16px 24px;
            border-radius: var(--radius-medium);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-medium);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 48px;
            justify-content: center;
            text-transform: none;
            letter-spacing: 0;
        }

        .btn-primary:hover {
            background: var(--btn-primary-hover);
            border-color: var(--btn-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-strong);
        }

        .btn-secondary {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--border-color);
            padding: 14px 20px;
            border-radius: var(--radius-medium);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-light);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            justify-content: center;
            text-transform: none;
            letter-spacing: 0;
        }

        .btn-secondary:hover {
            background: var(--btn-secondary-hover);
            border-color: var(--btn-secondary-text);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-tertiary {
            background: var(--btn-neutral-bg);
            color: var(--btn-neutral-text);
            border: 1px solid var(--btn-neutral-bg);
            padding: 12px 18px;
            border-radius: var(--radius-medium);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-light);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-height: 40px;
            justify-content: center;
            text-transform: none;
            letter-spacing: 0;
        }

        .btn-tertiary:hover {
            background: var(--btn-neutral-hover);
            border-color: var(--btn-neutral-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface-color);
            padding: 16px;
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-light);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .actions {
            text-align: center;
            margin-bottom: 24px;
            position: relative;
        }

        /* Botones de acci√≥n en lista */
        .btn-action {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--border-color);
            padding: 8px 14px;
            border-radius: var(--radius-small);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: none;
            letter-spacing: 0;
            min-width: 70px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 32px;
            box-shadow: var(--shadow-light);
        }

        .btn-action:hover {
            background: var(--btn-secondary-hover);
            border-color: var(--btn-secondary-text);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-action.btn-edit {
            background: rgba(30, 41, 59, 0.1);
            color: var(--btn-primary-bg);
            border-color: rgba(30, 41, 59, 0.2);
        }

        .btn-action.btn-edit:hover {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            border-color: var(--btn-primary-bg);
        }

        .btn-action.btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: var(--btn-danger-bg);
            border-color: rgba(239, 68, 68, 0.2);
        }

        .btn-action.btn-delete:hover {
            background: var(--btn-danger-bg);
            color: var(--btn-danger-text);
            border-color: var(--btn-danger-bg);
        }

        .motivos-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-medium);
            background: var(--surface-color);
        }

        .motivo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .motivo-item:last-child {
            border-bottom: none;
        }

        .motivo-item:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        
        .motivo-item.inactivo {
            opacity: 0.6;
            background: rgba(0, 0, 0, 0.02);
        }
        
        .motivo-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .motivo-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .motivo-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .motivo-usage {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-right: 12px;
        }

        .motivo-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .motivo-toggle-btn {
            background: rgba(99, 102, 241, 0.1);
            color: var(--secondary-color);
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 6px 12px;
            border-radius: var(--radius-small);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .motivo-toggle-btn:hover {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .motivo-detail-btn {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
            padding: 6px 12px;
            border-radius: var(--radius-small);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .motivo-detail-btn:hover {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        
        .motivo-delete-btn {
            background: var(--btn-danger-bg);
            color: var(--btn-danger-text);
            border: 1px solid var(--btn-danger-bg);
            padding: 8px 14px;
            border-radius: var(--radius-small);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-light);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            min-height: 32px;
        }

        .motivo-delete-btn:hover {
            background: var(--btn-danger-hover);
            border-color: var(--btn-danger-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .motivo-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .motivo-detail-btn {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--btn-secondary-bg);
            padding: 8px 14px;
            border-radius: var(--radius-small);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-light);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            min-height: 32px;
        }

        .motivo-detail-btn:hover {
            background: var(--btn-secondary-hover);
            border-color: var(--btn-secondary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        /* Estilos para gesti√≥n de motivos */
        .add-motivo-section {
            margin-bottom: 32px;
            padding: 20px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: var(--radius-medium);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .add-motivo-section h3 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 16px 0;
            text-align: center;
        }

        .add-motivo-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .add-motivo-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .existing-motivos-section h3 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 16px 0;
            text-align: center;
        }

        #newMotivoName {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 0.95rem;
            background: var(--surface-color);
            transition: all 0.2s ease;
        }

        #newMotivoName:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
            transform: translateY(-1px);
        }

        #newMotivoName::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Estilos para gesti√≥n de detalles de viajes */
        .add-detalle-section {
            margin-bottom: 32px;
            padding: 20px;
            background: rgba(34, 197, 94, 0.05);
            border-radius: var(--radius-medium);
            border: 1px solid rgba(34, 197, 94, 0.1);
        }

        .add-detalle-section h3 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 16px 0;
            text-align: center;
        }

        .add-detalle-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .add-detalle-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .existing-detalles-section h3 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 16px 0;
            text-align: center;
        }

        .detalles-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .detalle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            transition: all 0.2s ease;
        }

        .detalle-item:hover {
            background: var(--surface-hover);
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .detalle-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detalle-importe {
            font-weight: 600;
            color: var(--success-color);
            font-size: 1.1rem;
        }

        .detalle-descripcion {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .detalle-estado {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 12px;
        }

        .detalle-cuadrado {
            background: var(--success-color);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-small);
            font-size: 0.7rem;
            font-weight: 600;
        }

        .detalle-pendiente {
            background: var(--warning-color);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-small);
            font-size: 0.7rem;
            font-weight: 600;
        }

        .detalle-delete-btn {
            background: var(--btn-danger-bg);
            color: var(--btn-danger-text);
            border: 1px solid var(--btn-danger-bg);
            padding: 6px 10px;
            border-radius: var(--radius-small);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-light);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            min-height: 28px;
        }

        .detalle-delete-btn:hover {
            background: var(--btn-danger-hover);
            border-color: var(--btn-danger-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        #nuevoDetalleImporte, #nuevoDetalleMoneda {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 0.95rem;
            background: var(--surface-color);
            transition: all 0.2s ease;
        }

        #nuevoDetalleImporte:focus, #nuevoDetalleDevise:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
            transform: translateY(-1px);
        }

        #nuevoDetalleImporte::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Estilos base para todos los botones */
        .btn {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            border: 1px solid var(--btn-primary-bg);
            padding: 10px 20px;
            border-radius: var(--radius-small);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            outline: none;
            min-height: 40px;
            justify-content: center;
            box-shadow: var(--shadow-light);
        }

        .btn:hover {
            background: var(--btn-primary-hover);
            border-color: var(--btn-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-light);
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1);
        }

        /* Variantes de botones */
        .btn-primary {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            border-color: var(--btn-primary-bg);
        }

        .btn-primary:hover {
            background: var(--btn-primary-hover);
            border-color: var(--btn-primary-hover);
        }

        .btn-secondary {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--btn-secondary-hover);
            border-color: var(--btn-secondary-text);
        }

        .btn-success {
            background: var(--btn-success-bg);
            color: var(--btn-success-text);
            border-color: var(--btn-success-bg);
        }

        .btn-success:hover {
            background: var(--btn-success-hover);
            border-color: var(--btn-success-hover);
        }

        .btn-danger {
            background: var(--btn-danger-bg);
            color: var(--btn-danger-text);
            border-color: var(--btn-danger-bg);
        }

        .btn-danger:hover {
            background: var(--btn-danger-hover);
            border-color: var(--btn-danger-hover);
        }

        .btn-neutral {
            background: var(--btn-neutral-bg);
            color: var(--btn-neutral-text);
            border-color: var(--btn-neutral-bg);
        }

        .btn-neutral:hover {
            background: var(--btn-neutral-hover);
            border-color: var(--btn-neutral-hover);
        }



        /* Texto de botones responsive */
        .btn-text-mobile {
            display: none;
        }

        .btn-text-desktop {
            display: inline;
        }

        .expenses-container {
            background: var(--surface-color);
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-light);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .expenses-container:hover {
            box-shadow: var(--shadow-medium);
        }

        .table-header {
            background: var(--surface-color);
            color: var(--text-primary);
            padding: 16px;
            font-weight: 500;
            font-size: 0.9rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .table-content {
            height: 420px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .expense-item {
            display: grid;
            grid-template-columns: 50px 30px 1fr 80px 120px 140px;
            gap: 12px;
            padding: 18px;
            margin: 8px 12px;
            border-radius: var(--radius-small);
            background: var(--surface-color);
            align-items: center;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(20px);
            animation: slideIn 0.3s ease forwards;
        }

        .expense-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
            border-color: var(--accent-color);
        }

        /* Estados de cuadre para expense-item */
        .expense-item.cuadrado {
            border-left: 4px solid #10b981;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.08) 0%, var(--surface-color) 25%);
        }

        .expense-item.pendiente {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.08) 0%, var(--surface-color) 25%);
        }

        .expense-item.cuadrado:hover {
            border-left-color: #059669;
            box-shadow: var(--shadow-light), 0 0 0 2px rgba(16, 185, 129, 0.15);
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.12) 0%, var(--surface-color) 25%);
        }

        .expense-item.pendiente:hover {
            border-left-color: #d97706;
            box-shadow: var(--shadow-light), 0 0 0 2px rgba(245, 158, 11, 0.15);
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.12) 0%, var(--surface-color) 25%);
        }

        .expense-item:nth-child(1) { animation-delay: 0.1s; }
        .expense-item:nth-child(2) { animation-delay: 0.2s; }
        .expense-item:nth-child(3) { animation-delay: 0.3s; }
        .expense-item:nth-child(4) { animation-delay: 0.4s; }
        .expense-item:nth-child(5) { animation-delay: 0.5s; }
        .expense-item:nth-child(n+6) { animation-delay: 0.6s; }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .expense-image {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-small);
            object-fit: cover;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .expense-image:hover {
            transform: scale(1.05);
        }

        .expense-image-placeholder {
            width: 40px;
            height: 40px;
            background: var(--btn-secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: var(--shadow-light);
            color: var(--text-secondary);
            cursor: default;
        }

        /* Checkbox de selecci√≥n en la segunda columna */
        .expense-checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .expense-checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--secondary-color);
            border-radius: 3px;
        }

        .expense-info h4 {
            margin-bottom: 4px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.3;
        }

        .expense-info p {
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
            line-height: 1.3;
        }

        .expense-amount {
            text-align: right;
            font-weight: 600;
            color: var(--accent-color);
            font-size: 0.9rem;
        }

        .expense-amount-value {
            color: var(--accent-color);
            font-size: 1rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .expense-amount small {
            display: block;
            color: var(--text-light);
            font-size: 0.65rem;
            font-weight: 400;
            margin-top: 2px;
        }

        .expense-actions {
            display: flex;
            gap: 6px;
            flex-direction: row;
            justify-content: flex-end;
            align-items: center;
            min-width: 140px; /* Reducido para dejar espacio al checkbox */
        }

        .expense-cuadre {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            max-width: 120px;
            padding: 0 8px;
        }

        .cuadre-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .cuadre-badge {
            padding: 6px 12px;
            border-radius: var(--radius-medium);
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            min-width: 80px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 28px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .cuadre-badge.cuadrado {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .cuadre-badge.cuadrado:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .cuadre-badge.pendiente {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .cuadre-badge.pendiente:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .cuadre-status-empty {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
            text-align: center;
            padding: 6px 12px;
            background: rgba(156, 163, 175, 0.1);
            border-radius: var(--radius-medium);
            border: 1px dashed rgba(156, 163, 175, 0.3);
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

                .btn-cuadre {
            background: #f8f9fa;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            padding: 6px 12px;
            border-radius: var(--radius-small);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 32px;
            min-width: 90px;
            white-space: nowrap;
        }

        .btn-cuadre:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-cuadre.btn-descuadrar {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .btn-cuadre.btn-descuadrar:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #7f1d1d;
        }

        .btn-cuadre.btn-buscar {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #dbeafe;
        }

        .btn-cuadre.btn-buscar:hover {
            background: #dbeafe;
            border-color: #93c5fd;
            color: #1e3a8a;
        }

        /* Indicadores de cuadre en el t√≠tulo y descripci√≥n */
        .cuadre-indicator {
            font-size: 0.8em;
            margin-left: 4px;
            vertical-align: middle;
        }

        .cuadre-indicator.cuadrado {
            color: var(--success-color);
        }

        .cuadre-indicator.pendiente {
            color: var(--warning-color);
        }

        .cuadre-text {
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 4px;
            padding: 2px 6px;
            border-radius: var(--radius-small);
        }

        .cuadre-text.cuadrado {
            color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
        }

        .cuadre-text.pendiente {
            color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
        }

        /* Responsive para cuadre */
        @media (max-width: 768px) {
            .expense-item {
                grid-template-columns: 40px 25px 1fr 70px 90px 110px;
                gap: 8px;
                padding: 12px;
                margin: 6px 8px;
            }

            .expense-cuadre {
                min-width: 90px;
                max-width: 90px;
                padding: 0 4px;
            }

            .cuadre-badge {
                padding: 4px 8px;
                font-size: 0.7rem;
                min-width: 65px;
                height: 26px;
            }

            .btn-cuadre {
                padding: 4px 8px;
                font-size: 0.7rem;
                min-width: 65px;
                min-height: 26px;
                gap: 2px;
            }

            .cuadre-status {
                gap: 6px;
            }
        }

        @media (max-width: 480px) {
            .expense-item {
                grid-template-columns: 35px 20px 1fr 60px 80px 90px;
                gap: 6px;
                padding: 10px;
                margin: 4px 6px;
            }

            .expense-cuadre {
                min-width: 80px;
                max-width: 80px;
                padding: 0 2px;
            }

            .cuadre-badge {
                padding: 3px 6px;
                font-size: 0.65rem;
                min-width: 55px;
                height: 24px;
            }

            .btn-cuadre {
                padding: 3px 6px;
                font-size: 0.65rem;
                min-width: 55px;
                min-height: 24px;
                gap: 1px;
            }

            .cuadre-indicator {
                font-size: 0.7em;
            }

            .cuadre-text {
                font-size: 0.65em;
                padding: 1px 4px;
            }

            .btn-text-desktop {
                display: none;
            }

            .btn-text-mobile {
                display: inline;
            }
        }

        @media (min-width: 481px) {
            .btn-text-desktop {
                display: inline;
            }

            .btn-text-mobile {
                display: none;
            }
        }

         /* Estilos para resumen de viajes */
         .resumen-viajes-container {
             display: flex;
             flex-direction: column;
             gap: 12px;
             max-height: 400px;
             overflow-y: auto;
         }

         .resumen-viaje-item {
             display: flex;
             align-items: center;
             justify-content: space-between;
             padding: 16px;
             background: var(--surface-color);
             border: 1px solid var(--border-color);
             border-radius: var(--radius-medium);
             transition: all 0.2s ease;
         }

         .resumen-viaje-item:hover {
             background: var(--surface-hover);
             border-color: var(--accent-color);
             transform: translateY(-1px);
             box-shadow: var(--shadow-light);
         }

         .resumen-viaje-info {
             flex: 1;
             display: flex;
             flex-direction: column;
             gap: 4px;
         }

         .resumen-viaje-nombre {
             font-weight: 600;
             color: var(--text-primary);
             font-size: 1.1rem;
         }

         .resumen-viaje-stats {
             display: flex;
             gap: 16px;
             font-size: 0.9rem;
         }

         .resumen-stat {
             display: flex;
             align-items: center;
             gap: 4px;
         }

         .resumen-stat.total {
             color: var(--text-secondary);
         }

         .resumen-stat.pendiente {
             color: var(--warning-color);
             font-weight: 600;
         }

         .resumen-viaje-actions {
             display: flex;
             gap: 8px;
             align-items: center;
         }

         .btn-resumen {
             background: var(--btn-secondary-bg);
             color: var(--btn-secondary-text);
             border: 1px solid var(--btn-secondary-bg);
             padding: 8px 12px;
             border-radius: var(--radius-small);
             font-size: 0.8rem;
             cursor: pointer;
             transition: all 0.2s ease;
             box-shadow: var(--shadow-light);
             display: inline-flex;
             align-items: center;
             gap: 4px;
             min-height: 32px;
             white-space: nowrap;
         }

         .btn-resumen:hover {
             background: var(--btn-secondary-hover);
             border-color: var(--btn-secondary-hover);
             transform: translateY(-1px);
             box-shadow: var(--shadow-medium);
        }

        /* Unificar estilos de botones de selecci√≥n m√∫ltiple */
        .bulk-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: center;
        }

        .bulk-actions .btn-secondary,
        .bulk-actions .btn-success,
        .bulk-actions .btn-danger,
        .bulk-actions .btn-tertiary,
        .bulk-actions .btn-warning {
            font-size: 0.85rem;
            padding: 10px 16px;
            border-radius: var(--radius-small);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            text-transform: none;
            letter-spacing: 0;
            min-height: 38px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            box-shadow: var(--shadow-light);
        }

        .bulk-actions .btn-secondary {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border-color: var(--border-color);
        }

        .bulk-actions .btn-secondary:hover {
            background: var(--btn-secondary-hover);
            border-color: var(--btn-secondary-text);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .bulk-actions .btn-success {
            background: var(--btn-success-bg);
            color: var(--btn-success-text);
            border-color: var(--btn-success-bg);
        }

        .bulk-actions .btn-success:hover {
            background: var(--btn-success-hover);
            border-color: var(--btn-success-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .bulk-actions .btn-danger {
            background: var(--btn-danger-bg);
            color: var(--btn-danger-text);
            border-color: var(--btn-danger-bg);
        }

        .bulk-actions .btn-danger:hover {
            background: var(--btn-danger-hover);
            border-color: var(--btn-danger-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .bulk-actions .btn-warning {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .bulk-actions .btn-warning:hover {
            background: #d97706;
            border-color: #d97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .bulk-actions .btn-tertiary {
            background: var(--btn-neutral-bg);
            color: var(--btn-neutral-text);
            border-color: var(--btn-neutral-bg);
        }

        .bulk-actions .btn-tertiary:hover {
            background: var(--btn-neutral-hover);
            border-color: var(--btn-neutral-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        /* Unificar estilos de botones de exportaci√≥n */
        .export-section {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: center;
        }

        .export-section .btn-success,
        .export-section .btn-tertiary {
            font-size: 0.85rem;
            padding: 10px 16px;
            border-radius: var(--radius-small);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            text-transform: none;
            letter-spacing: 0;
            min-height: 38px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            box-shadow: var(--shadow-light);
        }

        .export-section .btn-success {
            background: var(--btn-success-bg);
            color: var(--btn-success-text);
            border-color: var(--btn-success-bg);
        }

        .export-section .btn-success:hover {
            background: var(--btn-success-hover);
            border-color: var(--btn-success-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .export-section .btn-tertiary {
            background: var(--btn-neutral-bg);
            color: var(--btn-neutral-text);
            border-color: var(--btn-neutral-bg);
        }

        .export-section .btn-tertiary:hover {
            background: var(--btn-neutral-hover);
            border-color: var(--btn-neutral-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .selection-info {
            margin-top: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Estilos para la secci√≥n de selecci√≥n integrada */
        .integrated-selection-section {
            margin-top: 16px;
            padding: 16px;
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: var(--radius-small);
            border-top: 1px solid var(--border-color);
        }

        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .selection-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .selection-header .selection-info {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .bulk-actions-centered {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .bulk-actions-centered .btn-secondary,
        .bulk-actions-centered .btn-success,
        .bulk-actions-centered .btn-danger,
        .bulk-actions-centered .btn-tertiary,
        .bulk-actions-centered .btn-warning {
            font-size: 0.85rem;
            padding: 10px 16px;
            border-radius: var(--radius-small);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            text-transform: none;
            letter-spacing: 0;
            min-height: 38px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            box-shadow: var(--shadow-light);
        }

        .bulk-actions-centered .btn-secondary {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border-color: var(--border-color);
        }

        .bulk-actions-centered .btn-secondary:hover {
            background: var(--btn-secondary-hover);
            border-color: var(--btn-secondary-text);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .bulk-actions-centered .btn-success {
            background: var(--btn-success-bg);
            color: var(--btn-success-text);
            border-color: var(--btn-success-bg);
        }

        .bulk-actions-centered .btn-success:hover {
            background: var(--btn-success-hover);
            border-color: var(--btn-success-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .bulk-actions-centered .btn-danger {
            background: var(--btn-danger-bg);
            color: var(--btn-danger-text);
            border-color: var(--btn-danger-bg);
        }

        .bulk-actions-centered .btn-danger:hover {
            background: var(--btn-danger-hover);
            border-color: var(--btn-danger-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .bulk-actions-centered .btn-warning {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .bulk-actions-centered .btn-warning:hover {
            background: #d97706;
            border-color: #d97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .bulk-actions-centered .btn-tertiary {
            background: var(--btn-neutral-bg);
            color: var(--btn-neutral-text);
            border-color: var(--btn-neutral-bg);
        }

        .bulk-actions-centered .btn-tertiary:hover {
            background: var(--btn-neutral-hover);
            border-color: var(--btn-neutral-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        /* Estilos para la secci√≥n de exportaci√≥n centrada */
        .export-section-centered {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .export-section-centered .btn-success,
        .export-section-centered .btn-tertiary {
            font-size: 0.85rem;
            padding: 10px 16px;
            border-radius: var(--radius-small);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            text-transform: none;
            letter-spacing: 0;
            min-height: 38px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            box-shadow: var(--shadow-light);
        }

        .export-section-centered .btn-success {
            background: var(--btn-success-bg);
            color: var(--btn-success-text);
            border-color: var(--btn-success-bg);
        }

        .export-section-centered .btn-success:hover {
            background: var(--btn-success-hover);
            border-color: var(--btn-success-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .export-section-centered .btn-tertiary {
            background: var(--btn-neutral-bg);
            color: var(--btn-neutral-text);
            border-color: var(--btn-neutral-bg);
        }

        .export-section-centered .btn-tertiary:hover {
            background: var(--btn-neutral-hover);
            border-color: var(--btn-neutral-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 450px;
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-strong);
            transform: scale(0.95);
            transition: transform 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-color);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .close {
            color: var(--text-secondary);
            float: right;
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .original-user-info {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(99, 102, 241, 0.1));
            border-left: 4px solid var(--secondary-color);
            padding: 12px 20px;
            margin: 0;
            border-bottom: 1px solid var(--border-color);
        }

        .user-info-content {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
        }

        .user-info-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .user-info-name {
            color: var(--text-primary);
            font-weight: 600;
            background: rgba(99, 102, 241, 0.1);
            padding: 4px 12px;
            border-radius: 16px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .form-group {
            margin-bottom: 16px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.8rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 0.9rem;
            background: var(--surface-color);
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.1);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--accent-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .camera-section {
            text-align: center;
            margin-bottom: 32px;
            padding: 24px;
            border: 2px dashed rgba(98, 0, 234, 0.3);
            border-radius: var(--border-radius-large);
            background: linear-gradient(135deg, rgba(98, 0, 234, 0.05), rgba(3, 218, 198, 0.05));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .camera-section:hover {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(98, 0, 234, 0.1), rgba(3, 218, 198, 0.1));
        }

        .camera-btn {
            background: var(--secondary-color);
            color: var(--on-surface);
            border: none;
            padding: 16px 32px;
            border-radius: var(--border-radius-large);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin: 16px;
            box-shadow: var(--elevation-2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .camera-btn:hover {
            background: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: var(--elevation-3);
        }

        .preview-container {
            margin-top: 24px;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-medium);
            transition: all 0.2s ease;
        }

        .preview-image:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-strong);
        }

        /* Eliminar esta definici√≥n - se mantendr√° solo la nueva versi√≥n moderna */

        @keyframes slideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes slideInMobile {
            from {
                transform: translateY(-100%) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .ripple {
            position: relative;
            overflow: hidden;
        }

        .ripple:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ripple:active:after {
            width: 200px;
            height: 200px;
        }

        /* Sistema de notificaciones mejorado */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            font-weight: 500;
            font-size: 0.9rem;
            max-width: 400px;
            z-index: 10000;
            transform: translateX(120%);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            color: white;
        }

        .message.show {
            transform: translateX(0);
        }

        .message.success {
            background: var(--btn-success-bg);
            border: 1px solid var(--btn-success-bg);
            color: var(--btn-success-text);
        }

        .message.error {
            background: var(--btn-danger-bg);
            border: 1px solid var(--btn-danger-bg);
            color: var(--btn-danger-text);
        }

        .message.warning {
            background: var(--warning-color);
            border: 1px solid var(--warning-color);
            color: white;
        }

        .message.info {
            background: var(--btn-primary-bg);
            border: 1px solid var(--btn-primary-bg);
            color: var(--btn-primary-text);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }

                    /* Opci√≥n de an√°lisis IA */
            .ai-analysis-option {
                transition: all 0.2s ease;
            }
            
            .ai-analysis-option:hover {
                background: rgba(99, 102, 241, 0.15) !important;
            }
            
            /* Responsive Design para Tabletas */
        @media (max-width: 1024px) {
            .btn-primary, .btn-secondary, .btn-tertiary {
                font-size: 0.85rem;
                padding: 10px 16px;
                min-height: 40px;
            }
            
            .action-section {
                margin-bottom: 20px;
            }
            
            .action-section h3 {
                font-size: 1rem;
            }
            
            .main-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .main-actions .btn-primary,
            .main-actions .btn-secondary {
                width: 100%;
            }
            
            .export-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .export-section .btn-success,
            .export-section .btn-tertiary {
                width: 100%;
            }
            
            .export-section-centered {
                flex-direction: column;
                gap: 10px;
            }
            
            .export-section-centered .btn-success,
            .export-section-centered .btn-tertiary {
                width: 100%;
            }
            
            .bulk-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .bulk-actions .btn-secondary,
            .bulk-actions .btn-success,
            .bulk-actions .btn-danger,
            .bulk-actions .btn-tertiary,
            .bulk-actions .btn-warning {
                width: 100%;
            }
            
            .bulk-actions-centered {
                flex-direction: column;
                gap: 10px;
            }
            
            .bulk-actions-centered .btn-secondary,
            .bulk-actions-centered .btn-success,
            .bulk-actions-centered .btn-danger,
            .bulk-actions-centered .btn-tertiary,
            .bulk-actions-centered .btn-warning {
                width: 100%;
            }
            
            .expense-item {
                grid-template-columns: 45px 28px 1fr 75px 130px;
                gap: 10px;
                padding: 14px;
            }
            
            .expense-actions {
                min-width: 130px;
                gap: 5px;
            }
            
            .expense-amount {
                font-size: 0.85rem;
            }
            
            .expense-amount-value {
                font-size: 0.95rem;
            }
            
            .integrated-selection-section {
                margin-top: 14px;
                padding: 14px;
            }
            
            .selection-header h4 {
                font-size: 0.88rem;
            }
        }
        
        /* Responsive Design para M√≥vil */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
                padding-bottom: 120px; /* M√°s espacio para scroll */
            }
            
            .ai-analysis-option {
                margin-top: 12px !important;
                padding: 10px !important;
            }
            
            .ai-analysis-option label {
                font-size: 0.85rem !important;
            }
            
            .ai-analysis-option small {
                font-size: 0.75rem !important;
            }
            
            .header {
                 margin-bottom: 16px;
                 padding: 16px 0;
            }
            
            .header h1 {
                 font-size: 1.7rem;
             }
             
             .header p {
                 font-size: 0.85rem;
                 margin-top: 4px;
            }
            
            .stats {
                 grid-template-columns: repeat(2, 1fr);
                 gap: 12px;
             }
             
             /* Responsive layout para expense-item */
             .expense-item {
                 grid-template-columns: 40px 25px 1fr 70px 110px;
                 gap: 8px;
                 padding: 12px;
                 margin: 6px 8px;
             }
             
             .expense-checkbox-container input[type="checkbox"] {
                 width: 16px;
                 height: 16px;
             }
             
             .expense-info h4 {
                 font-size: 0.85rem;
             }
             
             .expense-info p {
                 font-size: 0.65rem;
             }
             
             .expense-amount {
                 font-size: 0.8rem;
             }
             
             .expense-amount-value {
                 font-size: 0.9rem;
             }
             
             .expense-actions {
                 min-width: 110px;
                 gap: 4px;
             }
             
             /* Responsive para bulk-actions */
             .bulk-actions {
                 flex-direction: column;
                 gap: 8px;
                 align-items: stretch;
             }
             
             .bulk-actions .btn-secondary,
             .bulk-actions .btn-success,
             .bulk-actions .btn-danger,
             .bulk-actions .btn-tertiary,
             .bulk-actions .btn-warning {
                 font-size: 0.8rem;
                 padding: 8px 12px;
                 min-height: 36px;
                 width: 100%;
                 justify-content: center;
             }
             
             /* Responsive para bulk-actions-centered */
             .bulk-actions-centered {
                 flex-direction: column;
                 gap: 8px;
                 align-items: stretch;
             }
             
             .bulk-actions-centered .btn-secondary,
             .bulk-actions-centered .btn-success,
             .bulk-actions-centered .btn-danger,
             .bulk-actions-centered .btn-tertiary,
             .bulk-actions-centered .btn-warning {
                 font-size: 0.8rem;
                 padding: 8px 12px;
                 min-height: 36px;
                 width: 100%;
                 justify-content: center;
             }
             
             /* Responsive para export-section */
             .export-section {
                 flex-direction: column;
                 gap: 8px;
                 align-items: stretch;
             }
             
             .export-section .btn-success,
             .export-section .btn-tertiary {
                 font-size: 0.8rem;
                 padding: 8px 12px;
                 min-height: 36px;
                 width: 100%;
                 justify-content: center;
             }
             
             /* Responsive para export-section-centered */
             .export-section-centered {
                 flex-direction: column;
                 gap: 8px;
                 align-items: stretch;
             }
             
             .export-section-centered .btn-success,
             .export-section-centered .btn-tertiary {
                 font-size: 0.8rem;
                 padding: 8px 12px;
                 min-height: 36px;
                 width: 100%;
                 justify-content: center;
             }
             
             /* Responsive para integrated-selection-section */
             .integrated-selection-section {
                 margin-top: 12px;
                 padding: 12px;
             }
             
             .selection-header {
                 flex-direction: column;
                 gap: 8px;
                 align-items: stretch;
                 text-align: center;
             }
             
             .selection-header h4 {
                 font-size: 0.85rem;
             }
             
             .selection-header .selection-info {
                 font-size: 0.75rem;
             }
             
             .date-filters {
                 padding: 16px;
             }
             
             .date-filters-header h3 {
                 font-size: 1rem;
             }
             
             .date-filters-header p {
                 font-size: 0.8rem;
             }
             
             .date-input-row {
                 flex-direction: column;
                 align-items: stretch;
                 gap: 8px;
                 padding: 16px;
             }
             
             .date-input-label {
                 min-width: auto;
                 font-size: 0.85rem;
                 text-align: center;
             }
             
             .date-input-field {
                 max-width: none;
             }
             
             .filter-group {
                 gap: 8px;
             }
             
             .filter-group label {
                 font-size: 0.8rem;
                 text-align: center;
             }
             
             .filter-group input[type="date"],
             .filter-group select {
                 padding: 12px;
                 font-size: 1rem;
             }
             
             .actions-section {
                 flex-direction: column;
                 gap: 8px;
             }
             
             .btn-filter {
                 padding: 12px 16px;
                 font-size: 0.9rem;
                 width: 100%;
                 margin-bottom: 0;
             }
             
             .export-section {
                 gap: 10px;
             }
             
             .btn-export {
                 padding: 10px 14px;
                 font-size: 0.8rem;
             }

            
            .stat-card {
                padding: 12px;
            }
            
            .stat-card h3 {
                font-size: 0.7rem;
            }
            
            .stat-card .value {
                font-size: 1.3rem;
            }
            
            /* Botones principales m√°s grandes y t√°ctiles */
            .add-button-container {
                gap: 12px;
                margin: 20px 0;
            }
            
            .add-button, .manage-button {
                padding: 16px 24px;
                font-size: 0.9rem;
                min-height: 48px; /* Tama√±o m√≠nimo para touch */
                white-space: nowrap;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
            
            /* Mejoras para todos los botones en m√≥vil */
            .btn, .btn-primary, .btn-secondary, .btn-tertiary, 
            .btn-success, .btn-danger, .btn-filter {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 0.9rem;
                gap: 8px;
            }
            
            .btn-action {
                min-height: 40px;
                padding: 10px 16px;
                font-size: 0.85rem;
            }
            
                         /* Lista de gastos responsive */
             .expense-item {
                 grid-template-columns: 48px 1fr 80px 50px;
                 gap: 16px;
                 padding: 20px;
                 margin: 10px;
             }
             
             .expense-info h4 {
                 font-size: 0.95rem;
                 margin-bottom: 5px;
                 font-weight: 600;
                 line-height: 1.3;
             }
             
             .expense-info p {
                 font-size: 0.8rem;
                 margin-bottom: 4px;
                 color: var(--text-light);
                 line-height: 1.4;
             }
             
             .expense-amount {
                 text-align: right;
                 font-size: 0.9rem;
             }
             
             .expense-amount-value {
                 font-size: 1rem;
                 font-weight: 600;
             }
             
             .expense-amount small {
                 font-size: 0.75rem;
                 margin-top: 2px;
            }
            
            .expense-actions {
                 min-width: 50px;
                gap: 4px;
                 flex-direction: column;
                 align-items: center;
            }
            
            /* Mejoras espec√≠ficas para checkbox del dashboard en m√≥vil */
            .expense-actions .checkbox-container {
                width: 100%;
                padding: 10px 8px;
                min-height: 44px;
                justify-content: center;
                text-align: center;
                flex-direction: column;
                gap: 4px;
            }
            
            .expense-actions .checkbox-container input[type="checkbox"] {
                width: 18px;
                height: 18px;
                margin: 0;
            }
            
            .expense-actions .checkbox-label {
                font-size: 0.75rem;
                text-align: center;
                line-height: 1.2;
                white-space: nowrap;
            }
            
                         /* Botones m√°s grandes y t√°ctiles */
            .btn-small {
                 padding: 10px;
                 font-size: 1rem;
                 min-height: 44px;
                 min-width: 44px;
                 border-radius: 8px;
                 display: flex;
                 align-items: center;
                 justify-content: center;
                 gap: 4px;
                 background: var(--btn-secondary-bg);
                 color: var(--btn-secondary-text);
                 border: 1px solid var(--border-color);
                 box-shadow: var(--shadow-light);
             }
             
             .btn-small:hover {
                 background: var(--btn-secondary-hover);
                 border-color: var(--btn-secondary-text);
                 transform: translateY(-1px);
                 box-shadow: var(--shadow-medium);
             }
             
             /* Mostrar solo emojis en m√≥vil */
             .btn-text-desktop {
                 display: none;
             }
             
             .btn-text-mobile {
                 display: inline;
             }
            
                         .table-content {
                 height: 580px; /* M√°s altura para mejor visualizaci√≥n */
                 overflow-y: auto;
                 -webkit-overflow-scrolling: touch; /* Smooth scrolling en iOS */
                 padding: 4px 0;
             }
            
            /* Formulario responsive */
            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .form-group input,
            .form-group select {
                padding: 12px;
                font-size: 1rem;
                min-height: 48px; /* Tama√±o m√≠nimo para touch */
            }
            
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }
            
            /* Modal responsive */
            .modal-content {
                width: 95%;
                margin: 5% auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-header {
                padding: 16px;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            /* Botones del formulario */
            .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
                min-height: 48px;
                white-space: nowrap;
            }
            
            /* Previsualizaci√≥n de imagen */
            .preview-container {
                text-align: center;
                margin: 16px 0;
            }
            
            .preview-image {
                max-width: 100%;
                max-height: 200px;
                border-radius: 8px;
            }
            
                         /* Bot√≥n de c√°mara */
             .camera-btn {
                 padding: 12px 20px;
                 font-size: 0.9rem;
                 min-height: 48px;
                 width: 100%;
                 margin: 0 auto 16px auto;
                 display: block;
             }
             
             /* Mensajes de notificaci√≥n responsive */
             .message {
                 top: 16px;
                 right: 16px;
                 left: 16px;
                 max-width: none;
                 padding: 16px 18px;
                 font-size: 0.9rem;
                 border-radius: 12px;
                 box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                 border: 1px solid rgba(255,255,255,0.2);
                 backdrop-filter: blur(20px);
                 animation: slideInMobile 0.4s cubic-bezier(0.4, 0, 0.2, 1);
             }
             
             /* Mejorar motivos list en m√≥vil */
             .motivos-list {
                 max-height: 300px;
             }
             
             .motivo-item {
                 padding: 16px;
                 flex-direction: column;
                 align-items: flex-start;
                gap: 8px;
            }
             
             .motivo-name {
                 font-size: 0.9rem;
             }
             
             .motivo-delete-btn {
                 padding: 8px 16px;
                 font-size: 0.8rem;
                 min-height: 36px;
                 align-self: flex-end;
             }
             
             /* Mejorar c√°mara section */
             .camera-section {
                 padding: 20px;
                 margin-bottom: 24px;
             }
             
             /* Asegurar que los selects sean legibles */
             .form-group select {
                 -webkit-appearance: none;
                 -moz-appearance: none;
                 appearance: none;
                 background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                 background-repeat: no-repeat;
                 background-position: right 12px center;
                 background-size: 16px;
             }
         }

         @media (max-width: 480px) {
            .container {
                padding: 10px;
                padding-bottom: 140px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .date-filters {
                padding: 12px;
            }
            
            .date-filters-header h3 {
                font-size: 0.95rem;
            }
            
            .date-filters-header p {
                font-size: 0.75rem;
            }
            
            .date-input-row {
                padding: 12px;
            }
            
            .date-input-label {
                font-size: 0.8rem;
            }
            
            .filter-group label {
                font-size: 0.75rem;
            }
            
            .filter-group input[type="date"],
            .filter-group select {
                padding: 14px;
                font-size: 1rem;
            }
            
            .btn-filter {
                padding: 14px 18px;
                font-size: 0.9rem;
                width: 100%;
                margin-bottom: 0;
            }
             
                          .action-section {
                 margin: 16px 0;
                 padding: 12px;
             }
             
             .action-section h3 {
                 font-size: 0.85rem;
                 margin-bottom: 10px;
             }
             
             .export-section, .main-actions {
                 grid-template-columns: 1fr;
                gap: 8px;
             }
             
             .btn-primary, .btn-secondary, .btn-tertiary {
                 padding: 16px 20px;
                 font-size: 1rem;
             }
             
             .btn-action {
                 padding: 12px 14px;
                 font-size: 0.8rem;
                 min-width: 55px;
             }
             
                         .message {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                font-size: 0.85rem;
                padding: 14px 16px;
                animation: slideInMobile 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            }
            
                         .expense-item {
                 grid-template-columns: 44px 1fr 70px 32px;
                 padding: 18px;
                 margin: 8px;
                 gap: 12px;
             }
             
             .expense-info h4 {
                 font-size: 0.9rem;
                 margin-bottom: 4px;
                 line-height: 1.3;
                 font-weight: 600;
             }
             
             .expense-info p {
                 font-size: 0.75rem;
                 margin-bottom: 3px;
                 line-height: 1.3;
                 color: var(--text-light);
             }
             
             .expense-amount {
                 font-size: 0.85rem;
                 text-align: right;
             }
             
             .expense-amount-value {
                 font-size: 0.95rem;
                 font-weight: 600;
            }
            
            .expense-actions {
                 min-width: 32px;
                 gap: 3px;
                 flex-direction: column;
                 align-items: center;
             }
             
             .btn-action {
                 padding: 6px;
                 font-size: 0.9rem;
                 min-height: 32px;
                 min-width: 32px;
                 border-radius: 5px;
             }
            
            .modal-content {
                width: 98%;
                margin: 2% auto;
            }
            
            .form-group input,
            .form-group select {
                padding: 14px;
                font-size: 1.1rem;
            }
            
                         /* Botones del formulario en m√≥vil muy peque√±o */
             .modal-body > div:last-child {
                 flex-direction: column;
                 gap: 12px;
             }
             
             .modal-body > div:last-child .btn {
                 width: 100%;
                 padding: 16px;
                 font-size: 1rem;
             }
             
                         /* Mensajes en m√≥vil muy peque√±o */
            .message {
                top: 12px;
                right: 12px;
                left: 12px;
                padding: 12px 16px;
                font-size: 0.85rem;
                border-radius: 10px;
                box-shadow: 0 6px 24px rgba(0,0,0,0.2);
                animation: slideInMobile 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            }
             
             /* Motivos en m√≥vil muy peque√±o */
             .motivo-item {
                 padding: 12px;
             }
             
             .motivo-delete-btn {
                 padding: 6px 12px;
                 font-size: 0.75rem;
                 min-height: 32px;
             }
             
             /* Gesti√≥n de motivos responsive */
             .add-motivo-section {
                 margin-bottom: 20px;
                 padding: 16px;
             }
             
             .add-motivo-section h3 {
                 font-size: 0.9rem;
                 margin-bottom: 12px;
             }
             
             .add-motivo-actions {
                 flex-direction: column;
                 gap: 8px;
             }
             
             .add-motivo-actions .btn {
                 width: 100%;
                 font-size: 0.85rem;
                 padding: 12px 16px;
                 min-height: 44px;
             }
             
             .existing-motivos-section h3 {
                 font-size: 0.9rem;
                 margin-bottom: 12px;
             }
             
             #newMotivoName {
                 padding: 12px 14px;
                 font-size: 1rem;
             }
             
             /* C√°mara section en m√≥vil muy peque√±o */
             .camera-section {
                 padding: 16px;
                 margin-bottom: 20px;
                 text-align: center;
             }
             
             .camera-btn {
                 padding: 12px 24px;
                 font-size: 0.95rem;
                 min-height: 48px;
                 width: 100%;
                 margin: 0;
                 border-radius: 12px;
             }
             
             /* Mejoras adicionales para touch */
             .expense-image {
                width: 44px;
                height: 44px;
                 border-radius: 5px;
             }
             
             .expense-image-placeholder {
                 width: 44px;
                 height: 44px;
                 font-size: 20px;
                 border-radius: 5px;
            }
        }

        /* Estilos para el modal de verificaci√≥n por lotes */
        .processing-status {
            text-align: center;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .batch-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .stat-badge {
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        .batch-tickets-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .batch-ticket-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            position: relative;
        }

        .batch-ticket-item.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .batch-ticket-item.success {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .batch-ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .batch-ticket-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .batch-ticket-status.processing {
            background: #fef3c7;
            color: #d97706;
        }

        .batch-ticket-status.success {
            background: #dcfce7;
            color: #16a34a;
        }

        .batch-ticket-status.error {
            background: #fee2e2;
            color: #dc2626;
        }

        .batch-ticket-preview {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .batch-ticket-image {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .batch-ticket-data {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 13px;
        }

        .batch-ticket-field {
            display: flex;
            flex-direction: column;
        }

        .batch-ticket-field label {
            font-weight: 600;
            color: #666;
            margin-bottom: 2px;
        }

        .batch-ticket-field input {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
        }

        .batch-ticket-field input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .batch-ticket-field select {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px;
        }

        .batch-ticket-field select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .batch-ticket-field select:disabled {
            background-color: #f9fafb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .batch-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .batch-ticket-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .batch-ticket-actions button {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .batch-ticket-actions .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .batch-ticket-actions .btn-delete {
            background: #ef4444;
            color: white;
        }

        .batch-ticket-actions .btn-retry {
            background: #f59e0b;
            color: white;
        }

        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .batch-ticket-data {
                grid-template-columns: 1fr;
            }
            
            .batch-ticket-preview {
                flex-direction: column;
            }
            
            .batch-ticket-image {
                width: 100%;
                height: 120px;
            }
            
            .summary-stats {
                flex-direction: column;
                align-items: center;
            }
        }

        /* === ESTILOS MODERNOS MODAL GRUPOS DE GASTOS === */
        .modal-grupos-gastos {
            max-width: 900px;
            border-radius: 24px;
            overflow: hidden;
        }

        .modal-header-modern {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
        }

        .modal-header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .modal-icon {
            font-size: 48px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .modal-title-section h2 {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 4px 0;
            letter-spacing: -0.02em;
        }

        .modal-title-section p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin: 0;
        }

        .close-btn-modern {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            color: white;
        }

        .close-btn-modern:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .modal-body-modern {
            padding: 32px;
            background: var(--background-color);
        }

        .add-grupo-section {
            margin-bottom: 32px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            border-radius: 16px;
            border: 2px solid rgba(99, 102, 241, 0.2);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.01em;
        }

        .grupos-count {
            background: rgba(99, 102, 241, 0.1);
            color: var(--secondary-color);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .add-grupo-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .input-group-modern {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group-modern label {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .input-modern {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            font-size: 15px;
            background: var(--surface-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .input-modern:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        .form-actions-modern {
            display: flex;
            gap: 12px;
            justify-content: flex-start;
        }

        .btn-primary-modern,
        .btn-secondary-modern {
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            letter-spacing: -0.01em;
        }

        .btn-primary-modern {
            background: linear-gradient(135deg, var(--btn-primary-bg), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary-modern:hover {
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            transform: translateY(-2px) scale(1.02);
        }

        .btn-secondary-modern {
            background: rgba(99, 102, 241, 0.1);
            color: var(--secondary-color);
            border: 2px solid rgba(99, 102, 241, 0.2);
        }

        .btn-secondary-modern:hover {
            background: rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        .btn-icon {
            font-size: 16px;
        }

        .existing-grupos-section {
            margin-bottom: 24px;
        }

        .grupos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
            padding: 4px;
        }

        .modal-footer-modern {
            padding: 20px 32px;
            background: rgba(99, 102, 241, 0.05);
            border-top: 2px solid rgba(99, 102, 241, 0.1);
            display: flex;
            justify-content: center;
        }

        .btn-close-modern {
            padding: 14px 32px;
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-close-modern:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        @media (max-width: 768px) {
            .modal-grupos-gastos {
                margin: 20px;
                max-width: calc(100% - 40px);
            }
            
            .modal-header-modern {
                padding: 24px 20px;
            }
            
            .modal-header-content {
                gap: 12px;
            }
            
            .modal-icon {
                font-size: 36px;
            }
            
            .modal-title-section h2 {
                font-size: 22px;
            }
            
            .modal-body-modern {
                padding: 20px;
            }
            
            .grupos-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions-modern {
                flex-direction: column;
            }
            
            .btn-primary-modern,
            .btn-secondary-modern {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header minimalista solo con toggle -->
    <header class="app-header">
        <button class="sidebar-toggle-header" id="sidebarToggleHeader" onclick="toggleSidebar()">
            <span id="sidebarToggleIconHeader">‚ò∞</span>
        </button>
        <div class="header-title">
            <span class="header-icon">üí≥</span>
            <span class="header-text">Gestion des D√©penses</span>
        </div>
    </header>
    
    <!-- Bot√≥n toggle sidebar -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <span id="sidebarToggleIcon">‚óÄ</span>
            </button>

    <div class="cms-layout">
        <!-- Sidebar CMS -->
        <aside class="cms-sidebar" id="cmsSidebar">
            <!-- Perfil de usuario en sidebar -->
            <div class="sidebar-user-profile">
                <div class="sidebar-user-avatar">{{ current_user[0].upper() }}</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">{{ current_user }}</div>
                    <div class="sidebar-user-role">{{ 'Administrateur' if is_admin else 'Utilisateur' }}</div>
                </div>
        </div>
        
            <div class="sidebar-divider"></div>
            
            <div class="sidebar-menu">
                <div class="sidebar-section-title">Principal</div>
                
                <div class="sidebar-item active" id="sidebarGastos" onclick="showViewCMS('gastos')">
                    <span class="sidebar-item-icon">üí≥</span>
                    <span class="sidebar-item-text">Gestion des D√©penses</span>
                </div>
                
                {% if is_admin %}
                <div class="sidebar-item" id="sidebarDashboard" onclick="showViewCMS('dashboard')">
                    <span class="sidebar-item-icon">üìä</span>
                    <span class="sidebar-item-text">Tableau de Bord</span>
            </div>
                {% endif %}
                
                <div class="sidebar-divider"></div>
                
                <div class="sidebar-section-title">Gestion</div>
                
                <div class="sidebar-item" onclick="openManageMotivosModal()">
                    <span class="sidebar-item-icon">üìÅ</span>
                    <span class="sidebar-item-text">Groupes de D√©penses</span>
        </div>
        
                <div class="sidebar-divider"></div>
                
                <div class="sidebar-item sidebar-logout" onclick="window.location.href='/logout'">
                    <span class="sidebar-item-icon">üö™</span>
                    <span class="sidebar-item-text">D√©connexion</span>
                </div>
            </div>
        </aside>

        <!-- Main content -->
        <div class="main-content" id="mainContent">
            <!-- Vista GASTOS -->
            <div id="gastos-view" class="content-view active">
    <div class="container">
        <div class="header">
                        <h1>üí≥ Gestion des D√©penses</h1>
                        <p>Ajoutez et g√©rez vos d√©penses</p>
                    </div>

                    <!-- Filtros de fecha -->
                    <div class="date-filters">
                        <div class="date-filters-header">
                            <h3>üóìÔ∏è Filtrage par Dates</h3>
                            <p>S√©lectionnez la plage de dates pour filtrer vos d√©penses</p>
                        </div>
                        
                        {% if is_admin %}
                        <!-- Selector de d√≠a de corte del mes GLOBAL -->
                        <div class="cutoff-day-selector">
                            <div class="cutoff-day-label">
                                <strong>üìÖ Jour de d√©but du mois (Global)</strong>
                                <small>D√©finir le jour de d√©but de la p√©riode mensuelle pour TOUS les utilisateurs</small>
                            </div>
                            <div class="cutoff-day-input">
                                <span style="color: var(--text-secondary); font-size: 14px;">Jour:</span>
                                <input type="number" id="gastosCutoffDayInput" min="1" max="31" value="23" 
                                       title="Jour de d√©but du mois (1-31) - Affecte tous les utilisateurs">
                                <button class="btn-confirm-cutoff" onclick="confirmCutoffDayChange('gastos')">
                                    ‚úÖ Confirmer
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="date-inputs-section">
                            <div class="date-input-row date-input-inline">
                                <div class="date-input-group">
                                    <div class="date-input-label">
                                        üìÖ Date D√©but:
                                    </div>
                                    <div class="date-input-field">
                                        <input type="date" id="fechaInicio">
                                    </div>
                                </div>
                                
                                <div class="date-input-group">
                                    <div class="date-input-label">
                                        üìÖ Date Fin:
                                    </div>
                                    <div class="date-input-field">
                                        <input type="date" id="fechaFin">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtro multi-select por grupo de gastos -->
                        <div class="user-filter-section">
                            <div class="filter-group">
                                <label for="gastosViajeFilter">üìÅ Filtrer par Groupe de D√©penses:</label>
                                <div class="multiselect-container" id="gastosViajeMultiselect">
                                    <div class="multiselect-display" onclick="toggleMultiselect('gastosViajeMultiselect')">
                                        <span class="multiselect-selected placeholder">Tous les groupes</span>
                                        <span class="multiselect-arrow">‚ñº</span>
                                    </div>
                                    <div class="multiselect-dropdown">
                                        <div class="multiselect-search">
                                            <input type="text" placeholder="üîç Rechercher groupe..." onkeyup="filterMultiselectOptions('gastosViajeMultiselect', this.value)">
                                        </div>
                                        <div class="multiselect-options" id="gastosViajeOptions">
                                            <!-- Options will be populated dynamically -->
                                        </div>
                                        <div class="multiselect-actions">
                                            <button class="multiselect-btn multiselect-btn-all" onclick="selectAllMultiselect('gastosViajeMultiselect')">‚úì Tous</button>
                                            <button class="multiselect-btn multiselect-btn-clear" onclick="clearMultiselect('gastosViajeMultiselect')">‚úó Effacer</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="actions-section">
                            <button class="btn-filter btn-today" onclick="setLastMonthRange()">üìÖ Dernier Mois</button>
                            <button class="btn-filter btn-clear-dates" onclick="clearDateFilters()">üóëÔ∏è Effacer</button>
                            <button class="btn-filter btn-confirm" onclick="applyDateFilters()">‚úÖ Appliquer Filtres</button>
                        </div>
                    </div>

        <div class="stats">
            <div class="stat-card">
                            <h3>Tickets Totaux</h3>
                            <div class="value" id="totalTickets">0</div>
            </div>
            <div class="stat-card">
                            <h3>Tickets Filtr√©s</h3>
                            <div class="value" id="ticketsFiltrados">0</div>
            </div>
            <div class="stat-card">
                            <h3>Total Filtr√©</h3>
                            <div class="value" id="totalFiltrado">‚Ç¨0.00</div>
            </div>
        </div>

        <div class="expenses-container">
            <div class="table-header">
                            üé´ Liste des Tickets
            </div>
            <div class="table-content" id="expensesList">
                <!-- Los gastos se cargar√°n aqu√≠ -->
            </div>
            
            <!-- Secci√≥n de selecci√≥n m√∫ltiple integrada -->
            <div class="integrated-selection-section">
                <div class="selection-header">
                    <h4>‚òëÔ∏è S√©lection Multiple</h4>
                    <div class="selection-info">
                        <span id="selectedGastosCount">0 tickets s√©lectionn√©s</span>
                    </div>
                </div>
                <div class="bulk-actions-centered">
                    <button class="btn-secondary" onclick="toggleSelectAll('gastos')" id="selectAllGastosBtn">
                        ‚òëÔ∏è Tout S√©lectionner
                    </button>
                    <button class="btn-danger" onclick="deleteSelectedGastos()" id="deleteSelectedGastosBtn" disabled>
                        üóëÔ∏è Supprimer S√©lectionn√©s
                    </button>
                </div>
            </div>
        </div>

                    <!-- Secci√≥n de acciones principales -->
                    <div class="action-section">
                        <h3>üéØ Actions Principales</h3>
                        <div class="main-actions">
                            <button class="btn-primary" onclick="openModal()" title="Ajouter Nouveau Ticket">
                                ‚ûï Ajouter Nouveau Ticket
                            </button>
                                                <button class="btn-secondary" onclick="openManageMotivosModal()" title="G√©rer Groupes de D√©penses">
                        ‚öôÔ∏è G√©rer Groupes de D√©penses
            </button>
                        </div>
                    </div>

                    <!-- Resumen de Grupos con Detalles -->
                    <div class="action-section" id="resumenViajesSection" style="display: none;">
                        <h3>üéØ R√©sum√© des Groupes de D√©penses avec D√©tails en Attente</h3>
                        <div id="resumenViajesList" class="resumen-viajes-container">
                            <!-- El resumen se cargar√° aqu√≠ -->
                        </div>
                    </div>

                    <!-- Secci√≥n de exportaci√≥n -->
                    <div class="action-section">
                        <h3 id="exportTitle">üìä Exportar Gastos de {{ current_user }} para fechas [todas]</h3>
                        <div class="export-section-centered">
                            <button class="btn-tertiary" onclick="exportToPDF()">
                                üìÑ Exportar PDF
            </button>
                            <button class="btn-tertiary" onclick="exportToExcel()">
                                üìä Exportar Excel
                            </button>
                            <button class="btn-tertiary" onclick="exportImages()">
                                üñºÔ∏è Exportar Im√°genes
                            </button>
                            <button class="btn-success" onclick="exportAll()">
                                üì¶ Exportar Todo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista DASHBOARD -->
            <div id="dashboard-view" class="content-view">
                <div class="container">
                    <div class="header">
                        <h1>üìä Tableau de Bord</h1>
                        <p>Visualisez et confirmez vos d√©penses</p>
                    </div>

                    <!-- Filtros de fecha para dashboard -->
                    <div class="date-filters">
                        <div class="date-filters-header">
                            <h3>üóìÔ∏è Filtrage par Dates</h3>
                            <p>S√©lectionnez la plage de dates pour le tableau de bord</p>
                        </div>
                        
                        {% if is_admin %}
                        <!-- Selector de d√≠a de corte del mes GLOBAL -->
                        <div class="cutoff-day-selector">
                            <div class="cutoff-day-label">
                                <strong>üìÖ Jour de d√©but du mois (Global)</strong>
                                <small>D√©finir le jour de d√©but de la p√©riode mensuelle pour TOUS les utilisateurs</small>
                            </div>
                            <div class="cutoff-day-input">
                                <span style="color: var(--text-secondary); font-size: 14px;">Jour:</span>
                                <input type="number" id="cutoffDayInput" min="1" max="31" value="23" 
                                       title="Jour de d√©but du mois (1-31) - Affecte tous les utilisateurs">
                                <button class="btn-confirm-cutoff" onclick="confirmCutoffDayChange('dashboard')">
                                    ‚úÖ Confirmer
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="date-inputs-section">
                            <div class="date-input-row date-input-inline">
                                <div class="date-input-group">
                                    <div class="date-input-label">
                                        üìÖ Date D√©but:
                                    </div>
                                    <div class="date-input-field">
                                        <input type="date" id="dashboardFechaInicio">
                                    </div>
                                </div>
                                
                                <div class="date-input-group">
                                    <div class="date-input-label">
                                        üìÖ Date Fin:
                                    </div>
                                    <div class="date-input-field">
                                        <input type="date" id="dashboardFechaFin">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if is_admin %}
                        <div class="user-filter-section">
                            <div class="filter-group">
                                <label for="dashboardUserFilter">üë§ Filtrer par Utilisateur:</label>
                                <div class="multiselect-container" id="dashboardUserMultiselect">
                                    <div class="multiselect-display" onclick="toggleMultiselect('dashboardUserMultiselect')">
                                        <span class="multiselect-selected placeholder">Tous les utilisateurs</span>
                                        <span class="multiselect-arrow">‚ñº</span>
                                    </div>
                                    <div class="multiselect-dropdown">
                                        <div class="multiselect-search">
                                            <input type="text" placeholder="üîç Rechercher utilisateur..." onkeyup="filterMultiselectOptions('dashboardUserMultiselect', this.value)">
                                        </div>
                                        <div class="multiselect-options" id="dashboardUserOptions">
                                            <!-- Options will be populated dynamically -->
                                        </div>
                                        <div class="multiselect-actions">
                                            <button class="multiselect-btn multiselect-btn-all" onclick="selectAllMultiselect('dashboardUserMultiselect')">‚úì Tous</button>
                                            <button class="multiselect-btn multiselect-btn-clear" onclick="clearMultiselect('dashboardUserMultiselect')">‚úó Effacer</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Filtro multi-select por grupo de gastos -->
                        <div class="user-filter-section">
                            <div class="filter-group">
                                <label for="dashboardViajeFilter">üìÅ Filtrar por Groupe de D√©penses:</label>
                                <div class="multiselect-container" id="dashboardViajeMultiselect">
                                    <div class="multiselect-display" onclick="toggleMultiselect('dashboardViajeMultiselect')">
                                        <span class="multiselect-selected placeholder">Todos los grupos</span>
                                        <span class="multiselect-arrow">‚ñº</span>
                                    </div>
                                    <div class="multiselect-dropdown">
                                        <div class="multiselect-search">
                                            <input type="text" placeholder="üîç Buscar grupo..." onkeyup="filterMultiselectOptions('dashboardViajeMultiselect', this.value)">
                                        </div>
                                        <div class="multiselect-options" id="dashboardViajeOptions">
                                            <!-- Options will be populated dynamically -->
                                        </div>
                                        <div class="multiselect-actions">
                                            <button class="multiselect-btn multiselect-btn-all" onclick="selectAllMultiselect('dashboardViajeMultiselect')">‚úì Tous</button>
                                            <button class="multiselect-btn multiselect-btn-clear" onclick="clearMultiselect('dashboardViajeMultiselect')">‚úó Effacer</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="actions-section">
                            <button class="btn-filter btn-today" onclick="setDashboardLastMonthRange()">üìÖ Dernier Mois</button>
                            <button class="btn-filter btn-clear-dates" onclick="clearDashboardDateFilters()">üóëÔ∏è Effacer</button>
                            <button class="btn-filter btn-confirm" onclick="applyDashboardDateFilters()">‚úÖ Appliquer Filtres</button>
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <h3>Tickets Totaux</h3>
                            <div class="value" id="dashboardTotalTickets">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Tickets Filtr√©s</h3>
                            <div class="value" id="dashboardTicketsFiltrados">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Filtr√©</h3>
                            <div class="value" id="dashboardTotalFiltrado">‚Ç¨0.00</div>
                        </div>
                    </div>

                    <div class="expenses-container">
                        <div class="table-header">
                            üìã Dashboard de Gastos
                        </div>
                        <div class="table-content" id="dashboardExpensesList">
                            <!-- Los gastos del dashboard se cargar√°n aqu√≠ -->
                        </div>
                        
                        <!-- Secci√≥n de selecci√≥n m√∫ltiple integrada -->
                        <div class="integrated-selection-section">
                            <div class="selection-header">
                                <h4>‚òëÔ∏è Actions Multiples</h4>
                                <div class="selection-info">
                                    <span id="selectedDashboardCount">0 tickets s√©lectionn√©s</span>
                                </div>
                            </div>
                            <div class="bulk-actions-centered">
                                <button class="btn-secondary" onclick="toggleSelectAll('dashboard')" id="selectAllDashboardBtn">
                                    ‚òëÔ∏è Tout S√©lectionner
                                </button>
                                <button class="btn-success" onclick="confirmSelectedTickets()" id="confirmSelectedBtn" disabled>
                                    ‚úÖ Confirmar Seleccionados
                                </button>
                                <button class="btn-warning" onclick="unconfirmSelectedTickets()" id="unconfirmSelectedBtn" disabled>
                                    ‚è≥ Desmarcar Seleccionados
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n de exportaci√≥n dashboard -->
                    <div class="action-section">
                        <h3>üìä Exportar Datos</h3>
                        <div class="export-section-centered">
                            <button class="btn-success" onclick="exportDashboardAll()">
                                üì¶ Exportar Todo
                            </button>
                            <button class="btn-tertiary" onclick="exportDashboardToPDF()">
                                üìÑ Exportar PDF
                            </button>
                            <button class="btn-tertiary" onclick="exportDashboardToExcel()">
                                üìä Exportar Excel
                            </button>
                            <button class="btn-tertiary" onclick="exportDashboardImages()">
                                üñºÔ∏è Exportar Im√°genes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2 id="modalTitle">üé´ Nuevo Ticket</h2>
            </div>
            
            <!-- Informaci√≥n del usuario original (solo visible al editar) -->
            <div id="originalUserInfo" class="original-user-info" style="display: none;">
                <div class="user-info-content">
                    <span class="user-info-label">üìã Ticket creado por:</span>
                    <span id="originalUserName" class="user-info-name"></span>
                </div>
            </div>
            
            <div class="modal-body">
                <form id="expenseForm">
                    <div class="camera-section">
                        <input type="file" id="ticketInput" accept="image/*" multiple style="display: none;" onchange="handleTicketFileSelect(event)">
                        <button type="button" class="camera-btn" onclick="openTicketInput()">üì∑ Cargar Ticket</button>
                        <div id="previewContainer" class="preview-container" style="display: none;">
                            <img id="previewImage" class="preview-image" alt="Vista previa" onclick="showImageModal(this.src)" style="cursor: pointer;" title="Click para ver imagen completa">
                            <br>
                            <button type="button" class="btn btn-danger" onclick="deleteImage()" style="margin-top: 10px;">üóëÔ∏è Eliminar Imagen</button>
                        </div>
                        
                        <!-- Opci√≥n para an√°lisis IA -->
                        <div class="ai-analysis-option" style="margin-top: 16px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.2);">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; color: var(--text-primary);">
                                <input type="checkbox" id="enableAiAnalysis" checked style="width: 18px; height: 18px; accent-color: var(--secondary-color);">
                                <span>ü§ñ Analizar imagen con IA autom√°ticamente</span>
                            </label>
                            <small style="display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8rem;">
                                Si est√° activado, la IA extraer√° autom√°ticamente fecha, importe, descripci√≥n y concepto de la imagen
                            </small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha">üìÖ Date</label>
                            <input type="date" id="fecha" required>
                        </div>
                        <div class="form-group">
                            <label for="concepto">üè∑Ô∏è Concept</label>
                            <select id="concepto" required>
                                <option value="">Selecciona un concepto</option>
                            </select>
                        </div>
                    </div>
                    
                    {% if is_admin %}
                    <div class="form-row">
                        <div class="form-group">
                            <label for="usuario">üë§ Utilisateur</label>
                            <select id="usuario" required>
                                <option value="">Selecciona un usuario</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}

                    <div class="form-group">
                        <label for="descripcion">üìù Descripci√≥n</label>
                        <input type="text" id="descripcion" placeholder="Describe el ticket...">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="motivo">üìÅ Groupe de D√©penses</label>
                            <select id="motivo">
                                <option value="">Selecciona un grupo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="importeEur">üí∞ Montant (EUR)</label>
                            <input type="number" id="importeEur" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="monedaOtra">üåç Otra Moneda</label>
                            <select id="monedaOtra" onchange="handleCurrencyChange()">
                                <option value="">Selecciona moneda</option>
                                <option value="USD">USD - D√≥lar Americano</option>
                                <option value="GBP">GBP - Libra Esterlina</option>
                                <option value="JPY">JPY - Yen Japon√©s</option>
                                <option value="CHF">CHF - Franco Suizo</option>
                                <option value="CAD">CAD - D√≥lar Canadiense</option>
                                <option value="AUD">AUD - D√≥lar Australiano</option>
                                <option value="NZD">NZD - D√≥lar Neozeland√©s</option>
                                <option value="HKD">HKD - D√≥lar de Hong Kong</option>
                                <option value="SGD">SGD - D√≥lar de Singapur</option>
                                <option value="CNY">CNY - Yuan Chino</option>
                                <option value="MYR">MYR - Ringgit de Malasia</option>
                                <option value="AED">AED - Dirham de Emiratos √Årabes Unidos</option>
                                <option value="BRL">BRL - Real Brasile√±o</option>
                                <option value="ARS">ARS - Peso Argentino</option>
                                <option value="MXN">MXN - Peso Mexicano</option>
                                <option value="COP">COP - Peso Colombiano</option>
                                <option value="CLP">CLP - Peso Chileno</option>
                                <option value="PEN">PEN - Sol Peruano</option>
                                <option value="UYU">UYU - Peso Uruguayo</option>
                                <option value="SEK">SEK - Corona Sueca</option>
                                <option value="NOK">NOK - Corona Noruega</option>
                                <option value="DKK">DKK - Corona Danesa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="importeOtraMoneda">üí± Montant dans Autre Devise</label>
                            <input type="number" id="importeOtraMoneda" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>

                                                            <div style="text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 16px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-success ripple" onclick="saveGastoAndExit()" id="saveExitButton">üíæ Guardar y Salir</button>
                        <button type="button" class="btn btn-primary ripple" onclick="saveGastoAndAdd()" id="saveAddButton">‚ûï Guardar y A√±adir</button>
                        <button type="button" class="btn ripple" onclick="closeModal()">‚ùå Anular</button>
                    </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti√≥n de Grupos de Gastos - Redise√±ado -->
    <div id="manageMotivosModal" class="modal">
        <div class="modal-content modal-grupos-gastos">
            <div class="modal-header-modern">
                <div class="modal-header-content">
                    <div class="modal-icon">üìÅ</div>
                    <div class="modal-title-section">
                        <h2>Gesti√≥n de Grupos de Gastos</h2>
                        <p>Organiza tus gastos en grupos personalizados</p>
            </div>
                        </div>
                <button class="close-btn-modern" onclick="closeManageMotivosModal()">
                    <span>‚úï</span>
                            </button>
            </div>
            <div class="modal-body-modern">
                <!-- Secci√≥n para a√±adir nuevo grupo -->
                <div class="add-grupo-section">
                    <div class="section-header">
                        <h3>‚ûï Crear Nuevo Grupo</h3>
                    </div>
                    <div class="add-grupo-form">
                        <div class="input-group-modern">
                            <label for="newMotivoName">üìù Nombre del Grupo</label>
                            <input type="text" id="newMotivoName" placeholder="Ej: Viaje Madrid 2025, Proyecto Alpha..." maxlength="100" class="input-modern">
                        </div>
                        <div class="form-actions-modern">
                            <button type="button" class="btn-primary-modern" onclick="addMotivoFromModal()">
                                <span class="btn-icon">‚ûï</span>
                                <span>Crear Grupo</span>
                            </button>
                            <button type="button" class="btn-secondary-modern" onclick="clearNewMotivoInput()">
                                <span class="btn-icon">‚Ü∫</span>
                                <span>Limpiar</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de grupos existentes -->
                <div class="existing-grupos-section">
                    <div class="section-header">
                        <h3>üìã Grupos Existentes</h3>
                        <span class="grupos-count" id="gruposCount">0 grupos</span>
                    </div>
                    <div class="grupos-grid" id="motivosList">
                        <!-- Los grupos se cargar√°n aqu√≠ -->
                    </div>
                </div>
                
                <div class="modal-footer-modern">
                    <button type="button" class="btn-close-modern" onclick="closeManageMotivosModal()">
                        <span>‚úì</span>
                        <span>Fermer</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles de Groupe de D√©penses -->
    <div id="viajeDetalleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeViajeDetalleModal()">&times;</span>
                <h2 id="viajeDetalleModalTitle">üìã Detalles del Groupe de D√©penses</h2>
            </div>
            <div class="modal-body">
                <!-- Secci√≥n para a√±adir nuevo gasto esperado -->
                <div class="add-detalle-section">
                    <h3>‚ûï Ajouter D√©pense Pr√©vue</h3>
                    <div class="add-detalle-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nuevoDetalleImporte">üí∞ Montant:</label>
                                <input type="number" id="nuevoDetalleImporte" step="0.01" min="0.01" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label for="nuevoDetalleMoneda">üåç Devise:</label>
                                <select id="nuevoDetalleMoneda">
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="USD">USD - D√≥lar Americano</option>
                                    <option value="GBP">GBP - Libra Esterlina</option>
                                    <option value="JPY">JPY - Yen Japon√©s</option>
                                    <option value="CHF">CHF - Franco Suizo</option>
                                    <option value="CAD">CAD - D√≥lar Canadiense</option>
                                    <option value="AUD">AUD - D√≥lar Australiano</option>
                                    <option value="CNY">CNY - Yuan Chino</option>
                                    <option value="BRL">BRL - Real Brasile√±o</option>
                                    <option value="ARS">ARS - Peso Argentino</option>
                                    <option value="MXN">MXN - Peso Mexicano</option>
                                    <option value="COP">COP - Peso Colombiano</option>
                                    <option value="CLP">CLP - Peso Chileno</option>
                                    <option value="PEN">PEN - Sol Peruano</option>
                                    <option value="UYU">UYU - Peso Uruguayo</option>
                                </select>
                            </div>
                        </div>
                        <div class="add-detalle-actions">
                            <button type="button" class="btn btn-primary" onclick="addDetalleFromModal()">
                                ‚ûï Ajouter D√©pense
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearNewDetalleInput()">
                                üóëÔ∏è Effacer
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de gastos esperados existentes -->
                <div class="existing-detalles-section">
                    <h3>üí∞ Gastos Esperados</h3>
                    <div class="detalles-list" id="detallesList">
                        <!-- Los detalles se cargar√°n aqu√≠ -->
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn ripple" onclick="closeViajeDetalleModal()">‚úÖ Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Verificaci√≥n por Lotes -->
    <div id="batchVerificationModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90%; overflow-y: auto;">
            <div class="modal-header">
                <span class="close" onclick="closeBatchVerificationModal()">&times;</span>
                <h2>üìã Verificaci√≥n de M√∫ltiples Tickets</h2>
            </div>
            <div class="modal-body">
                <div id="batchProcessingStatus" class="processing-status" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="batchProgressFill"></div>
                    </div>
                    <div class="progress-text" id="batchProgressText">Traitement des tickets...</div>
                </div>
                
                <div id="batchVerificationContainer" style="display: none;">
                    <div class="batch-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3>üéØ R√©sum√© du Lot</h3>
                        <div class="summary-stats">
                            <span class="stat-badge">üìä Total: <span id="batchTotalCount">0</span></span>
                            <span class="stat-badge">‚úÖ Trait√©s: <span id="batchProcessedCount">0</span></span>
                            <span class="stat-badge">‚ùå Erreurs: <span id="batchErrorCount">0</span></span>
                        </div>
                    </div>
                    
                    <div id="batchTicketsList" class="batch-tickets-list"></div>
                    
                    <div class="batch-actions" style="margin-top: 20px; padding: 15px; border-top: 1px solid #dee2e6;">
                        <button type="button" class="btn btn-success" onclick="saveAllBatchTickets()" id="saveAllBatchBtn">
                            <i class="fas fa-save"></i> Guardar Todos los Tickets
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeBatchVerificationModal()" style="margin-left: 10px;">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIGURACI√ìN ADMIN ============
        // D√≠a de inicio de mes por defecto (adaptable por administradores)
        let ADMIN_CUTOFF_DAY = 23; // Valor por defecto
        
        // Cargar el d√≠a de corte guardado al iniciar
        function loadCutoffDay() {
            const savedDay = localStorage.getItem('adminCutoffDay');
            if (savedDay) {
                ADMIN_CUTOFF_DAY = parseInt(savedDay);
                console.log(`üìÖ D√≠a de corte cargado desde storage: ${ADMIN_CUTOFF_DAY}`);
                
                // Actualizar ambos inputs si existen
                const dashboardInput = document.getElementById('cutoffDayInput');
                const gastosInput = document.getElementById('gastosCutoffDayInput');
                
                if (dashboardInput) {
                    dashboardInput.value = ADMIN_CUTOFF_DAY;
                }
                if (gastosInput) {
                    gastosInput.value = ADMIN_CUTOFF_DAY;
                }
            }
        }
        
        // Funci√≥n para confirmar el cambio de d√≠a de corte
        // Este d√≠a de corte aplica globalmente a:
        // - Dashboard del admin
        // - TODOS los Gastos de TODOS los usuarios
        function confirmCutoffDayChange(section) {
            let newDay;
            
            // Obtener el valor del input correspondiente
            if (section === 'gastos') {
                newDay = parseInt(document.getElementById('gastosCutoffDayInput').value);
            } else if (section === 'dashboard') {
                newDay = parseInt(document.getElementById('cutoffDayInput').value);
            }
            
            // Validar el d√≠a
            if (newDay >= 1 && newDay <= 31) {
                ADMIN_CUTOFF_DAY = newDay;
                
                // GUARDAR en localStorage para que persista
                localStorage.setItem('adminCutoffDay', newDay);
                
                // Sincronizar ambos inputs
                const gastosInput = document.getElementById('gastosCutoffDayInput');
                const dashboardInput = document.getElementById('cutoffDayInput');
                if (gastosInput) gastosInput.value = newDay;
                if (dashboardInput) dashboardInput.value = newDay;
                
                console.log(`üìÖ D√≠a de corte global actualizado y guardado: ${ADMIN_CUTOFF_DAY}`);
                showMessage('‚úÖ Jour de d√©but du mois mis √† jour: ' + newDay + ' (application des changements...)', 'success');
                
                // Recargar la vista actual con los nuevos filtros
                if (section === 'gastos') {
                    // Actualizar el bot√≥n "√öltimo Mes" con el nuevo d√≠a de corte
                    setLastMonthRange();
                } else if (section === 'dashboard') {
                    // Actualizar el bot√≥n "√öltimo Mes" en dashboard
                    setDashboardLastMonthRange();
                }
            } else {
                alert('‚ùå Le jour doit √™tre entre 1 et 31');
                // Restaurar el valor anterior
                if (section === 'gastos') {
                    document.getElementById('gastosCutoffDayInput').value = ADMIN_CUTOFF_DAY;
                } else {
                document.getElementById('cutoffDayInput').value = ADMIN_CUTOFF_DAY;
                }
            }
        }
        
        // Funci√≥n legacy para compatibilidad (ya no se usa directamente)
        function updateCutoffDay(newDay) {
            confirmCutoffDayChange('dashboard');
        }
        
        // ============ MULTISELECT SYSTEM ============
        // Estado de multiselects
        const multiselectState = {};
        
        function initMultiselect(id, options) {
            multiselectState[id] = {
                options: options,
                selected: new Set(),
                allOptions: options
            };
        }
        
        function toggleMultiselect(id) {
            const container = document.getElementById(id);
            const display = container.querySelector('.multiselect-display');
            const dropdown = container.querySelector('.multiselect-dropdown');
            const isActive = dropdown.classList.contains('active');
            
            // Fermer todos los dem√°s
            document.querySelectorAll('.multiselect-dropdown.active').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.remove('active');
                    dd.previousElementSibling.classList.remove('active');
                }
            });
            
            // Toggle este
            if (isActive) {
                dropdown.classList.remove('active');
                display.classList.remove('active');
            } else {
                dropdown.classList.add('active');
                display.classList.add('active');
            }
        }
        
        function updateMultiselectDisplay(id) {
            const container = document.getElementById(id);
            const display = container.querySelector('.multiselect-selected');
            const state = multiselectState[id];
            
            if (!state || state.selected.size === 0) {
                display.className = 'multiselect-selected placeholder';
                if (id.includes('User')) {
                    display.textContent = 'Tous les utilisateurs';
                } else if (id.includes('Viaje')) {
                    display.textContent = 'Todos los grupos';
                }
            } else if (state.selected.size === state.options.length) {
                display.className = 'multiselect-selected';
                display.textContent = 'Todos s√©lectionn√©s';
            } else {
                display.className = 'multiselect-selected';
                const selectedArray = Array.from(state.selected);
                if (selectedArray.length <= 3) {
                    display.textContent = selectedArray.join(', ');
                } else {
                    display.textContent = `${selectedArray.slice(0, 2).join(', ')} +${selectedArray.length - 2} m√°s`;
                }
            }
        }
        
        function toggleOption(id, value) {
            const state = multiselectState[id];
            if (state.selected.has(value)) {
                state.selected.delete(value);
            } else {
                state.selected.add(value);
            }
            
            // Actualizar UI
            const option = document.querySelector(`#${id} .multiselect-option[data-value="${value}"]`);
            if (option) {
                option.classList.toggle('selected', state.selected.has(value));
            }
            
            updateMultiselectDisplay(id);
            
            // Auto-aplicar filtros
            if (id === 'gastosViajeMultiselect') {
                applyDateFilters();
            } else if (id === 'dashboardUserMultiselect' || id === 'dashboardViajeMultiselect') {
                applyDashboardDateFilters();
            }
        }
        
        function selectAllMultiselect(id) {
            const state = multiselectState[id];
            state.selected = new Set(state.options);
            
            // Actualizar UI
            document.querySelectorAll(`#${id} .multiselect-option`).forEach(opt => {
                opt.classList.add('selected');
            });
            
            updateMultiselectDisplay(id);
            
            // Auto-aplicar filtros
            if (id === 'gastosViajeMultiselect') {
                applyDateFilters();
            } else if (id === 'dashboardUserMultiselect' || id === 'dashboardViajeMultiselect') {
                applyDashboardDateFilters();
            }
        }
        
        function clearMultiselect(id) {
            const state = multiselectState[id];
            state.selected.clear();
            
            // Actualizar UI
            document.querySelectorAll(`#${id} .multiselect-option`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            updateMultiselectDisplay(id);
            
            // Auto-aplicar filtros
            if (id === 'gastosViajeMultiselect') {
                applyDateFilters();
            } else if (id === 'dashboardUserMultiselect' || id === 'dashboardViajeMultiselect') {
                applyDashboardDateFilters();
            }
        }
        
        function filterMultiselectOptions(id, searchText) {
            const search = searchText.toLowerCase();
            const options = document.querySelectorAll(`#${id} .multiselect-option`);
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(search) ? 'flex' : 'none';
            });
        }
        
        function populateMultiselect(id, containerId, items) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            initMultiselect(id, items);
            
            container.innerHTML = items.map(item => `
                <div class="multiselect-option" data-value="${item}" onclick="toggleOption('${id}', '${item}')">
                    <div class="multiselect-checkbox"></div>
                    <div class="multiselect-label">${item}</div>
                </div>
            `).join('');
        }
        
        function getMultiselectSelected(id) {
            const state = multiselectState[id];
            return state && state.selected.size > 0 ? Array.from(state.selected) : [];
        }
        
        // Fermer multiselects al hacer click fuera
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multiselect-container')) {
                document.querySelectorAll('.multiselect-dropdown.active').forEach(dd => {
                    dd.classList.remove('active');
                    dd.previousElementSibling.classList.remove('active');
                });
            }
        });
        
        let gastos = [];
        let conceptos = [];
        let motivos = [];
        let viajesConDetalles = new Set(); // Set para almacenar viajes que tienen detalles
        let currentExpenseId = null;
        let capturedImage = null;
        let processedImageFilename = null;
        let existingImageFilename = null;
        let lastUsedMotivo = '';  // Variable para recordar el √∫ltimo motivo usado
        let lastUsedConcepto = '';  // Variable para recordar el √∫ltimo concepto usado
        let currentView = 'gastos';  // Vista actual
        
        // Arrays para selecci√≥n m√∫ltiple de filtros
        let selectedUsers = [];
        let selectedViajes = [];

        // Funci√≥n para cambiar entre vistas
        // ============ NAVEGACI√ìN MODERNA ============
        // === FUNCIONES CMS SIDEBAR ===
        function toggleSidebar() {
            const sidebar = document.getElementById('cmsSidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleBtn = document.getElementById('sidebarToggle');
            const toggleIcon = document.getElementById('sidebarToggleIcon');
            const toggleHeaderIcon = document.getElementById('sidebarToggleIconHeader');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            if (toggleBtn) toggleBtn.classList.toggle('collapsed');
            
            // Cambiar iconos
            if (sidebar.classList.contains('collapsed')) {
                if (toggleIcon) toggleIcon.textContent = '‚ñ∂';
                if (toggleHeaderIcon) toggleHeaderIcon.textContent = '‚úï';
            } else {
                if (toggleIcon) toggleIcon.textContent = '‚óÄ';
                if (toggleHeaderIcon) toggleHeaderIcon.textContent = '‚ò∞';
            }
        }

        function showViewCMS(viewName) {
            // Actualizar vista actual
            currentView = viewName;
            
            // Ocultar todas las vistas
            document.querySelectorAll('.content-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Mostrar vista seleccionada
            document.getElementById(viewName + '-view').classList.add('active');
            
            // Actualizar items del sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            // Activar el item correcto
            const sidebarItem = document.getElementById('sidebar' + viewName.charAt(0).toUpperCase() + viewName.slice(1));
            if (sidebarItem) {
                sidebarItem.classList.add('active');
            }
            
            // Cargar datos seg√∫n la vista
            if (viewName === 'gastos') {
                loadGastos();
            } else if (viewName === 'dashboard') {
                loadDashboard();
            }
        }

        function openConfigModal() {
            showMessage('üöß Panel de configuraci√≥n en desarrollo', 'info');
        }

        function showViewModern(viewName) {
            // Redirigir a la funci√≥n CMS
            showViewCMS(viewName);
        }

        // Legacy function - mantener compatibilidad
        function showViewModernOld(viewName) {
            // Actualizar vista actual
            currentView = viewName;
            
            // Ocultar todas las vistas
            document.querySelectorAll('.content-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Mostrar vista seleccionada
            document.getElementById(viewName + '-view').classList.add('active');
            
            // Actualizar botones de navegaci√≥n
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const targetBtn = document.getElementById(viewName + 'NavBtn');
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // Fermer men√∫ m√≥vil si est√° abierto
            const navbarMenu = document.getElementById('navbarMenu');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            if (navbarMenu && navbarMenu.classList.contains('active')) {
                navbarMenu.classList.remove('active');
                hamburgerBtn.classList.remove('active');
            }
            
            // Cargar datos seg√∫n la vista
            if (viewName === 'gastos') {
                loadGastos();
            } else if (viewName === 'dashboard') {
                loadDashboard();
            }
        }
        
        function toggleMobileMenu() {
            const navbarMenu = document.getElementById('navbarMenu');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            
            navbarMenu.classList.toggle('active');
            hamburgerBtn.classList.toggle('active');
        }
        
        // Mantener compatibilidad con c√≥digo antiguo
        function showView(viewName) {
            showViewModern(viewName);
        }

        // Funci√≥n para cargar datos del dashboard
        async function loadDashboard() {
            try {
                let url = '/api/gastos';
                
                // Verificar si hay filtro de usuario aplicado (solo para admin)
                const userFilter = document.getElementById('dashboardUserFilter');
                if (userFilter && userFilter.value) {
                    url += `?user=${userFilter.value}`;
                }
                
                const response = await fetch(url);
                gastos = await response.json();
                
                // Verificar si hay filtros de fecha aplicados - PRESERVAR filtros existentes
                const fechaInicio = document.getElementById('dashboardFechaInicio').value;
                const fechaFin = document.getElementById('dashboardFechaFin').value;
                
                if (fechaInicio && fechaFin) {
                    // Si ya hay fechas aplicadas, mantenerlas y aplicar filtros
                    applyDashboardDateFilters();
                } else {
                    // Solo establecer fechas por defecto si NO hay fechas ya establecidas
                    setDashboardDefaultDateRange('init');
                    renderDashboardExpenses(gastos);
                }
                
                updateDashboardStats();
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        // Funciones espec√≠ficas para el dashboard
        function setDashboardLastMonthRange() {
            const today = new Date();
            const currentDay = today.getDate();
            
            let startDate;
            
            // Usar el d√≠a de corte configurado por el administrador
            if (currentDay >= ADMIN_CUTOFF_DAY) {
                startDate = new Date(today.getFullYear(), today.getMonth(), ADMIN_CUTOFF_DAY);
            } else {
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, ADMIN_CUTOFF_DAY);
            }
            
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('dashboardFechaInicio').value = formatDate(startDate);
            document.getElementById('dashboardFechaFin').value = formatDate(today);
            
            applyDashboardDateFilters();
        }

        function setDashboardDefaultDateRange() {
            const today = new Date();
            const currentDay = today.getDate();
            
            let startDate;
            
            // Usar el d√≠a de corte configurado por el administrador
            if (currentDay >= ADMIN_CUTOFF_DAY) {
                startDate = new Date(today.getFullYear(), today.getMonth(), ADMIN_CUTOFF_DAY);
            } else {
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, ADMIN_CUTOFF_DAY);
            }
            
            const endDate = today;
            
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('dashboardFechaInicio').value = formatDate(startDate);
            document.getElementById('dashboardFechaFin').value = formatDate(endDate);
            
            if (arguments[0] === 'init') {
                updateDashboardStats();
            }
        }

        function clearDashboardDateFilters() {
            document.getElementById('dashboardFechaInicio').value = '';
            document.getElementById('dashboardFechaFin').value = '';
            const dashboardViajeFilter = document.getElementById('dashboardViajeFilter');
            if (dashboardViajeFilter) {
                dashboardViajeFilter.value = '';
            }
            renderDashboardExpenses(gastos);
            updateDashboardStats();
            showMessage('üóëÔ∏è Tous les filtres supprim√©s', 'info');
        }

        function applyDashboardDateFilters() {
            updateDashboardStats();
            renderDashboardFilteredExpenses();
            showMessage('‚úÖ Filtros aplicados correctamente', 'success');
        }

        function renderDashboardFilteredExpenses() {
            const fechaInicio = document.getElementById('dashboardFechaInicio').value;
            const fechaFin = document.getElementById('dashboardFechaFin').value;
            const selectedUsers = getMultiselectSelected('dashboardUserMultiselect');
            const selectedViajes = getMultiselectSelected('dashboardViajeMultiselect');
            
            let gastosFiltrados = gastos;
            
            // Aplicar filtros
            gastosFiltrados = gastos.filter(gasto => {
                // Filtro por fecha
                let cumpleFecha = true;
                if (fechaInicio || fechaFin) {
                    const fechaGasto = new Date(gasto.fecha);
                    
                    if (fechaInicio && fechaFin) {
                        const inicio = new Date(fechaInicio);
                        const fin = new Date(fechaFin);
                        cumpleFecha = fechaGasto >= inicio && fechaGasto <= fin;
                    } else if (fechaInicio) {
                        const inicio = new Date(fechaInicio);
                        cumpleFecha = fechaGasto >= inicio;
                    } else if (fechaFin) {
                        const fin = new Date(fechaFin);
                        cumpleFecha = fechaGasto <= fin;
                    }
                }
                
                // Filtro por usuario (multiselect)
                let cumpleUsuario = true;
                if (selectedUsers.length > 0) {
                    cumpleUsuario = selectedUsers.includes(gasto.usuario);
                }
                
                // Filtro por viaje (multiselect)
                let cumpleViaje = true;
                if (selectedViajes.length > 0) {
                    cumpleViaje = selectedViajes.includes(gasto.motivo);
                }
                
                return cumpleFecha && cumpleUsuario && cumpleViaje;
            });
            
            renderDashboardExpenses(gastosFiltrados);
        }

        function renderDashboardExpenses(gastosList) {
            const container = document.getElementById('dashboardExpensesList');
            
            if (gastosList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üéØ Aucun ticket dans cette p√©riode</h3>
                        <p>Aucun ticket ne correspond aux dates s√©lectionn√©es</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = gastosList.map(gasto => `
                <div class="expense-item">
                    <div>
                        ${gasto.imagen_path ? 
                            `<img src="/uploads/${gasto.imagen_path}" alt="Imagen" class="expense-image" onclick="showImageModal('/uploads/${gasto.imagen_path}')">` : 
                            '<div class="expense-image-placeholder">üì∑</div>'
                        }
                    </div>
                    <div class="expense-checkbox-container">
                        <input type="checkbox" class="dashboard-checkbox" data-id="${gasto.id}" onchange="updateDashboardSelection()">
                    </div>
                    <div class="expense-info">
                        <h4>${gasto.concepto}</h4>
                        <p><strong>üìÖ</strong> ${formatDate(gasto.fecha)}</p>
                        <p><strong>üöó</strong> ${gasto.motivo || 'Sin viaje'}</p>
                        <p><strong>üìù</strong> ${gasto.descripcion || 'Sin descripci√≥n'}</p>
                    </div>
                    <div class="expense-amount">
                        <div class="expense-amount-value">
                            ${formatCurrency(gasto.importe_eur)}
                        </div>
                        ${gasto.importe_otra_moneda && gasto.moneda_otra ? 
                            `<small style="color: #7f8c8d; font-size: 0.85em; font-weight: 400;">
                                ${formatCurrencyWithCode(gasto.importe_otra_moneda, gasto.moneda_otra)}
                            </small>` : ''
                        }
                    </div>
                    <div class="expense-actions">
                        <label class="checkbox-container">
                            <input type="checkbox" ${gasto.checkeado ? 'checked' : ''} onchange="toggleCheckedStatus(${gasto.id}, this.checked)">
                            <span class="checkbox-label">${gasto.checkeado ? '‚úÖ Confirmado' : '‚è≥ Pendiente'}</span>
                        </label>
                    </div>
                </div>
            `).join('');
        }

        function updateDashboardStats() {
            const fechaInicio = document.getElementById('dashboardFechaInicio').value;
            const fechaFin = document.getElementById('dashboardFechaFin').value;
            const selectedUsers = getMultiselectSelected('dashboardUserMultiselect');
            const selectedViajes = getMultiselectSelected('dashboardViajeMultiselect');
            
            let gastosFiltrados = gastos;
            
            // Aplicar filtros
            gastosFiltrados = gastos.filter(gasto => {
                // Filtro por fecha
                let cumpleFecha = true;
                if (fechaInicio || fechaFin) {
                    const fechaGasto = new Date(gasto.fecha);
                    
                    if (fechaInicio && fechaFin) {
                        const inicio = new Date(fechaInicio);
                        const fin = new Date(fechaFin);
                        cumpleFecha = fechaGasto >= inicio && fechaGasto <= fin;
                    } else if (fechaInicio) {
                        const inicio = new Date(fechaInicio);
                        cumpleFecha = fechaGasto >= inicio;
                    } else if (fechaFin) {
                        const fin = new Date(fechaFin);
                        cumpleFecha = fechaGasto <= fin;
                    }
                }
                
                // Filtro por usuario (multiselect)
                let cumpleUsuario = true;
                if (selectedUsers.length > 0) {
                    cumpleUsuario = selectedUsers.includes(gasto.usuario);
                }
                
                // Filtro por viaje (multiselect)
                let cumpleViaje = true;
                if (selectedViajes.length > 0) {
                    cumpleViaje = selectedViajes.includes(gasto.motivo);
                }
                
                return cumpleFecha && cumpleUsuario && cumpleViaje;
            });
            
            const totalFiltrado = gastosFiltrados.reduce((sum, gasto) => sum + gasto.importe_eur, 0);
            
            document.getElementById('dashboardTotalTickets').textContent = gastos.length;
            document.getElementById('dashboardTicketsFiltrados').textContent = gastosFiltrados.length;
            document.getElementById('dashboardTotalFiltrado').textContent = formatCurrency(totalFiltrado);
        }

        // Funci√≥n para cambiar el estado checkeado
        async function toggleCheckedStatus(gastoId, checked) {
            try {
                const response = await fetch(`/api/gastos/${gastoId}/checkeado`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ checkeado: checked })
                });
                
                if (response.ok) {
                    // Actualizar el estado local
                    const gasto = gastos.find(g => g.id === gastoId);
                    if (gasto) {
                        gasto.checkeado = checked;
                    }
                    
                    // Actualizar la vista
                    if (currentView === 'dashboard') {
                        renderDashboardFilteredExpenses();
                    }
                    
                    showMessage(checked ? '‚úÖ Gasto confirmado' : '‚è≥ Gasto marcado como pendiente', 'success');
                } else {
                    showMessage('‚ùå Erreur lors de la mise √† jour du statut', 'error');
                }
            } catch (error) {
                console.error('Error al actualizar estado:', error);
                showMessage('‚ùå Error al actualizar el estado', 'error');
            }
        }

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar el d√≠a de corte guardado y actualizar el input
            loadCutoffDay();
            
            // Primero cargar los datos
            loadConceptos();
            loadMotivos();
            loadUsers(); // Cargar usuarios para filtros (solo visible para admin)
            setTodayDate();
            
            // Cargar informaci√≥n de viajes con detalles para filtros
            loadViajesConDetalles();
            
            // Luego establecer el rango por defecto y cargar gastos
            setDefaultDateRange('init'); // Establecer rango por defecto desde el 23
            
            // Cargar gastos despu√©s de establecer el rango de fechas
            loadGastos();
            
            // Actualizar t√≠tulo de exportaci√≥n inicial
            setTimeout(() => {
                updateExportTitle();
            }, 100);
            
            // Cargar √∫ltimo motivo usado desde localStorage
            const savedMotivo = localStorage.getItem('lastUsedMotivo');
            if (savedMotivo) {
                lastUsedMotivo = savedMotivo;
            }
            
            // Cargar √∫ltimo concepto usado desde localStorage
            const savedConcepto = localStorage.getItem('lastUsedConcepto');
            if (savedConcepto) {
                lastUsedConcepto = savedConcepto;
            }
            
            // Fermer modal con Escape
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        });

        // Cargar gastos
        async function loadGastos() {
            try {
                // En vista Gastos, TODOS ven solo sus propios gastos (incluso admin)
                const response = await fetch('/api/gastos');
                gastos = await response.json();
                
                // Verificar si hay filtros de fecha aplicados
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                if (fechaInicio || fechaFin) {
                    // Si hay filtros aplicados, mantener la vista filtrada
                    renderFilteredGastos();
                } else {
                    // Si no hay filtros, mostrar todos los gastos
                renderGastos();
                }
                
                updateStats();
                
                // Cargar resumen de viajes
                loadResumenViajes();
            } catch (error) {
                console.error('Error cargando gastos:', error);
            }
        }

        // Renderizar gastos
        function renderGastos() {
            const container = document.getElementById('expensesList');
            
            if (gastos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üéØ Sin gastos a√∫n</h3>
                        <p>Comienza a√±adiendo tu primer gasto con el bot√≥n ‚ûï</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = gastos.map(gasto => {
                // Solo mostrar indicadores de cuadre si el viaje tiene detalles configurados
                const viajeConDetalles = gasto.motivo && viajesConDetalles.has(gasto.motivo);
                
                return `
                <div class="expense-item ${viajeConDetalles ? (gasto.detalle_cuadrado ? 'cuadrado' : 'pendiente') : ''}">
                    <div>
                        ${gasto.imagen_path ? 
                            `<img src="/uploads/${gasto.imagen_path}" alt="Imagen" class="expense-image" onclick="showImageModal('/uploads/${gasto.imagen_path}')">` : 
                            '<div class="expense-image-placeholder">üì∑</div>'
                        }
                    </div>
                    <div class="expense-checkbox-container">
                        <input type="checkbox" class="gasto-checkbox" data-id="${gasto.id}" onchange="updateGastosSelection()">
                    </div>
                    <div class="expense-info">
                        <h4>${gasto.concepto}
                            ${viajeConDetalles && gasto.detalle_cuadrado ? 
                                ' <span class="cuadre-indicator cuadrado">‚úÖ</span>' : 
                                (viajeConDetalles && !gasto.detalle_cuadrado ? ' <span class="cuadre-indicator pendiente">‚è≥</span>' : '')
                            }
                        </h4>
                        <p><strong>üìÖ</strong> ${formatDate(gasto.fecha)}</p>
                        <p><strong>üöó</strong> ${gasto.motivo || 'Sin viaje'}
                            ${viajeConDetalles && gasto.detalle_cuadrado ? 
                                ' <span class="cuadre-text cuadrado">(Cuadrado)</span>' : 
                                (viajeConDetalles && !gasto.detalle_cuadrado ? ' <span class="cuadre-text pendiente">(Pendiente)</span>' : '')
                            }
                        </p>
                        <p><strong>üìù</strong> ${gasto.descripcion || 'Sin descripci√≥n'}</p>
                    </div>
                    <div class="expense-amount">
                        <div class="expense-amount-value">
                            ${formatCurrency(gasto.importe_eur)}
                        </div>
                        ${gasto.importe_otra_moneda && gasto.moneda_otra ? 
                            `<small style="color: #7f8c8d; font-size: 0.85em; font-weight: 400;">
                                ${formatCurrencyWithCode(gasto.importe_otra_moneda, gasto.moneda_otra)}
                            </small>` : ''
                        }
                    </div>
                    <div class="expense-cuadre">
                        ${viajeConDetalles ? `
                            <div class="cuadre-status">
                                ${gasto.detalle_cuadrado ? 
                                    `<span class="cuadre-badge cuadrado">‚úÖ Cuadra</span>
                                     <button class="btn-cuadre btn-descuadrar" onclick="descuadrarGasto(${gasto.id})" title="Descuadrar gasto">
                                         <span class="btn-text-desktop">‚ùå Descuadrar</span>
                                         <span class="btn-text-mobile">‚ùå</span>
                                     </button>` :
                                    `<span class="cuadre-badge pendiente">‚è≥ Pendiente</span>
                                     <button class="btn-cuadre btn-buscar" onclick="buscarCuadreAutomatico(${gasto.id})" title="Buscar cuadre autom√°tico">
                                         <span class="btn-text-desktop">üîç Cuadrar</span>
                                         <span class="btn-text-mobile">üîç</span>
                                     </button>`
                                }
                            </div>
                        ` : `<div class="cuadre-status-empty">${gasto.motivo ? 'Sin detalle' : 'Sin viaje'}</div>`}
                    </div>
                    <div class="expense-actions">
                        <button class="btn-action btn-edit" onclick="editGasto(${gasto.id})">
                            <span class="btn-text-desktop">‚úèÔ∏è Editar</span>
                            <span class="btn-text-mobile">‚úèÔ∏è</span>
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteGasto(${gasto.id})">
                            <span class="btn-text-desktop">üóëÔ∏è Eliminar</span>
                            <span class="btn-text-mobile">üóëÔ∏è</span>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            const totalTickets = gastos.length;
            
            // Estad√≠sticas totales
            document.getElementById('totalTickets').textContent = totalTickets;
            
            // Actualizar estad√≠sticas filtradas
            updateFilteredStats();
        }

        // Actualizar estad√≠sticas filtradas por fecha y viaje
        function updateFilteredStats() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const selectedViajes = getMultiselectSelected('gastosViajeMultiselect');
            
            let gastosFiltrados = gastos;
            
            // Aplicar filtros
            gastosFiltrados = gastos.filter(gasto => {
                // Filtro por fecha
                let cumpleFecha = true;
                if (fechaInicio || fechaFin) {
                    const fechaGasto = new Date(gasto.fecha);
                    
                    if (fechaInicio && fechaFin) {
                        const inicio = new Date(fechaInicio);
                        const fin = new Date(fechaFin);
                        cumpleFecha = fechaGasto >= inicio && fechaGasto <= fin;
                    } else if (fechaInicio) {
                        const inicio = new Date(fechaInicio);
                        cumpleFecha = fechaGasto >= inicio;
                    } else if (fechaFin) {
                        const fin = new Date(fechaFin);
                        cumpleFecha = fechaGasto <= fin;
                    }
                }
                
                // Filtro por viaje (multiselect)
                let cumpleViaje = true;
                if (selectedViajes.length > 0) {
                    cumpleViaje = selectedViajes.includes(gasto.motivo);
                }
                
                return cumpleFecha && cumpleViaje;
            });
            
            const ticketsFiltrados = gastosFiltrados.length;
            const totalFiltrado = gastosFiltrados.reduce((sum, gasto) => sum + gasto.importe_eur, 0);
            
            document.getElementById('ticketsFiltrados').textContent = ticketsFiltrados;
            document.getElementById('totalFiltrado').textContent = formatCurrency(totalFiltrado);
            
            // Actualizar t√≠tulo de exportaci√≥n
            updateExportTitle();
        }
        
        // Actualizar t√≠tulo de exportaci√≥n con usuario, fechas y viaje
        function updateExportTitle() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const userFilter = document.getElementById('gastosUserFilter');
            const viajeFilter = document.getElementById('gastosViajeFilter');
            
            let usuario = '{{ current_user }}';
            if (userFilter && userFilter.value) {
                usuario = userFilter.value;
            }
            
            let fechaTexto = 'todas';
            if (fechaInicio && fechaFin) {
                fechaTexto = `${formatDate(fechaInicio)} - ${formatDate(fechaFin)}`;
            } else if (fechaInicio) {
                fechaTexto = `desde ${formatDate(fechaInicio)}`;
            } else if (fechaFin) {
                fechaTexto = `hasta ${formatDate(fechaFin)}`;
            }
            
            let viajeTexto = '';
            if (viajeFilter && viajeFilter.value) {
                viajeTexto = ` - viaje [${viajeFilter.value}]`;
            }
            
            document.getElementById('exportTitle').textContent = `üìä Exportar Gastos de ${usuario} para fechas [${fechaTexto}]${viajeTexto}`;
        }

        // Limpiar filtros de fecha y viaje
        function clearDateFilters() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            const gastosViajeFilter = document.getElementById('gastosViajeFilter');
            if (gastosViajeFilter) {
                gastosViajeFilter.value = '';
            }
            renderGastos();
            updateFilteredStats();
            showMessage('üóëÔ∏è Filtres supprim√©s', 'info');
        }

        // Aplicar filtros de fecha (solo cuando se confirma)
        function applyDateFilters() {
            updateFilteredStats();
            renderFilteredGastos(); // Tambi√©n actualizar la lista visible
            showMessage('‚úÖ Filtros aplicados correctamente', 'success');
        }

        // Renderizar gastos filtrados
        function renderFilteredGastos() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const selectedViajes = getMultiselectSelected('gastosViajeMultiselect');
            
            let gastosFiltrados = gastos;
            
            // Aplicar filtros
            gastosFiltrados = gastos.filter(gasto => {
                // Filtro por fecha
                let cumpleFecha = true;
                if (fechaInicio || fechaFin) {
                    const fechaGasto = new Date(gasto.fecha);
                    
                    if (fechaInicio && fechaFin) {
                        const inicio = new Date(fechaInicio);
                        const fin = new Date(fechaFin);
                        cumpleFecha = fechaGasto >= inicio && fechaGasto <= fin;
                    } else if (fechaInicio) {
                        const inicio = new Date(fechaInicio);
                        cumpleFecha = fechaGasto >= inicio;
                    } else if (fechaFin) {
                        const fin = new Date(fechaFin);
                        cumpleFecha = fechaGasto <= fin;
                    }
                }
                
                // Filtro por viaje (multiselect)
                let cumpleViaje = true;
                if (selectedViajes.length > 0) {
                    cumpleViaje = selectedViajes.includes(gasto.motivo);
                }
                
                return cumpleFecha && cumpleViaje;
            });
            
            // Renderizar la lista filtrada
            const container = document.getElementById('expensesList');
            
            if (gastosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üéØ Aucun ticket dans cette p√©riode</h3>
                        <p>Aucun ticket ne correspond aux dates s√©lectionn√©es</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = gastosFiltrados.map(gasto => {
                // Solo mostrar indicadores de cuadre si el viaje tiene detalles configurados
                const viajeConDetalles = gasto.motivo && viajesConDetalles.has(gasto.motivo);
                
                return `
                <div class="expense-item ${viajeConDetalles ? (gasto.detalle_cuadrado ? 'cuadrado' : 'pendiente') : ''}">
                    <div>
                        ${gasto.imagen_path ? 
                            `<img src="/uploads/${gasto.imagen_path}" alt="Imagen" class="expense-image" onclick="showImageModal('/uploads/${gasto.imagen_path}')">` : 
                            '<div class="expense-image-placeholder">üì∑</div>'
                        }
                    </div>
                    <div class="expense-checkbox-container">
                        <input type="checkbox" class="gasto-checkbox" data-id="${gasto.id}" onchange="updateGastosSelection()">
                    </div>
                    <div class="expense-info">
                        <h4>${gasto.concepto}
                            ${viajeConDetalles && gasto.detalle_cuadrado ? 
                                ' <span class="cuadre-indicator cuadrado">‚úÖ</span>' : 
                                (viajeConDetalles && !gasto.detalle_cuadrado ? ' <span class="cuadre-indicator pendiente">‚è≥</span>' : '')
                            }
                        </h4>
                        <p><strong>üìÖ</strong> ${formatDate(gasto.fecha)}</p>
                        <p><strong>üöó</strong> ${gasto.motivo || 'Sin viaje'}
                            ${viajeConDetalles && gasto.detalle_cuadrado ? 
                                ' <span class="cuadre-text cuadrado">(Cuadrado)</span>' : 
                                (viajeConDetalles && !gasto.detalle_cuadrado ? ' <span class="cuadre-text pendiente">(Pendiente)</span>' : '')
                            }
                        </p>
                        <p><strong>üìù</strong> ${gasto.descripcion || 'Sin descripci√≥n'}</p>
                    </div>
                    <div class="expense-amount">
                        <div class="expense-amount-value">
                            ${formatCurrency(gasto.importe_eur)}
                        </div>
                        ${gasto.importe_otra_moneda && gasto.moneda_otra ? 
                            `<small style="color: #7f8c8d; font-size: 0.85em; font-weight: 400;">
                                ${formatCurrencyWithCode(gasto.importe_otra_moneda, gasto.moneda_otra)}
                            </small>` : ''
                        }
                    </div>
                    <div class="expense-cuadre">
                        ${viajeConDetalles ? `
                            <div class="cuadre-status">
                                ${gasto.detalle_cuadrado ? 
                                    `<span class="cuadre-badge cuadrado">‚úÖ Cuadra</span>
                                     <button class="btn-cuadre btn-descuadrar" onclick="descuadrarGasto(${gasto.id})" title="Descuadrar gasto">
                                         <span class="btn-text-desktop">‚ùå Descuadrar</span>
                                         <span class="btn-text-mobile">‚ùå</span>
                                     </button>` :
                                    `<span class="cuadre-badge pendiente">‚è≥ Pendiente</span>
                                     <button class="btn-cuadre btn-buscar" onclick="buscarCuadreAutomatico(${gasto.id})" title="Buscar cuadre autom√°tico">
                                         <span class="btn-text-desktop">üîç Cuadrar</span>
                                         <span class="btn-text-mobile">üîç</span>
                                     </button>`
                                }
                            </div>
                        ` : `<div class="cuadre-status-empty">${gasto.motivo ? 'Sin detalle' : 'Sin viaje'}</div>`}
                    </div>
                    <div class="expense-actions">
                        <button class="btn-action btn-edit" onclick="editGasto(${gasto.id})">
                            <span class="btn-text-desktop">‚úèÔ∏è Editar</span>
                            <span class="btn-text-mobile">‚úèÔ∏è</span>
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteGasto(${gasto.id})">
                            <span class="btn-text-desktop">üóëÔ∏è Eliminar</span>
                            <span class="btn-text-mobile">üóëÔ∏è</span>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // Establecer filtro para √∫ltimo mes (desde el d√≠a configurado)
        function setLastMonthRange() {
            const today = new Date();
            const currentDay = today.getDate();
            
            let startDate;
            
            // Usar el d√≠a de corte configurado por el administrador
            if (currentDay >= ADMIN_CUTOFF_DAY) {
                // Si ya pasamos el d√≠a de corte de este mes, empezar desde este mes
                startDate = new Date(today.getFullYear(), today.getMonth(), ADMIN_CUTOFF_DAY);
            } else {
                // Si a√∫n no llegamos al d√≠a de corte, empezar desde el mes anterior
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, ADMIN_CUTOFF_DAY);
            }
            
            // Formatear fechas para los inputs
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('fechaInicio').value = formatDate(startDate);
            document.getElementById('fechaFin').value = formatDate(today);
            
            // Confirmar fechas autom√°ticamente
            applyDateFilters();
        }

        // Establecer rango de fechas por defecto desde el √∫ltimo d√≠a 23
        function setDefaultDateRange() {
            const today = new Date();
            const currentDay = today.getDate();
            
            let startDate;
            
            if (currentDay >= 23) {
                // Si ya pasamos el d√≠a 23 de este mes, empezar desde el 23 de este mes
                startDate = new Date(today.getFullYear(), today.getMonth(), 23);
            } else {
                // Si a√∫n no llegamos al 23, empezar desde el 23 del mes anterior
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, 23);
            }
            
            // Fecha fin es hoy
            const endDate = today;
            
            // Formatear fechas para los inputs
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('fechaInicio').value = formatDate(startDate);
            document.getElementById('fechaFin').value = formatDate(endDate);
            
            // Solo actualizar estad√≠sticas y lista si es la inicializaci√≥n
            if (arguments[0] === 'init') {
                updateFilteredStats();
                // Para la inicializaci√≥n, siempre mostrar la vista filtrada
                // Los gastos se cargar√°n despu√©s en loadGastos()
            }
        }

        // Cargar conceptos
        async function loadConceptos() {
            try {
                const response = await fetch('/api/conceptos');
                conceptos = await response.json();
                updateConceptoDropdown();
            } catch (error) {
                console.error('Error cargando conceptos:', error);
            }
        }

        // Cargar motivos
        async function loadMotivos() {
            try {
                const response = await fetch('/api/motivos');
                motivos = await response.json();
                updateMotivoDropdown();
                updateViajeFilterDropdowns(); // Actualizar filtros de viaje
            } catch (error) {
                console.error('Error cargando motivos:', error);
            }
        }

        // Actualizar dropdown de filtro por viaje
        function updateViajeFilterDropdowns() {
            // Poblar multiselect de viajes en Gastos
            const gastosViajeOptions = document.getElementById('gastosViajeOptions');
            if (gastosViajeOptions && motivos.length > 0) {
                populateMultiselect('gastosViajeMultiselect', 'gastosViajeOptions', motivos);
            }
            
            // Poblar multiselect de viajes en Dashboard
            const dashboardViajeOptions = document.getElementById('dashboardViajeOptions');
            if (dashboardViajeOptions && motivos.length > 0) {
                populateMultiselect('dashboardViajeMultiselect', 'dashboardViajeOptions', motivos);
            }
        }

        // Actualizar dropdown de conceptos
        function updateConceptoDropdown() {
            const dropdown = document.getElementById('concepto');
            dropdown.innerHTML = '<option value="">Selecciona un concepto</option>' + 
                conceptos.map(concepto => `<option value="${concepto}">${concepto}</option>`).join('');
        }

        // Actualizar dropdown de motivos
        function updateMotivoDropdown() {
            const dropdown = document.getElementById('motivo');
            dropdown.innerHTML = '<option value="">Selecciona un viaje</option>' + 
                motivos.map(motivo => `<option value="${motivo}">${motivo}</option>`).join('') +
                '<option value="__NEW__">‚ûï Crear nuevo viaje...</option>';
            
            // Reconfigurar listeners despu√©s de actualizar
            setupMotivoDropdown();
        }

        // Manejar cambio en dropdown de motivos
        function setupMotivoDropdown() {
            const motivoDropdown = document.getElementById('motivo');
            if (motivoDropdown && !motivoDropdown.hasAttribute('data-listener-added')) {
                motivoDropdown.addEventListener('change', function() {
                    if (this.value === '__NEW__') {
                        const nuevoMotivo = prompt('Introduce el nuevo viaje:');
                        if (nuevoMotivo && nuevoMotivo.trim()) {
                            addNewMotivo(nuevoMotivo.trim());
                        } else {
                            this.value = '';
                        }
                    }
                });
                motivoDropdown.setAttribute('data-listener-added', 'true');
            }
        }

        // Agregar nuevo motivo
        async function addNewMotivo(motivo) {
            try {
                const response = await fetch('/api/motivos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ nombre: motivo })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Motivo a√±adido correctamente', 'success');
                    // Actualizar el √∫ltimo motivo usado
                    lastUsedMotivo = motivo;
                    localStorage.setItem('lastUsedMotivo', motivo);
                    
                    // Recargar motivos y seleccionar el nuevo una vez cargados
                    await loadMotivos();
                    
                    // Seleccionar el nuevo motivo con m√°s tiempo para que se complete la carga
                    setTimeout(() => {
                        const motivoSelect = document.getElementById('motivo');
                        if (motivoSelect) {
                            motivoSelect.value = motivo;
                        }
                    }, 200);
                } else {
                    showMessage('‚ùå Erreur lors de l\'ajout du groupe', 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error al a√±adir el motivo', 'error');
                console.error('Error:', error);
            }
        }

        // Abrir modal
        function openModal() {
            const modal = document.getElementById('expenseModal');
            modal.style.display = 'block';
            // Trigger animation
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            document.getElementById('modalTitle').textContent = 'üé´ Nuevo Ticket';
            currentExpenseId = null;
            resetForm();
        }

        // Fermer modal
        function closeModal() {
            const modal = document.getElementById('expenseModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
            resetForm();
        }

        // Resetear formulario
        function resetForm() {
            document.getElementById('expenseForm').reset();
            document.getElementById('previewContainer').style.display = 'none';
            capturedImage = null;
            processedImageFilename = null;
            existingImageFilename = null;
            setTodayDate();
            
            // Ocultar informaci√≥n del usuario original
            const originalUserInfo = document.getElementById('originalUserInfo');
            if (originalUserInfo) {
                originalUserInfo.style.display = 'none';
            }
            
            // Resetear el checkbox de an√°lisis IA (por defecto activado)
            document.getElementById('enableAiAnalysis').checked = true;
            
            // Cargar el √∫ltimo motivo usado si existe
            const savedMotivo = localStorage.getItem('lastUsedMotivo');
            if (savedMotivo) {
                lastUsedMotivo = savedMotivo;
                setTimeout(() => {
                    const motivoSelect = document.getElementById('motivo');
                    if (motivoSelect) {
                        motivoSelect.value = savedMotivo;
                    }
                }, 100);
            }
            
            // Cargar el √∫ltimo concepto usado si existe
            const savedConcepto = localStorage.getItem('lastUsedConcepto');
            if (savedConcepto) {
                lastUsedConcepto = savedConcepto;
                setTimeout(() => {
                    const conceptoSelect = document.getElementById('concepto');
                    if (conceptoSelect) {
                        conceptoSelect.value = savedConcepto;
                    }
                }, 100);
            }
        }

        // Establecer fecha de hoy
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = today;
        }

        // Abrir selector de tickets
        function openTicketInput() {
            document.getElementById('ticketInput').click();
        }

        // Manejar selecci√≥n de archivo(s) - detecta autom√°ticamente si es 1 o m√∫ltiples
        function handleTicketFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            if (files.length === 1) {
                // Procesamiento individual
                handleSingleTicketSelect(files[0]);
            } else {
                // Procesamiento por lotes
                handleBatchTicketSelect(files);
            }
        }

        // Manejar selecci√≥n de archivo individual
        function handleSingleTicketSelect(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                capturedImage = e.target.result;
                showPreview(e.target.result);
                
                // Solo procesar con IA si est√° activado el checkbox
                const aiAnalysisEnabled = document.getElementById('enableAiAnalysis').checked;
                if (aiAnalysisEnabled) {
                    processImageForExtraction(e.target.result);
                } else {
                    showMessage('üì∑ Imagen cargada sin an√°lisis IA. Completa los campos manualmente.', 'info');
                }
            };
            reader.readAsDataURL(file);
        }

        // Manejar selecci√≥n de m√∫ltiples archivos
        function handleBatchTicketSelect(files) {
            showMessage(`üìã Seleccionados ${files.length} archivos. Iniciando procesamiento...`, 'info');
            
            // Inicializar array de tickets
            batchTickets = [];
            currentBatchIndex = 0;

            // Convertir archivos a array y procesar
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    batchTickets.push({
                        id: index,
                        file: file,
                        imageData: e.target.result,
                        filename: file.name,
                        processed: false,
                        error: null,
                        extractedData: null
                    });

                    // Si es el √∫ltimo archivo, iniciar procesamiento
                    if (batchTickets.length === files.length) {
                        openBatchVerificationModal();
                        processBatchTickets();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Mostrar vista previa
        function showPreview(imageSrc) {
            document.getElementById('previewImage').src = imageSrc;
            document.getElementById('previewContainer').style.display = 'block';
        }

        // Eliminar imagen
        function deleteImage() {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette image?')) {
                capturedImage = null;
                processedImageFilename = null;
                existingImageFilename = null;
                document.getElementById('previewContainer').style.display = 'none';
                document.getElementById('ticketInput').value = '';
                showMessage('Imagen eliminada. Puedes seleccionar otra imagen.', 'success');
            }
        }

        // Procesar imagen para extracci√≥n
        async function processImageForExtraction(imageData) {
            if (!imageData) return;

            try {
                // Mostrar loading avanzado
                const loadingMsg = showAdvancedMessage('ü§ñ Analizando con IA...', 'info', 0);
                
                const response = await fetch('/api/process-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData })
                });
                
                const result = await response.json();
                
                // Remover mensaje de loading
                hideAdvancedMessage(loadingMsg);
                
                if (result.success) {
                    processedImageFilename = result.filename;
                    
                    // Aplicar informaci√≥n extra√≠da
                    const extracted = result.extracted_info;
                    const extractedFields = [];
                    
                    if (extracted.date) {
                        document.getElementById('fecha').value = extracted.date;
                        extractedFields.push('üìÖ Date');
                    }
                    
                    if (extracted.amount) {
                        // Detectar moneda y gestionar conversi√≥n inteligente
                        if (extracted.currency && extracted.currency !== 'EUR') {
                            // Si es otra moneda, llenar el campo de otra moneda
                            document.getElementById('monedaOtra').value = extracted.currency;
                            document.getElementById('importeOtraMoneda').value = extracted.amount;
                            extractedFields.push(`üí∞ Importe (${extracted.currency})`);
                            
                            // Convertir a EUR autom√°ticamente con un peque√±o delay
                            setTimeout(() => {
                                convertCurrencyToEUR();
                            }, 100);
                        } else {
                            // Si es EUR o no se detecta moneda, asumir EUR
                            document.getElementById('importeEur').value = extracted.amount;
                            extractedFields.push('üí∞ Montant (EUR)');
                            // Trigger conversion if currency is selected
                            if (document.getElementById('monedaOtra').value) {
                                convertCurrency();
                            }
                        }
                    }
                    
                    if (extracted.description) {
                        document.getElementById('descripcion').value = extracted.description;
                        extractedFields.push('üìù Descripci√≥n');
                    }
                    
                    if (extracted.concept) {
                        document.getElementById('concepto').value = extracted.concept;
                        extractedFields.push('üè∑Ô∏è Concept');
                    }
                    
                    if (extractedFields.length > 0) {
                        showMessage(`‚úÖ Extrait: ${extractedFields.join(', ')}`, 'success');
                    } else {
                        showMessage('‚ö†Ô∏è Impossible d\'extraire les informations. Compl√©tez manuellement.', 'warning');
                    }
                } else {
                    showMessage('‚ùå Erreur lors de l\'analyse de l\'image. Voulez-vous compl√©ter manuellement?', 'error');
                }
            } catch (error) {
                showMessage('‚ùå Erreur de connexion lors de l\'analyse de l\'image. Compl√©tez manuellement.', 'error');
                console.error('Error:', error);
            }
        }

        // Guardar gasto optimizado
        async function saveGasto(keepModalOpen = false) {
            // Validar campos requeridos
            if (!document.getElementById('fecha').value || !document.getElementById('concepto').value || !document.getElementById('importeEur').value) {
                showMessage('‚ùå Por favor completa todos los campos obligatorios', 'error');
                return false;
            }

            // Mostrar estado de carga en ambos botones
            const saveExitButton = document.getElementById('saveExitButton');
            const saveAddButton = document.getElementById('saveAddButton');
            const originalExitText = saveExitButton.textContent;
            const originalAddText = saveAddButton.textContent;
            
            saveExitButton.disabled = true;
            saveAddButton.disabled = true;
            saveExitButton.textContent = '‚è≥ Enregistrement...';
            saveAddButton.textContent = '‚è≥ Enregistrement...';
            saveExitButton.style.opacity = '0.6';
            saveAddButton.style.opacity = '0.6';

            // Optimizaci√≥n: Solo enviar imagen si es nueva y no est√° procesada
            const formData = {
                fecha: document.getElementById('fecha').value,
                concepto: document.getElementById('concepto').value,
                descripcion: document.getElementById('descripcion').value,
                motivo: document.getElementById('motivo').value,
                importe_eur: parseFloat(document.getElementById('importeEur').value),
                moneda_otra: document.getElementById('monedaOtra').value,
                importe_otra_moneda: document.getElementById('importeOtraMoneda').value ? parseFloat(document.getElementById('importeOtraMoneda').value) : null,
                // Solo enviar imagen si es nueva y no est√° procesada
                image: (capturedImage && !processedImageFilename) ? capturedImage : null,
                processed_image_filename: processedImageFilename,
                existing_image_filename: existingImageFilename
            };
            
            // Agregar usuario si es admin (solo para crear nuevos gastos)
            const usuarioSelect = document.getElementById('usuario');
            if (usuarioSelect && usuarioSelect.value && !currentExpenseId) {
                formData.usuario = usuarioSelect.value;
            }

            try {
                const url = currentExpenseId ? `/api/gastos/${currentExpenseId}` : '/api/gastos';
                const method = currentExpenseId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(
                        currentExpenseId ? '‚úÖ D√©pense mise √† jour correctement' : '‚úÖ D√©pense ajout√©e correctement', 
                        'success');
                    
                    // Actualizar √∫ltimo motivo usado si se especific√≥ uno
                    const motivoValue = formData.motivo;
                    if (motivoValue && motivoValue.trim()) {
                        lastUsedMotivo = motivoValue;
                        localStorage.setItem('lastUsedMotivo', motivoValue);
                    }
                    
                    // Actualizar √∫ltimo concepto usado si se especific√≥ uno
                    const conceptoValue = formData.concepto;
                    if (conceptoValue && conceptoValue.trim()) {
                        lastUsedConcepto = conceptoValue;
                        localStorage.setItem('lastUsedConcepto', conceptoValue);
                    }
                    
                    // Actualizar lista sin recargar todo
                    loadGastos();
                    
                    // Si es un nuevo gasto (no edici√≥n), intentar cuadre autom√°tico
                    if (!currentExpenseId && result.id && formData.motivo) {
                        setTimeout(() => {
                            intentarCuadreAutomatico(result.id);
                        }, 500); // Esperar un poco para que se actualice la lista
                    }
                    
                    // Si no mantenemos el modal abierto, cerrarlo
                    if (!keepModalOpen) {
                        closeModal();
                    } else {
                                    // Resetear para nuevo ticket
                        currentExpenseId = null;
            document.getElementById('modalTitle').textContent = 'üé´ Nuevo Ticket';
                        resetForm();
                    }
                    
                    return true;
                } else {
                    showMessage(`‚ùå Erreur lors de l'enregistrement: ${result.message || 'Erreur inconnue'}`, 'error');
                    return false;
                }
            } catch (error) {
                showMessage('‚ùå Erreur de connexion lors de l\'enregistrement', 'error');
                console.error('Error:', error);
                return false;
            } finally {
                // Restaurar botones
                saveExitButton.disabled = false;
                saveAddButton.disabled = false;
                saveExitButton.textContent = originalExitText;
                saveAddButton.textContent = originalAddText;
                saveExitButton.style.opacity = '1';
                saveAddButton.style.opacity = '1';
            }
        }

        // Guardar y salir
        async function saveGastoAndExit() {
            await saveGasto(false);
        }

        // Guardar y a√±adir otro
        async function saveGastoAndAdd() {
            await saveGasto(true);
        }

        // Editar gasto
        function editGasto(id) {
            try {
                // Buscar el gasto en la lista que ya tenemos cargada
                const gasto = gastos.find(g => g.id === id);
                
                if (gasto) {
                    currentExpenseId = id;
                    document.getElementById('modalTitle').textContent = '‚úèÔ∏è Editar Ticket';
                    

                    
                    // Asegurar que los dropdowns est√©n cargados
                    if (conceptos.length === 0) loadConceptos();
                    if (motivos.length === 0) loadMotivos();
                    
                    // Llenar formulario con un peque√±o delay para asegurar que los dropdowns est√©n listos
                    setTimeout(() => {
                        document.getElementById('fecha').value = gasto.fecha;
                        document.getElementById('concepto').value = gasto.concepto || '';
                        document.getElementById('descripcion').value = gasto.descripcion || '';
                        document.getElementById('motivo').value = gasto.motivo || '';
                        document.getElementById('importeEur').value = gasto.importe_eur;
                        document.getElementById('monedaOtra').value = gasto.moneda_otra || '';
                        document.getElementById('importeOtraMoneda').value = gasto.importe_otra_moneda || '';
                        
                        // Seleccionar usuario si es admin
                        const usuarioSelect = document.getElementById('usuario');
                        if (usuarioSelect && gasto.usuario) {
                            usuarioSelect.value = gasto.usuario;
                        }
                        
                        // Mostrar informaci√≥n del usuario original si es admin
                        const originalUserInfo = document.getElementById('originalUserInfo');
                        const originalUserName = document.getElementById('originalUserName');
                        if (originalUserInfo && originalUserName && gasto.usuario) {
                            // Buscar el nombre completo del usuario desde el dropdown
                            let displayName = gasto.usuario;
                            
                            if (usuarioSelect) {
                                const option = usuarioSelect.querySelector(`option[value="${gasto.usuario}"]`);
                                if (option) {
                                    displayName = option.textContent;
                                }
                            }
                            
                            originalUserName.textContent = displayName;
                            originalUserInfo.style.display = 'block';
                        }
                        
                        // Trigger currency conversion if needed
                        if (gasto.moneda_otra && gasto.importe_eur) {
                            convertCurrency();
                        }
                    }, 100);
                    
                    // Mostrar imagen si existe
                    if (gasto.imagen_path) {
                        existingImageFilename = gasto.imagen_path;
                        showPreview(`/uploads/${gasto.imagen_path}`);
                    } else {
                        document.getElementById('previewContainer').style.display = 'none';
                        existingImageFilename = null;
                    }
                    
                    // Abrir modal
                    const modal = document.getElementById('expenseModal');
                    modal.style.display = 'block';
                    setTimeout(() => {
                        modal.classList.add('show');
                    }, 10);
                } else {
                    showMessage('‚ùå D√©pense non trouv√©e', 'error');
                }
            } catch (error) {
                showMessage('‚ùå Erreur lors du chargement de la d√©pense', 'error');
                console.error('Error:', error);
            }
        }

        // Eliminar gasto
        async function deleteGasto(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette d√©pense?')) {
                try {
                    const response = await fetch(`/api/gastos/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showMessage('‚úÖ D√©pense supprim√©e correctement', 'success');
                        loadGastos();
                    } else {
                        showMessage('‚ùå Erreur lors de la suppression de la d√©pense', 'error');
                    }
                } catch (error) {
                    showMessage('‚ùå Error al eliminar el gasto', 'error');
                    console.error('Error:', error);
                }
            }
        }

        // Convertir moneda autom√°ticamente (EUR a otra moneda)
        async function convertCurrency() {
            const eurAmount = parseFloat(document.getElementById('importeEur').value);
            const targetCurrency = document.getElementById('monedaOtra').value;
            
            if (!eurAmount || !targetCurrency) {
                document.getElementById('importeOtraMoneda').value = '';
                return;
            }
            
            try {
                const response = await fetch('/api/convert-currency', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: eurAmount,
                        from_currency: 'EUR',
                        to_currency: targetCurrency
                    })
                });
                
                const result = await response.json();
                
                if (result.converted_amount !== undefined) {
                    document.getElementById('importeOtraMoneda').value = result.converted_amount.toFixed(2);
                }
            } catch (error) {
                console.error('Error converting currency:', error);
            }
        }

        // Convertir de otra moneda a EUR
        async function convertCurrencyToEUR() {
            const otherAmount = parseFloat(document.getElementById('importeOtraMoneda').value);
            const sourceCurrency = document.getElementById('monedaOtra').value;
            
            if (!otherAmount || !sourceCurrency) {
                document.getElementById('importeEur').value = '';
                return;
            }
            
            try {
                const response = await fetch('/api/convert-currency', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: otherAmount,
                        from_currency: sourceCurrency,
                        to_currency: 'EUR'
                    })
                });
                
                const result = await response.json();
                
                if (result.converted_amount !== undefined) {
                    document.getElementById('importeEur').value = result.converted_amount.toFixed(2);
                }
            } catch (error) {
                console.error('Error converting currency:', error);
            }
        }

        // Manejar cambio de moneda preservando valores
        function handleCurrencyChange() {
            const otherAmount = parseFloat(document.getElementById('importeOtraMoneda').value);
            const eurAmount = parseFloat(document.getElementById('importeEur').value);
            
            // Si hay un valor en otra moneda, conservarlo y actualizar EUR
            if (otherAmount) {
                convertCurrencyToEUR();
            } else if (eurAmount) {
                // Si no hay valor en otra moneda pero s√≠ en EUR, convertir a la nueva moneda
                convertCurrency();
            }
        }

        // Configurar conversi√≥n autom√°tica
        document.addEventListener('DOMContentLoaded', function() {
            // Convertir autom√°ticamente cuando cambie el importe EUR
            document.getElementById('importeEur').addEventListener('input', convertCurrency);
            
            // Convertir autom√°ticamente cuando cambie el importe en otra moneda
            document.getElementById('importeOtraMoneda').addEventListener('input', convertCurrencyToEUR);
            
            // Configurar dropdown de motivos
            setupMotivoDropdown();
        });

        // Sistema de mensajes mejorado
        function showMessage(message, type = 'info') {
            // Remover mensajes anteriores del mismo tipo
            const existingMessages = document.querySelectorAll(`.message.${type}`);
            existingMessages.forEach(msg => {
                msg.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => {
                    if (msg.parentNode) {
                        msg.remove();
                    }
                }, 300);
            });
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            
            document.body.appendChild(messageElement);
            
            // Activar animaci√≥n de entrada
            setTimeout(() => {
                messageElement.classList.add('show');
            }, 10);
            
            // Auto-cerrar despu√©s de 4 segundos (5 para √©xito)
            const duration = type === 'success' ? 5000 : 4000;
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.style.animation = 'slideOutRight 0.3s ease-out forwards';
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.remove();
                }
                    }, 300);
                }
            }, duration);
            
            // Permitir cerrar al hacer clic
            messageElement.addEventListener('click', () => {
                if (messageElement.parentNode) {
                    messageElement.style.animation = 'slideOutRight 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (messageElement.parentNode) {
                            messageElement.remove();
                        }
                    }, 300);
                }
            });
        }

        // Sistema de mensajes avanzados con loading
        function showAdvancedMessage(message, type = 'info', duration = 4000) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            
            if (type === 'info' && duration === 0) {
                // Loading message con spinner
                messageElement.innerHTML = `
                    <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span>${message}</span>
                `;
            } else {
                messageElement.textContent = message;
            }
            
            document.body.appendChild(messageElement);
            
            // Activar animaci√≥n
            setTimeout(() => {
                messageElement.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
            
            return messageElement;
        }

        // Ocultar mensaje avanzado
        function hideAdvancedMessage(messageElement) {
            if (messageElement && messageElement.parentNode) {
                messageElement.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.remove();
                    }
                }, 300);
            }
        }

        // Mostrar imagen en modal
        function showImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            modal.appendChild(img);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
        }

        // Formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                weekday: 'short',
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        }

        // Formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        // Formatear moneda con c√≥digo espec√≠fico
        function formatCurrencyWithCode(amount, currencyCode) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: currencyCode
            }).format(amount);
        }

        // ========== GESTI√ìN DE MOTIVOS ==========

        // Abrir modal de gesti√≥n de motivos
        function openManageMotivosModal() {
            const modal = document.getElementById('manageMotivosModal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // Limpiar el input de nuevo motivo
            clearNewMotivoInput();
            
            // Cargar la lista de motivos
            loadMotivosForManagement();
        }

        // Fermer modal de gesti√≥n de motivos
        function closeManageMotivosModal() {
            const modal = document.getElementById('manageMotivosModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Cargar motivos para gesti√≥n (TODOS, activos e inactivos)
        async function loadMotivosForManagement() {
            try {
                const response = await fetch('/api/motivos?solo_activos=false');
                const motivosData = await response.json();
                renderMotivosList(motivosData);
            } catch (error) {
                console.error('Error cargando motivos:', error);
                showMessage('‚ùå Erreur lors du chargement des groupes', 'error');
            }
        }

        // Renderizar lista de motivos
        function renderMotivosList(motivosData) {
            const container = document.getElementById('motivosList');
            
            if (motivosData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 32px; color: var(--text-secondary);">
                        <h3>üéØ Sin viajes a√∫n</h3>
                        <p>Utiliza el formulario de arriba para crear tu primer viaje</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = motivosData.map(motivo => {
                const nombreMotivo = typeof motivo === 'string' ? motivo : motivo.nombre;
                const estaActivo = typeof motivo === 'string' ? true : motivo.activo;
                const estadoIcon = estaActivo ? '‚úÖ' : '‚è∏Ô∏è';
                const estadoClass = estaActivo ? 'activo' : 'inactivo';
                const estadoTexto = estaActivo ? 'Activo' : 'Inactivo';
                
                return `
                <div class="motivo-item ${estadoClass}">
                    <div class="motivo-info">
                        <div class="motivo-name">${estadoIcon} ${nombreMotivo}</div>
                        <div class="motivo-status">${estadoTexto}</div>
                    </div>
                    <div class="motivo-actions">
                        <button class="motivo-toggle-btn" onclick="toggleMotivoActivo('${nombreMotivo.replace(/'/g, "\\'")}')">
                            ${estaActivo ? '‚è∏Ô∏è Desactivar' : '‚ñ∂Ô∏è Activar'}
                        </button>
                        <button class="motivo-detail-btn" onclick="openViajeDetalleModal('${nombreMotivo.replace(/'/g, "\\'")}')">
                            üìã Detalle
                        </button>
                        <button class="motivo-delete-btn" onclick="deleteMotivo('${nombreMotivo.replace(/'/g, "\\'")}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Toggle activo/inactivo de un viaje
        async function toggleMotivoActivo(motivoNombre) {
            try {
                const response = await fetch(`/api/motivos/${encodeURIComponent(motivoNombre)}/toggle-activo`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // Recargar la lista
                    await loadMotivosForManagement();
                    // Recargar tambi√©n los dropdowns de filtros
                    await loadMotivos();
                } else {
                    showMessage(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error toggle viaje:', error);
                showMessage('‚ùå Erreur lors du changement de statut du groupe', 'error');
            }
        }

        // Eliminar motivo
        async function deleteMotivo(motivoNombre) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le groupe "${motivoNombre}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/motivos/${encodeURIComponent(motivoNombre)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Groupe supprim√© correctement', 'success');
                    // Recargar lista de motivos en el modal
                    loadMotivosForManagement();
                    // Recargar dropdown de motivos en el formulario
                    loadMotivos();
                    
                    // Si el motivo eliminado era el √∫ltimo usado, limpiarlo
                    const savedMotivo = localStorage.getItem('lastUsedMotivo');
                    if (savedMotivo === motivoNombre) {
                        localStorage.removeItem('lastUsedMotivo');
                        lastUsedMotivo = '';
                    }
                } else {
                    showMessage(`‚ùå ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error eliminando motivo:', error);
                showMessage('‚ùå Error al eliminar el motivo', 'error');
            }
        }

        // A√±adir motivo desde el modal de gesti√≥n
        async function addMotivoFromModal() {
            const motivoName = document.getElementById('newMotivoName').value.trim();
            
            if (!motivoName) {
                showMessage('‚ö†Ô∏è Por favor, introduce un nombre para el viaje', 'warning');
                document.getElementById('newMotivoName').focus();
                return;
            }
            
            if (motivoName.length < 2) {
                showMessage('‚ö†Ô∏è El nombre del viaje debe tener al menos 2 caracteres', 'warning');
                document.getElementById('newMotivoName').focus();
                return;
            }
            
            // Verificar si el motivo ya existe
            if (motivos.includes(motivoName)) {
                showMessage('‚ö†Ô∏è Este viaje ya existe', 'warning');
                document.getElementById('newMotivoName').focus();
                return;
            }
            
            try {
                const response = await fetch('/api/motivos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ nombre: motivoName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Viaje a√±adido correctamente', 'success');
                    
                    // Limpiar el input
                    clearNewMotivoInput();
                    
                    // Recargar la lista de motivos en el modal
                    loadMotivosForManagement();
                    
                    // Recargar dropdown de motivos en el formulario principal
                    loadMotivos();
                    
                    // Actualizar el √∫ltimo motivo usado
                    lastUsedMotivo = motivoName;
                    localStorage.setItem('lastUsedMotivo', motivoName);
                    
                } else {
                    showMessage(`‚ùå ${result.error || 'Error al a√±adir el viaje'}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error al a√±adir el viaje', 'error');
                console.error('Error:', error);
            }
        }
        
        // Limpiar el input de nuevo motivo
        function clearNewMotivoInput() {
            document.getElementById('newMotivoName').value = '';
        }
        
        // Manejar Enter en el input de nuevo motivo
        document.addEventListener('DOMContentLoaded', function() {
            const newMotivoInput = document.getElementById('newMotivoName');
            if (newMotivoInput) {
                newMotivoInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        addMotivoFromModal();
                    }
                });
            }
        });
        
        // Fermer modales con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeManageMotivosModal();
                closeViajeDetalleModal();
            }
        });

        // ========== FUNCIONES DE GESTI√ìN DE DETALLES DE VIAJES ==========

        let currentViajeDetalle = null;
        let lastUsedMonedaDetalle = 'EUR';

        // Abrir modal de detalles de viaje
        function openViajeDetalleModal(motivo) {
            currentViajeDetalle = motivo;
            const modal = document.getElementById('viajeDetalleModal');
            const title = document.getElementById('viajeDetalleModalTitle');
            
            title.textContent = `üìã Detalles del Viaje: ${motivo}`;
            modal.style.display = 'block';
            
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // Limpiar formulario y cargar √∫ltima moneda
            clearNewDetalleInput();
            loadLastUsedMonedaDetalle();
            
            // Cargar detalles existentes
            loadViajeDetalles(motivo);
        }

        // Fermer modal de detalles de viaje
        function closeViajeDetalleModal() {
            const modal = document.getElementById('viajeDetalleModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                currentViajeDetalle = null;
            }, 300);
        }

        // Cargar detalles de un viaje
        async function loadViajeDetalles(motivo) {
            try {
                const response = await fetch(`/api/viajes/${encodeURIComponent(motivo)}/detalles`);
                const data = await response.json();
                
                // Manejar tanto el formato antiguo como el nuevo
                if (data.detalles && data.metadata) {
                    // Formato nuevo con metadatos
                    renderDetallesList(data.detalles, data.metadata);
                } else {
                    // Formato antiguo (fallback)
                    renderDetallesList(data);
                }
            } catch (error) {
                console.error('Error cargando detalles:', error);
                showMessage('‚ùå Erreur lors du chargement des d√©tails du groupe', 'error');
            }
        }

        // Renderizar lista de detalles
        function renderDetallesList(detalles, metadata = null) {
            const container = document.getElementById('detallesList');
            
            if (detalles.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 32px; color: var(--text-secondary);">
                        <h4>üí∞ Sin gastos esperados a√∫n</h4>
                        <p>Utiliza el formulario de arriba para a√±adir gastos esperados para este viaje</p>
                        ${metadata && metadata.total_gastos_esperados > 0 ? 
                            `<p style="margin-top: 16px; font-size: 0.9em; color: var(--text-secondary);">
                                üí∞ Total: ${metadata.total_gastos_esperados} gasto${metadata.total_gastos_esperados === 1 ? '' : 's'} esperado${metadata.total_gastos_esperados === 1 ? '' : 's'} en este viaje
                            </p>` : ''
                        }
                    </div>
                `;
                return;
            }

            const totalImporte = detalles.reduce((sum, detalle) => sum + detalle.importe_eur, 0);
            const pendientes = detalles.filter(d => !d.cuadrado).length;
            const importePendiente = detalles.filter(d => !d.cuadrado).reduce((sum, d) => sum + d.importe_eur, 0);

            container.innerHTML = `
                <div class="detalles-resumen" style="margin-bottom: 16px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: var(--radius-small); text-align: center;">
                    <p style="margin: 0; font-weight: 600;">
                        Total: ${totalImporte.toFixed(2)}‚Ç¨ | 
                        Pendientes: ${pendientes} (${importePendiente.toFixed(2)}‚Ç¨)
                        ${metadata && metadata.total_gastos_esperados !== undefined ? 
                            ` | üí∞ Esperados: ${metadata.total_gastos_esperados}` : ''
                        }
                    </p>
                </div>
                ${detalles.map(detalle => `
                    <div class="detalle-item">
                        <div class="detalle-info">
                            <div class="detalle-importe">üí∞ ${detalle.importe_eur.toFixed(2)}‚Ç¨</div>
                            ${detalle.moneda_original !== 'EUR' ? 
                                `<div class="detalle-descripcion">üåç ${detalle.importe_original.toFixed(2)} ${detalle.moneda_original}</div>` : 
                                ''}
                        </div>
                        <div class="detalle-estado">
                            <span class="${detalle.cuadrado ? 'detalle-cuadrado' : 'detalle-pendiente'}">
                                ${detalle.cuadrado ? '‚úÖ Cuadrado' : '‚è≥ Pendiente'}
                            </span>
                        </div>
                        <button class="detalle-delete-btn" onclick="deleteViajeDetalle(${detalle.id})">
                            üóëÔ∏è
                        </button>
                    </div>
                `).join('')}
            `;
        }

        // A√±adir nuevo detalle desde el modal
        async function addDetalleFromModal() {
            const importe = parseFloat(document.getElementById('nuevoDetalleImporte').value);
            const moneda = document.getElementById('nuevoDetalleMoneda').value;
            
            if (!importe || importe <= 0) {
                showMessage('‚ö†Ô∏è Por favor, introduce un importe v√°lido', 'warning');
                document.getElementById('nuevoDetalleImporte').focus();
                return;
            }
            
            if (!currentViajeDetalle) {
                showMessage('‚ùå Erreur: Aucun groupe s√©lectionn√©', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/viajes/${encodeURIComponent(currentViajeDetalle)}/detalles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        importe_original: importe,
                        moneda_original: moneda
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Gasto esperado a√±adido correctamente', 'success');
                    
                    // Guardar √∫ltima moneda utilizada
                    lastUsedMonedaDetalle = moneda;
                    localStorage.setItem('lastUsedMonedaDetalle', moneda);
                    
                    clearNewDetalleInput();
                    loadViajeDetalles(currentViajeDetalle);
                    
                    // Actualizar resumen inmediatamente
                    loadResumenViajes();
                } else {
                    showMessage(`‚ùå ${result.error || 'Error al a√±adir el gasto esperado'}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error al a√±adir el gasto esperado', 'error');
                console.error('Error:', error);
            }
        }

        // Eliminar detalle de viaje
        async function deleteViajeDetalle(detalleId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette d√©pense pr√©vue?')) {
                return;
            }

            try {
                const response = await fetch(`/api/viajes/detalles/${detalleId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Gasto esperado eliminado correctamente', 'success');
                    loadViajeDetalles(currentViajeDetalle);
                    
                    // Actualizar resumen inmediatamente
                    loadResumenViajes();
                } else {
                    showMessage(`‚ùå ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error eliminando detalle:', error);
                showMessage('‚ùå Error al eliminar el gasto esperado', 'error');
            }
        }

        // Cargar √∫ltima moneda utilizada para detalles
        function loadLastUsedMonedaDetalle() {
            const savedMoneda = localStorage.getItem('lastUsedMonedaDetalle');
            if (savedMoneda) {
                lastUsedMonedaDetalle = savedMoneda;
                const monedaSelect = document.getElementById('nuevoDetalleMoneda');
                if (monedaSelect) {
                    monedaSelect.value = savedMoneda;
                }
            }
        }

        // Limpiar inputs de nuevo detalle
        function clearNewDetalleInput() {
            document.getElementById('nuevoDetalleImporte').value = '';
            // Mantener la moneda seleccionada
        }

                // Manejar Enter en los inputs de detalle
        document.addEventListener('DOMContentLoaded', function() {
            const importeInput = document.getElementById('nuevoDetalleImporte');
            const monedaSelect = document.getElementById('nuevoDetalleMoneda');
            
            if (importeInput) {
                importeInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        document.getElementById('nuevoDetalleMoneda').focus();
                    }
                });
            }
            
            if (monedaSelect) {
                monedaSelect.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        addDetalleFromModal();
                    }
                });
            }
            
            // Cargar √∫ltima moneda al cargar la p√°gina
            const savedMonedaDetalle = localStorage.getItem('lastUsedMonedaDetalle');
            if (savedMonedaDetalle) {
                lastUsedMonedaDetalle = savedMonedaDetalle;
            }
        });

        // ========== FUNCIONES DE CUADRE DE GASTOS ==========

        // Buscar y aplicar cuadre autom√°tico al a√±adir un gasto
        async function intentarCuadreAutomatico(gastoId) {
            try {
                const response = await fetch(`/api/gastos/${gastoId}/buscar-cuadre`);
                const data = await response.json();
                
                if (data.candidatos && data.candidatos.length >= 1) {
                    // Si hay una o m√°s coincidencias, cuadrar autom√°ticamente con la primera (m√°s reciente)
                    const success = await cuadrarGastoConDetalle(gastoId, data.candidatos[0].id);
                    if (success) {
                        if (data.candidatos.length > 1) {
                            showMessage(`‚úÖ Gasto cuadrado autom√°ticamente (se eligi√≥ el m√°s reciente de ${data.candidatos.length} opciones)`, 'success');
                        } else {
                            showMessage('‚úÖ Gasto cuadrado autom√°ticamente', 'success');
                        }
                    }
                }
                // Si no hay candidatos, no mostrar nada (es normal al a√±adir gastos)
            } catch (error) {
                console.error('Error en cuadre autom√°tico:', error);
                // No mostrar error al usuario, es un proceso autom√°tico
            }
        }

        // Buscar cuadre autom√°tico para un gasto
        async function buscarCuadreAutomatico(gastoId) {
            try {
                const response = await fetch(`/api/gastos/${gastoId}/buscar-cuadre`);
                const data = await response.json();
                
                if (data.candidatos && data.candidatos.length > 0) {
                    // Cuadrar autom√°ticamente con el primer candidato (m√°s reciente)
                    const candidatoSeleccionado = data.candidatos[0];
                    await cuadrarGastoConDetalle(gastoId, candidatoSeleccionado.id);
                    
                    if (data.candidatos.length > 1) {
                        showMessage(`‚úÖ Gasto cuadrado autom√°ticamente (se eligi√≥ el m√°s reciente de ${data.candidatos.length} opciones)`, 'success');
                    } else {
                        showMessage('‚úÖ Gasto cuadrado autom√°ticamente', 'success');
                    }
                } else {
                    showMessage('‚ùå No existe un gasto esperado con este importe en los detalles del viaje', 'warning');
                }
            } catch (error) {
                console.error('Error buscando cuadre:', error);
                showMessage('‚ùå Error al buscar cuadre autom√°tico', 'error');
            }
        }

        // Funci√≥n obsoleta - mantenida por compatibilidad
        // El cuadre ahora es completamente autom√°tico

        // Cuadrar gasto con detalle espec√≠fico
        async function cuadrarGastoConDetalle(gastoId, detalleId, showSuccessMessage = false) {
            try {
                const response = await fetch(`/api/gastos/${gastoId}/cuadrar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ detalle_id: detalleId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (showSuccessMessage) {
                        showMessage('‚úÖ Gasto cuadrado correctamente', 'success');
                    }
                    loadGastos(); // Recargar lista de gastos (incluye resumen)
                    return true;
                } else {
                    showMessage(`‚ùå ${result.error}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error cuadrando gasto:', error);
                showMessage('‚ùå Error al cuadrar el gasto', 'error');
                return false;
            }
        }

        // Descuadrar gasto
        async function descuadrarGasto(gastoId) {
            if (!confirm('√ätes-vous s√ªr de vouloir d√©balancer cette d√©pense?')) {
                return;
            }

            try {
                const response = await fetch(`/api/gastos/${gastoId}/descuadrar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Gasto descuadrado correctamente', 'success');
                    loadGastos(); // Recargar lista de gastos (incluye resumen)
                } else {
                    showMessage(`‚ùå ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error descuadrando gasto:', error);
                showMessage('‚ùå Error al descuadrar el gasto', 'error');
            }
                 }

        // ========== FUNCIONES DE RESUMEN DE VIAJES ==========

        // Cargar informaci√≥n de viajes con detalles
        async function loadViajesConDetalles() {
            try {
                // Actualizar set de viajes con detalles (incluyendo los completamente cuadrados)
                viajesConDetalles.clear();
                
                try {
                    // Intentar obtener TODOS los viajes que tienen detalles configurados
                    const responseCompleto = await fetch('/api/viajes/todos-con-detalles');
                    if (responseCompleto.ok) {
                        const todosLosViajes = await responseCompleto.json();
                        todosLosViajes.forEach(viaje => {
                            viajesConDetalles.add(viaje.motivo);
                        });
                        console.log('‚úÖ Viajes con detalles cargados:', viajesConDetalles);
                        return;
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Endpoint /api/viajes/todos-con-detalles no disponible, usando fallback');
                }
                
                // Fallback: usar solo los del resumen (viajes con detalles pendientes)
                const response = await fetch('/api/viajes/resumen');
                if (response.ok) {
                    const resumen = await response.json();
                    resumen.forEach(viaje => {
                        viajesConDetalles.add(viaje.motivo);
                    });
                    console.log('‚ö†Ô∏è Usando fallback - solo viajes con pendientes:', viajesConDetalles);
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando viajes con detalles:', error);
            }
        }

        // Cargar y mostrar resumen de viajes
        async function loadResumenViajes() {
            try {
                const response = await fetch('/api/viajes/resumen');
                const resumen = await response.json();
                
                // Cargar informaci√≥n de viajes con detalles
                await loadViajesConDetalles();
                
                if (resumen.length > 0) {
                    renderResumenViajes(resumen);
                    document.getElementById('resumenViajesSection').style.display = 'block';
                } else {
                    document.getElementById('resumenViajesSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Error cargando resumen de viajes:', error);
                document.getElementById('resumenViajesSection').style.display = 'none';
            }
        }

        // Renderizar resumen de viajes
        function renderResumenViajes(resumen) {
            const container = document.getElementById('resumenViajesList');
            
            if (resumen.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 32px; color: var(--text-secondary);">
                        <h4>üéØ Tous les groupes sont √©quilibr√©s</h4>
                        <p>Aucun groupe avec des d√©tails en attente</p>
                    </div>
                `;
                return;
            }

            const totalViajes = resumen.length;
            const totalImportePendiente = resumen.reduce((sum, v) => sum + v.importe_pendiente, 0);

            container.innerHTML = `
                <div class="resumen-header" style="margin-bottom: 16px; padding: 12px; background: rgba(244, 63, 94, 0.1); border-radius: var(--radius-small); text-align: center;">
                    <p style="margin: 0; font-weight: 600;">
                        ${totalViajes} viaje${totalViajes > 1 ? 's' : ''} con detalles pendientes | 
                        Total pendiente: ${totalImportePendiente.toFixed(2)}‚Ç¨
                    </p>
                </div>
                ${resumen.map(viaje => `
                    <div class="resumen-viaje-item">
                        <div class="resumen-viaje-info">
                            <div class="resumen-viaje-nombre">üéØ ${viaje.motivo}</div>
                            <div class="resumen-viaje-stats">
                                <div class="resumen-stat total">
                                    üìä Total: ${viaje.total_importe.toFixed(2)}‚Ç¨ (${viaje.total_detalles} gastos esperados)
                                </div>
                                <div class="resumen-stat pendiente">
                                    ‚è≥ Pendientes: ${viaje.importe_pendiente.toFixed(2)}‚Ç¨ (${viaje.pendientes} gastos)
                                </div>
                            </div>
                        </div>
                        <div class="resumen-viaje-actions">
                            <button class="btn-resumen" onclick="openViajeDetalleModal('${viaje.motivo.replace(/'/g, "\\'")}')">
                                üìã Ver Detalles
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // ========== FUNCIONES DE EXPORTACI√ìN ==========

        // Exportar a PDF
        async function exportToPDF() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                showMessage('‚ö†Ô∏è Por favor, selecciona un rango de fechas para exportar', 'warning');
                return;
            }
            
            try {
                showMessage('üìÑ Generando PDF...', 'info');
                
                // Crear URL con par√°metros
                let url = `/api/export/pdf?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                
                // Agregar filtro de usuario si est√° seleccionado
                const userFilter = document.getElementById('gastosUserFilter');
                if (userFilter && userFilter.value) {
                    url += `&user=${userFilter.value}`;
                }
                
                // Agregar filtro de viaje si est√° seleccionado
                const viajeFilter = document.getElementById('gastosViajeFilter');
                if (viajeFilter && viajeFilter.value) {
                    url += `&viaje=${encodeURIComponent(viajeFilter.value)}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar PDF');
                }
                
                // Crear blob y descargar
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `gastos_${fechaInicio}_${fechaFin}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL
                window.URL.revokeObjectURL(downloadUrl);
                
                showMessage('‚úÖ PDF descargado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error exportando PDF:', error);
                showMessage('‚ùå Error al generar el PDF: ' + error.message, 'error');
            }
        }

        // Exportar a Excel
        async function exportToExcel() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                showMessage('‚ö†Ô∏è Por favor, selecciona un rango de fechas para exportar', 'warning');
                return;
            }
            
            try {
                showMessage('üìä Generando Excel...', 'info');
                
                // Crear URL con par√°metros
                let url = `/api/export/excel?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                
                // Agregar filtro de usuario si est√° seleccionado
                const userFilter = document.getElementById('gastosUserFilter');
                if (userFilter && userFilter.value) {
                    url += `&user=${userFilter.value}`;
                }
                
                // Agregar filtro de viaje si est√° seleccionado
                const viajeFilter = document.getElementById('gastosViajeFilter');
                if (viajeFilter && viajeFilter.value) {
                    url += `&viaje=${encodeURIComponent(viajeFilter.value)}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar Excel');
                }
                
                // Crear blob y descargar
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `gastos_${fechaInicio}_${fechaFin}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL
                window.URL.revokeObjectURL(downloadUrl);
                
                showMessage('‚úÖ Excel descargado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error exportando Excel:', error);
                showMessage('‚ùå Error al generar el Excel: ' + error.message, 'error');
            }
        }

        // Exportar Im√°genes
        async function exportImages() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                showMessage('‚ö†Ô∏è Por favor, selecciona un rango de fechas para exportar', 'warning');
                return;
            }
            
            try {
                showMessage('üñºÔ∏è Preparando im√°genes...', 'info');
                
                // Crear URL con par√°metros
                let url = `/api/export/images?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                
                // Agregar filtro de usuario si est√° seleccionado
                const userFilter = document.getElementById('gastosUserFilter');
                if (userFilter && userFilter.value) {
                    url += `&user=${userFilter.value}`;
                }
                
                // Agregar filtro de viaje si est√° seleccionado
                const viajeFilter = document.getElementById('gastosViajeFilter');
                if (viajeFilter && viajeFilter.value) {
                    url += `&viaje=${encodeURIComponent(viajeFilter.value)}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar ZIP de im√°genes');
                }
                
                // Crear blob y descargar
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `imagenes_gastos_${fechaInicio}_${fechaFin}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL
                window.URL.revokeObjectURL(downloadUrl);
                
                showMessage('‚úÖ Im√°genes descargadas exitosamente', 'success');
                
            } catch (error) {
                console.error('Error exportando im√°genes:', error);
                showMessage('‚ùå Error al generar el ZIP: ' + error.message, 'error');
            }
        }

        // Funciones de exportaci√≥n para el dashboard
        async function exportDashboardToPDF() {
            const fechaInicio = document.getElementById('dashboardFechaInicio').value;
            const fechaFin = document.getElementById('dashboardFechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                showMessage('‚ö†Ô∏è Por favor, selecciona un rango de fechas para exportar', 'warning');
                return;
            }
            
            try {
                showMessage('üìÑ Generando PDF...', 'info');
                
                let url = `/api/export/pdf?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                
                // Agregar filtro de usuario si est√° seleccionado
                const userFilter = document.getElementById('dashboardUserFilter');
                if (userFilter && userFilter.value) {
                    url += `&user=${userFilter.value}`;
                }
                
                // Agregar filtro de viaje si est√° seleccionado
                const viajeFilter = document.getElementById('dashboardViajeFilter');
                if (viajeFilter && viajeFilter.value) {
                    url += `&viaje=${encodeURIComponent(viajeFilter.value)}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar PDF');
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `dashboard_gastos_${fechaInicio}_${fechaFin}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                window.URL.revokeObjectURL(downloadUrl);
                
                showMessage('‚úÖ PDF descargado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error exportando PDF:', error);
                showMessage('‚ùå Error al generar el PDF: ' + error.message, 'error');
            }
        }

        async function exportDashboardToExcel() {
            const fechaInicio = document.getElementById('dashboardFechaInicio').value;
            const fechaFin = document.getElementById('dashboardFechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                showMessage('‚ö†Ô∏è Por favor, selecciona un rango de fechas para exportar', 'warning');
                return;
            }
            
            try {
                showMessage('üìä Generando Excel...', 'info');
                
                let url = `/api/export/excel?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                
                // Agregar filtro de usuario si est√° seleccionado
                const userFilter = document.getElementById('dashboardUserFilter');
                if (userFilter && userFilter.value) {
                    url += `&user=${userFilter.value}`;
                }
                
                // Agregar filtro de viaje si est√° seleccionado
                const viajeFilter = document.getElementById('dashboardViajeFilter');
                if (viajeFilter && viajeFilter.value) {
                    url += `&viaje=${encodeURIComponent(viajeFilter.value)}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar Excel');
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `dashboard_gastos_${fechaInicio}_${fechaFin}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                window.URL.revokeObjectURL(downloadUrl);
                
                showMessage('‚úÖ Excel descargado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error exportando Excel:', error);
                showMessage('‚ùå Error al generar el Excel: ' + error.message, 'error');
            }
        }

        async function exportDashboardImages() {
            const fechaInicio = document.getElementById('dashboardFechaInicio').value;
            const fechaFin = document.getElementById('dashboardFechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                showMessage('‚ö†Ô∏è Por favor, selecciona un rango de fechas para exportar', 'warning');
                return;
            }
            
            try {
                showMessage('üñºÔ∏è Generando ZIP de im√°genes...', 'info');
                
                let url = `/api/export/images?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                
                // Agregar filtro de usuario si est√° seleccionado
                const userFilter = document.getElementById('dashboardUserFilter');
                if (userFilter && userFilter.value) {
                    url += `&user=${userFilter.value}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar ZIP');
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `dashboard_imagenes_gastos_${fechaInicio}_${fechaFin}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                window.URL.revokeObjectURL(downloadUrl);
                
                showMessage('‚úÖ Im√°genes descargadas exitosamente', 'success');
                
            } catch (error) {
                console.error('Error exportando im√°genes:', error);
                showMessage('‚ùå Error al generar el ZIP: ' + error.message, 'error');
            }
        }

        // Funciones para manejo de usuarios
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    const users = await response.json();
                    
                    // Cargar usuarios en multiselect de dashboard (solo si es admin)
                    const dashboardUserOptions = document.getElementById('dashboardUserOptions');
                    if (dashboardUserOptions) {
                        const userNames = users.map(u => u.username);
                        populateMultiselect('dashboardUserMultiselect', 'dashboardUserOptions', userNames);
                    }
                    
                    // Cargar usuarios en modal de crear gasto (solo si es admin)
                    const usuarioSelect = document.getElementById('usuario');
                    if (usuarioSelect) {
                        usuarioSelect.innerHTML = '<option value="">Selecciona un usuario</option>';
                        users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.username;
                            option.textContent = `${user.name} (${user.username})`;
                            usuarioSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
            }
        }

        // Funci√≥n para manejar cambio de filtro de usuario en gastos
        function onGastosUserFilterChange() {
            loadGastos();
            updateExportTitle();
        }

        // Funci√≥n para manejar cambio de filtro de usuario en dashboard
        function onDashboardUserFilterChange() {
            // Preservar fechas actuales antes de recargar
            const fechaInicio = document.getElementById('dashboardFechaInicio').value;
            const fechaFin = document.getElementById('dashboardFechaFin').value;
            
            // Recargar datos del dashboard
            loadDashboard();
            
            // Restaurar fechas despu√©s de cargar si estaban establecidas
            if (fechaInicio && fechaFin) {
                setTimeout(() => {
                    document.getElementById('dashboardFechaInicio').value = fechaInicio;
                    document.getElementById('dashboardFechaFin').value = fechaFin;
                    applyDashboardDateFilters();
                }, 100);
            }
        }

        // Funciones para filtros por viaje
        function onGastosViajeFilterChange() {
            // Aplicar filtros inmediatamente
            updateFilteredStats();
            renderFilteredGastos();
            
            const viajeFilter = document.getElementById('gastosViajeFilter').value;
            if (viajeFilter) {
                showMessage(`üöó Filtrando por viaje: ${viajeFilter}`, 'info');
            } else {
                showMessage('üöó Filtro de viaje eliminado', 'info');
            }
        }

        function onDashboardViajeFilterChange() {
            // Aplicar filtros inmediatamente
            updateDashboardStats();
            renderDashboardFilteredExpenses();
            
            const viajeFilter = document.getElementById('dashboardViajeFilter').value;
            if (viajeFilter) {
                showMessage(`üöó Dashboard filtrando por viaje: ${viajeFilter}`, 'info');
            } else {
                showMessage('üöó Filtro de viaje eliminado del dashboard', 'info');
            }
        }

        // Filtros simplificados - Ya no necesitamos funciones multiselect complejas

        // Agregar event listeners para filtros de usuario y viaje
        document.addEventListener('DOMContentLoaded', function() {
            const gastosUserFilter = document.getElementById('gastosUserFilter');
            if (gastosUserFilter) {
                gastosUserFilter.addEventListener('change', onGastosUserFilterChange);
            }
            
            const dashboardUserFilter = document.getElementById('dashboardUserFilter');
            if (dashboardUserFilter) {
                dashboardUserFilter.addEventListener('change', onDashboardUserFilterChange);
            }
            
            const gastosViajeFilter = document.getElementById('gastosViajeFilter');
            if (gastosViajeFilter) {
                gastosViajeFilter.addEventListener('change', onGastosViajeFilterChange);
            }
            
            const dashboardViajeFilter = document.getElementById('dashboardViajeFilter');
            if (dashboardViajeFilter) {
                dashboardViajeFilter.addEventListener('change', onDashboardViajeFilterChange);
            }
        });

        // === FUNCIONES PARA PROCESAMIENTO POR LOTES ===

        let batchTickets = [];
        let currentBatchIndex = 0;



        // Abrir modal de verificaci√≥n por lotes
        function openBatchVerificationModal() {
            const modal = document.getElementById('batchVerificationModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            
            // Mostrar estado de procesamiento
            document.getElementById('batchProcessingStatus').style.display = 'block';
            document.getElementById('batchVerificationContainer').style.display = 'none';
            
            // Resetear progreso
            document.getElementById('batchProgressFill').style.width = '0%';
            document.getElementById('batchProgressText').textContent = 'Preparando procesamiento...';
        }

        // Fermer modal de verificaci√≥n por lotes
        function closeBatchVerificationModal() {
            const modal = document.getElementById('batchVerificationModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            
            // Limpiar datos
            batchTickets = [];
            currentBatchIndex = 0;
            document.getElementById('ticketInput').value = '';
        }

        // Procesar tickets por lotes
        async function processBatchTickets() {
            const total = batchTickets.length;
            let processed = 0;
            let errors = 0;

            for (let i = 0; i < batchTickets.length; i++) {
                const ticket = batchTickets[i];
                
                // Actualizar progreso
                const progress = ((i + 1) / total) * 100;
                document.getElementById('batchProgressFill').style.width = progress + '%';
                document.getElementById('batchProgressText').textContent = `Traitement ${i + 1} sur ${total}: ${ticket.filename}`;

                try {
                    // Procesar imagen con IA
                    const response = await fetch('/api/process-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ image: ticket.imageData })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        ticket.processed = true;
                        ticket.extractedData = result.extracted_info;
                        ticket.processedImageFilename = result.filename;
                        processed++;
                        
                        // Debug: Verificar la estructura de los datos extra√≠dos
                        console.log(`Ticket ${i} procesado correctamente:`, {
                            filename: ticket.filename,
                            extractedData: ticket.extractedData,
                            amount: ticket.extractedData?.amount,
                            currency: ticket.extractedData?.currency
                        });
                    } else {
                        ticket.error = result.error || 'Erreur lors du traitement de l\'image';
                        errors++;
                    }
                } catch (error) {
                    ticket.error = 'Erreur de connexion: ' + error.message;
                    errors++;
                }

                // Peque√±a pausa para no sobrecargar el servidor
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Procesamiento completado
            document.getElementById('batchProcessingStatus').style.display = 'none';
            document.getElementById('batchVerificationContainer').style.display = 'block';
            
            // Actualizar estad√≠sticas
            document.getElementById('batchTotalCount').textContent = total;
            document.getElementById('batchProcessedCount').textContent = processed;
            document.getElementById('batchErrorCount').textContent = errors;
            
            // Mostrar tickets para verificaci√≥n
            renderBatchTickets();
            
            // Asegurar que los valores se actualicen correctamente
            setTimeout(() => {
                updateBatchFieldValues();
            }, 200);
            
            showMessage(`‚úÖ Procesamiento completado: ${processed} exitosos, ${errors} errores`, processed > 0 ? 'success' : 'error');
        }

        // Renderizar tickets para verificaci√≥n
        function renderBatchTickets() {
            console.log('=== renderBatchTickets() ejecut√°ndose ===');
            const container = document.getElementById('batchTicketsList');
            container.innerHTML = '';

            batchTickets.forEach((ticket, index) => {
                console.log(`Renderizando ticket ${index}:`, {
                    processed: ticket.processed,
                    extractedData: ticket.extractedData,
                    amount: ticket.extractedData?.amount,
                    currency: ticket.extractedData?.currency
                });
                const ticketHtml = `
                    <div class="batch-ticket-item ${ticket.processed ? 'success' : 'error'}" data-index="${index}">
                        <div class="batch-ticket-header">
                            <span class="batch-ticket-filename">${ticket.filename}</span>
                            <span class="batch-ticket-status ${ticket.processed ? 'success' : 'error'}">
                                ${ticket.processed ? 'Procesado' : 'Error'}
                            </span>
                        </div>
                        
                        ${ticket.error ? `<div class="error-message" style="color: #dc2626; font-size: 12px; margin-bottom: 10px;">‚ùå ${ticket.error}</div>` : ''}
                        
                        <div class="batch-ticket-preview">
                            <img src="${ticket.imageData}" alt="Ticket" class="batch-ticket-image">
                            <div class="batch-ticket-data">
                                <div class="batch-ticket-field">
                                    <label>Fecha</label>
                                    <input type="date" id="batch_fecha_${index}" value="${ticket.extractedData?.date || ''}" ${!ticket.processed ? 'disabled' : ''}>
                                </div>
                                <div class="batch-ticket-field">
                                    <label>Importe</label>
                                    <input type="number" id="batch_importe_${index}" value="${ticket.extractedData?.amount || ''}" step="0.01" ${!ticket.processed ? 'disabled' : ''}>
                                </div>
                                <div class="batch-ticket-field">
                                    <label>Moneda</label>
                                    <input type="text" id="batch_moneda_${index}" value="${ticket.extractedData?.currency || 'EUR'}" ${!ticket.processed ? 'disabled' : ''}>
                                </div>
                                <div class="batch-ticket-field">
                                    <label>Descripci√≥n</label>
                                    <input type="text" id="batch_descripcion_${index}" value="${ticket.extractedData?.description || ''}" ${!ticket.processed ? 'disabled' : ''}>
                                </div>
                                <div class="batch-ticket-field">
                                    <label>Concepto</label>
                                    <input type="text" id="batch_concepto_${index}" value="${ticket.extractedData?.concept || ''}" ${!ticket.processed ? 'disabled' : ''}>
                                </div>
                                <div class="batch-ticket-field">
                                    <label>Viaje</label>
                                    <select id="batch_motivo_${index}" ${!ticket.processed ? 'disabled' : ''}>
                                        <option value="">Selecciona un viaje</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="batch-ticket-actions">
                            ${!ticket.processed ? `
                                <button class="btn-retry" onclick="retryBatchTicket(${index})">
                                    <i class="fas fa-redo"></i> Reintentar
                                </button>
                            ` : ''}
                            <button class="btn-delete" onclick="removeBatchTicket(${index})">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += ticketHtml;
            });
            
            // Llenar los selects de motivos despu√©s de renderizar
            populateBatchMotivos();
            
            // Actualizar valores de campos despu√©s de renderizar
            setTimeout(() => {
                updateBatchFieldValues();
            }, 100);
        }

        // Actualizar valores de campos despu√©s de renderizar (para solucionar problemas de template)
        function updateBatchFieldValues() {
            console.log('=== updateBatchFieldValues() ejecut√°ndose ===');
            batchTickets.forEach((ticket, index) => {
                console.log(`Ticket ${index}:`, {
                    processed: ticket.processed,
                    extractedData: ticket.extractedData,
                    amount: ticket.extractedData?.amount,
                    currency: ticket.extractedData?.currency
                });
                
                if (ticket.processed && ticket.extractedData) {
                    // Actualizar importe
                    const importeInput = document.getElementById(`batch_importe_${index}`);
                    if (importeInput) {
                        const amountValue = ticket.extractedData.amount;
                        console.log(`Actualizando importe ${index}: ${amountValue} (tipo: ${typeof amountValue})`);
                        importeInput.value = amountValue || '';
                        console.log(`Input importe ${index} despu√©s de actualizar: "${importeInput.value}"`);
                        
                        // Verificar si el valor se estableci√≥ correctamente
                        setTimeout(() => {
                            console.log(`Verificaci√≥n importe ${index}: "${importeInput.value}"`);
                        }, 10);
                    }
                    
                    // Actualizar moneda
                    const monedaInput = document.getElementById(`batch_moneda_${index}`);
                    if (monedaInput) {
                        const currencyValue = ticket.extractedData.currency;
                        console.log(`Actualizando moneda ${index}: ${currencyValue} (tipo: ${typeof currencyValue})`);
                        monedaInput.value = currencyValue || 'EUR';
                        console.log(`Input moneda ${index} despu√©s de actualizar: "${monedaInput.value}"`);
                        
                        // Verificar si el valor se estableci√≥ correctamente
                        setTimeout(() => {
                            console.log(`Verificaci√≥n moneda ${index}: "${monedaInput.value}"`);
                        }, 10);
                    }
                    
                    // Actualizar descripci√≥n
                    const descripcionInput = document.getElementById(`batch_descripcion_${index}`);
                    if (descripcionInput && ticket.extractedData.description) {
                        descripcionInput.value = ticket.extractedData.description;
                    }
                    
                    // Actualizar concepto
                    const conceptoInput = document.getElementById(`batch_concepto_${index}`);
                    if (conceptoInput && ticket.extractedData.concept) {
                        conceptoInput.value = ticket.extractedData.concept;
                    }
                    
                    // Actualizar fecha
                    const fechaInput = document.getElementById(`batch_fecha_${index}`);
                    if (fechaInput && ticket.extractedData.date) {
                        fechaInput.value = ticket.extractedData.date;
                    }
                }
            });
        }

        // Llenar los selects de motivos para procesamiento por lotes
        async function populateBatchMotivos() {
            // Asegurarse de que los motivos est√°n cargados
            if (motivos.length === 0) {
                await loadMotivos();
            }
            
            // Llenar cada select de motivo
            batchTickets.forEach((ticket, index) => {
                // Debug: Verificar qu√© datos est√°n llegando
                console.log(`Ticket ${index} extractedData:`, ticket.extractedData);
                const motivoSelect = document.getElementById(`batch_motivo_${index}`);
                if (motivoSelect && ticket.processed) {
                    // Llenar opciones
                    motivoSelect.innerHTML = '<option value="">Selecciona un viaje</option>' + 
                        motivos.map(motivo => `<option value="${motivo}">${motivo}</option>`).join('') +
                        '<option value="__NEW__">‚ûï Crear nuevo viaje...</option>';
                    
                    // Seleccionar autom√°ticamente el motivo si existe
                    let motivoSeleccionado = false;
                    
                    if (ticket.extractedData?.motivo) {
                        const extractedMotivo = ticket.extractedData.motivo.trim();
                        
                        // Buscar coincidencia exacta
                        const exactMatch = motivos.find(m => m.toLowerCase() === extractedMotivo.toLowerCase());
                        if (exactMatch) {
                            motivoSelect.value = exactMatch;
                            motivoSeleccionado = true;
                        } else {
                            // Buscar coincidencia parcial
                            const partialMatch = motivos.find(m => 
                                m.toLowerCase().includes(extractedMotivo.toLowerCase()) || 
                                extractedMotivo.toLowerCase().includes(m.toLowerCase())
                            );
                            if (partialMatch) {
                                motivoSelect.value = partialMatch;
                                motivoSeleccionado = true;
                            }
                        }
                    }
                    
                    // Si no se seleccion√≥ un motivo espec√≠fico, usar el √∫ltimo motivo usado
                    if (!motivoSeleccionado && lastUsedMotivo && motivos.includes(lastUsedMotivo)) {
                        motivoSelect.value = lastUsedMotivo;
                    }
                    
                    // Agregar listener para crear nuevo motivo
                    motivoSelect.addEventListener('change', function() {
                        if (this.value === '__NEW__') {
                            const nuevoMotivo = prompt('Introduce el nuevo viaje:');
                            if (nuevoMotivo && nuevoMotivo.trim()) {
                                addNewMotivoBatch(nuevoMotivo.trim(), index);
                            } else {
                                this.value = '';
                            }
                        }
                    });
                }
            });
        }

        // Agregar nuevo motivo desde procesamiento por lotes
        async function addNewMotivoBatch(motivo, ticketIndex) {
            try {
                const response = await fetch('/api/motivos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ motivo: motivo })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Motivo a√±adido correctamente', 'success');
                    
                    // Recargar motivos
                    await loadMotivos();
                    
                    // Actualizar todos los selects de motivos
                    setTimeout(() => {
                        populateBatchMotivos();
                        
                        // Seleccionar el nuevo motivo en el ticket espec√≠fico
                        const motivoSelect = document.getElementById(`batch_motivo_${ticketIndex}`);
                        if (motivoSelect) {
                            motivoSelect.value = motivo;
                        }
                    }, 200);
                } else {
                    showMessage('‚ùå Erreur lors de l\'ajout du groupe', 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error al a√±adir el motivo', 'error');
                console.error('Error:', error);
            }
        }

        // Reintentar procesamiento de un ticket
        async function retryBatchTicket(index) {
            const ticket = batchTickets[index];
            
            try {
                showMessage(`üîÑ Reintentando procesamiento de ${ticket.filename}...`, 'info');
                
                const response = await fetch('/api/process-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: ticket.imageData })
                });

                const result = await response.json();
                
                if (result.success) {
                    ticket.processed = true;
                    ticket.extractedData = result.extracted_info;
                    ticket.processedImageFilename = result.filename;
                    ticket.error = null;
                    
                    // Actualizar estad√≠sticas
                    const processedCount = document.getElementById('batchProcessedCount');
                    const errorCount = document.getElementById('batchErrorCount');
                    processedCount.textContent = parseInt(processedCount.textContent) + 1;
                    errorCount.textContent = parseInt(errorCount.textContent) - 1;
                    
                    // Re-renderizar tickets
                    renderBatchTickets();
                    
                    showMessage(`‚úÖ ${ticket.filename} trait√© avec succ√®s`, 'success');
                } else {
                    ticket.error = result.error || 'Error al procesar imagen';
                    showMessage(`‚ùå Erreur lors du traitement ${ticket.filename}`, 'error');
                }
            } catch (error) {
                ticket.error = 'Error de conexi√≥n: ' + error.message;
                showMessage(`‚ùå Erreur de connexion lors du traitement ${ticket.filename}`, 'error');
            }
        }

        // Eliminar ticket del lote
        function removeBatchTicket(index) {
            if (confirm('Supprimer ce ticket du lot?')) {
                const ticket = batchTickets[index];
                
                // Actualizar estad√≠sticas
                const totalCount = document.getElementById('batchTotalCount');
                totalCount.textContent = parseInt(totalCount.textContent) - 1;
                
                if (ticket.processed) {
                    const processedCount = document.getElementById('batchProcessedCount');
                    processedCount.textContent = parseInt(processedCount.textContent) - 1;
                } else {
                    const errorCount = document.getElementById('batchErrorCount');
                    errorCount.textContent = parseInt(errorCount.textContent) - 1;
                }
                
                // Eliminar del array
                batchTickets.splice(index, 1);
                
                // Re-renderizar
                renderBatchTickets();
                
                showMessage(`üóëÔ∏è Ticket eliminado del lote`, 'info');
            }
        }

        // Guardar todos los tickets verificados
        async function saveAllBatchTickets() {
            const processedTickets = batchTickets.filter(ticket => ticket.processed);
            
            if (processedTickets.length === 0) {
                showMessage('‚ùå Aucun ticket trait√© √† enregistrer', 'error');
                return;
            }

            const confirmMsg = `Enregistrer ${processedTickets.length} tickets dans la base de donn√©es?`;
            if (!confirm(confirmMsg)) return;

            const saveBtn = document.getElementById('saveAllBatchBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';

            let savedCount = 0;
            let errorCount = 0;

            for (let i = 0; i < processedTickets.length; i++) {
                const ticket = processedTickets[i];
                const index = batchTickets.indexOf(ticket);
                
                try {
                    // Recopilar datos del formulario
                    const importeValue = parseFloat(document.getElementById(`batch_importe_${index}`).value);
                    const monedaValue = document.getElementById(`batch_moneda_${index}`).value;
                    
                    // Si importe est√° vac√≠o, usar directamente de extractedData
                    const finalImporte = importeValue || (ticket.extractedData && ticket.extractedData.amount) || 0;
                    
                    // Si moneda est√° vac√≠a, usar directamente de extractedData
                    const finalMoneda = monedaValue || (ticket.extractedData && ticket.extractedData.currency) || 'EUR';
                    
                    // Determinar si es EUR o otra moneda
                    const isEUR = finalMoneda === 'EUR';
                    
                    const ticketData = {
                        fecha: document.getElementById(`batch_fecha_${index}`).value,
                        importe_eur: isEUR ? finalImporte : null,
                        moneda_otra: isEUR ? null : finalMoneda,
                        importe_otra_moneda: isEUR ? null : finalImporte,
                        descripcion: document.getElementById(`batch_descripcion_${index}`).value,
                        concepto: document.getElementById(`batch_concepto_${index}`).value,
                        motivo: document.getElementById(`batch_motivo_${index}`).value,
                        processed_image_filename: ticket.processedImageFilename
                    };
                    
                    // Debug: Verificar valores obtenidos del formulario
                    console.log(`Ticket ${index} datos del formulario:`, {
                        originalImporte: importeValue,
                        originalDevise: monedaValue,
                        finalImporte: finalImporte,
                        finalDevise: finalMoneda,
                        isEUR: isEUR,
                        ticketData: ticketData
                    });

                    // Validar datos requeridos
                    const hasValidImporte = ticketData.importe_eur || ticketData.importe_otra_moneda;
                    if (!ticketData.fecha || !hasValidImporte || !ticketData.descripcion) {
                        console.log(`Ticket ${index} FALL√ì validaci√≥n:`, {
                            fecha: ticketData.fecha,
                            importe_eur: ticketData.importe_eur,
                            importe_otra_moneda: ticketData.importe_otra_moneda,
                            hasValidImporte: hasValidImporte,
                            descripcion: ticketData.descripcion
                        });
                        errorCount++;
                        continue;
                    }
                    
                    console.log(`Ticket ${index} PAS√ì validaci√≥n, enviando:`, ticketData);

                    // Guardar ticket
                    const response = await fetch('/api/gastos', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(ticketData)
                    });

                    if (response.ok) {
                        savedCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }

            // Mostrar resultado
            if (savedCount > 0) {
                showMessage(`‚úÖ ${savedCount} tickets guardados exitosamente${errorCount > 0 ? `, ${errorCount} errores` : ''}`, 'success');
                
                // Recargar lista de gastos
                loadGastos();
                
                // Fermer modal
                setTimeout(() => {
                    closeBatchVerificationModal();
                }, 1500);
            } else {
                showMessage(`‚ùå Error al guardar tickets: ${errorCount} errores`, 'error');
            }

            // Restaurar bot√≥n
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Todos los Tickets';
        }

        // === FIN FUNCIONES PARA PROCESAMIENTO POR LOTES ===

        // === FUNCIONES PARA SELECCI√ìN M√öLTIPLE ===

        // Variables para tracking de selecci√≥n
        let selectedGastos = new Set();
        let selectedDashboard = new Set();

        // Actualizar selecci√≥n de gastos
        function updateGastosSelection() {
            selectedGastos.clear();
            document.querySelectorAll('.gasto-checkbox:checked').forEach(checkbox => {
                selectedGastos.add(parseInt(checkbox.dataset.id));
            });
            
            const count = selectedGastos.size;
            document.getElementById('selectedGastosCount').textContent = `${count} tickets s√©lectionn√©s`;
            document.getElementById('deleteSelectedGastosBtn').disabled = count === 0;
            
            // Actualizar bot√≥n "Tout S√©lectionner"
            const allCheckboxes = document.querySelectorAll('.gasto-checkbox');
            const selectAllBtn = document.getElementById('selectAllGastosBtn');
            if (count === allCheckboxes.length && count > 0) {
                selectAllBtn.textContent = '‚òê Deseleccionar Todo';
            } else {
                selectAllBtn.textContent = '‚òëÔ∏è Tout S√©lectionner';
            }
        }

        // Actualizar selecci√≥n de dashboard
        function updateDashboardSelection() {
            selectedDashboard.clear();
            document.querySelectorAll('.dashboard-checkbox:checked').forEach(checkbox => {
                selectedDashboard.add(parseInt(checkbox.dataset.id));
            });
            
            const count = selectedDashboard.size;
            document.getElementById('selectedDashboardCount').textContent = `${count} tickets s√©lectionn√©s`;
            document.getElementById('confirmSelectedBtn').disabled = count === 0;
            document.getElementById('unconfirmSelectedBtn').disabled = count === 0;
            
            // Actualizar bot√≥n "Tout S√©lectionner"
            const allCheckboxes = document.querySelectorAll('.dashboard-checkbox');
            const selectAllBtn = document.getElementById('selectAllDashboardBtn');
            if (count === allCheckboxes.length && count > 0) {
                selectAllBtn.textContent = '‚òê Deseleccionar Todo';
            } else {
                selectAllBtn.textContent = '‚òëÔ∏è Tout S√©lectionner';
            }
        }

        // Toggle seleccionar todo
        function toggleSelectAll(view) {
            if (view === 'gastos') {
                const checkboxes = document.querySelectorAll('.gasto-checkbox');
                const allChecked = selectedGastos.size === checkboxes.length && checkboxes.length > 0;
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });
                updateGastosSelection();
            } else if (view === 'dashboard') {
                const checkboxes = document.querySelectorAll('.dashboard-checkbox');
                const allChecked = selectedDashboard.size === checkboxes.length && checkboxes.length > 0;
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });
                updateDashboardSelection();
            }
        }

        // Eliminar gastos s√©lectionn√©s
        async function deleteSelectedGastos() {
            if (selectedGastos.size === 0) return;
            
            const confirmMsg = `√ätes-vous s√ªr de vouloir supprimer ${selectedGastos.size} tickets s√©lectionn√©s?`;
            if (!confirm(confirmMsg)) return;
            
            const btn = document.getElementById('deleteSelectedGastosBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Suppression...';
            
            let deletedCount = 0;
            let errorCount = 0;
            
            for (const gastoId of selectedGastos) {
                try {
                    const response = await fetch(`/api/gastos/${gastoId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        deletedCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
                
                // Peque√±a pausa para no sobrecargar el servidor
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Restaurar bot√≥n
            btn.disabled = false;
            btn.innerHTML = 'üóëÔ∏è Supprimer S√©lectionn√©s';
            
            // Mostrar resultado y recargar
            if (deletedCount > 0) {
                showMessage(`‚úÖ ${deletedCount} tickets supprim√©s correctement${errorCount > 0 ? ` (${errorCount} erreurs)` : ''}`, 'success');
                loadGastos();
                selectedGastos.clear();
                updateGastosSelection();
            } else {
                showMessage('‚ùå Impossible de supprimer les tickets', 'error');
            }
        }

        // Confirmar tickets s√©lectionn√©s
        async function confirmSelectedTickets() {
            if (selectedDashboard.size === 0) return;
            
            const btn = document.getElementById('confirmSelectedBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Confirmando...';
            
            let confirmedCount = 0;
            let errorCount = 0;
            
            for (const gastoId of selectedDashboard) {
                try {
                    const response = await fetch(`/api/gastos/${gastoId}/checkeado`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ checkeado: true })
                    });
                    
                    if (response.ok) {
                        // Actualizar el estado local
                        const gasto = gastos.find(g => g.id === gastoId);
                        if (gasto) {
                            gasto.checkeado = true;
                        }
                        confirmedCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
                
                // Peque√±a pausa para no sobrecargar el servidor
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            // Restaurar bot√≥n
            btn.disabled = false;
            btn.innerHTML = '‚úÖ Confirmar Seleccionados';
            
            // Mostrar resultado y recargar vista preservando filtros de fecha
            if (confirmedCount > 0) {
                showMessage(`‚úÖ ${confirmedCount} tickets confirmados${errorCount > 0 ? ` (${errorCount} errores)` : ''}`, 'success');
                // Preservar y aplicar filtros de fecha existentes
                renderDashboardFilteredExpenses();
                selectedDashboard.clear();
                updateDashboardSelection();
                // Asegurar que las estad√≠sticas se mantengan actualizadas
                updateDashboardStats();
            } else {
                showMessage('‚ùå Impossible de confirmer les tickets', 'error');
            }
        }

        // Desmarcar tickets s√©lectionn√©s
        async function unconfirmSelectedTickets() {
            if (selectedDashboard.size === 0) return;
            
            const btn = document.getElementById('unconfirmSelectedBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Desmarcando...';
            
            let unconfirmedCount = 0;
            let errorCount = 0;
            
            for (const gastoId of selectedDashboard) {
                try {
                    const response = await fetch(`/api/gastos/${gastoId}/checkeado`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ checkeado: false })
                    });
                    
                    if (response.ok) {
                        // Actualizar el estado local
                        const gasto = gastos.find(g => g.id === gastoId);
                        if (gasto) {
                            gasto.checkeado = false;
                        }
                        unconfirmedCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
                
                // Peque√±a pausa para no sobrecargar el servidor
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            // Restaurar bot√≥n
            btn.disabled = false;
            btn.innerHTML = '‚è≥ Desmarcar Seleccionados';
            
            // Mostrar resultado y recargar vista preservando filtros de fecha
            if (unconfirmedCount > 0) {
                showMessage(`‚úÖ ${unconfirmedCount} tickets desmarcados${errorCount > 0 ? ` (${errorCount} errores)` : ''}`, 'success');
                // Preservar y aplicar filtros de fecha existentes
                renderDashboardFilteredExpenses();
                selectedDashboard.clear();
                updateDashboardSelection();
                // Asegurar que las estad√≠sticas se mantengan actualizadas
                updateDashboardStats();
            } else {
                showMessage('‚ùå Impossible de d√©cocher les tickets', 'error');
            }
        }

        // === FUNCIONES PARA EXPORTAR TODO ===

        // Exportar todo (PDF + Excel + Im√°genes) para gastos
        async function exportAll() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                showMessage('‚ö†Ô∏è Por favor, selecciona un rango de fechas para exportar', 'warning');
                return;
            }
            
            const btn = document.querySelector('button[onclick="exportAll()"]');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Exportando Todo...';
            
            try {
                showMessage('üì¶ Generando archivo ZIP completo...', 'info');
                
                // Crear URL con par√°metros
                let url = `/api/export/zip?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                
                // Agregar filtro de usuario si est√° seleccionado
                const userFilter = document.getElementById('gastosUserFilter');
                if (userFilter && userFilter.value) {
                    url += `&user=${userFilter.value}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar ZIP completo');
                }
                
                // Crear blob y descargar
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `gastos_completo_${fechaInicio}_${fechaFin}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL
                window.URL.revokeObjectURL(downloadUrl);
                
                showMessage('‚úÖ Archivo ZIP completo descargado exitosamente', 'success');
            } catch (error) {
                showMessage('‚ùå Error durante la exportaci√≥n completa: ' + error.message, 'error');
                console.error('Error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üì¶ Exportar Todo';
            }
        }

        // Exportar todo (PDF + Excel + Im√°genes) para dashboard
        async function exportDashboardAll() {
            const fechaInicio = document.getElementById('dashboardFechaInicio').value;
            const fechaFin = document.getElementById('dashboardFechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                showMessage('‚ö†Ô∏è Por favor, selecciona un rango de fechas para exportar', 'warning');
                return;
            }
            
            const btn = document.querySelector('button[onclick="exportDashboardAll()"]');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Exportando Todo...';
            
            try {
                showMessage('üì¶ Generando archivo ZIP completo del dashboard...', 'info');
                
                // Crear URL con par√°metros
                let url = `/api/export/zip?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                
                // Agregar filtro de usuario si est√° seleccionado
                const userFilter = document.getElementById('dashboardUserFilter');
                if (userFilter && userFilter.value) {
                    url += `&user=${userFilter.value}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar ZIP completo');
                }
                
                // Crear blob y descargar
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `dashboard_completo_${fechaInicio}_${fechaFin}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL
                window.URL.revokeObjectURL(downloadUrl);
                
                showMessage('‚úÖ Archivo ZIP completo del dashboard descargado exitosamente', 'success');
            } catch (error) {
                showMessage('‚ùå Error durante la exportaci√≥n completa del dashboard: ' + error.message, 'error');
                console.error('Error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üì¶ Exportar Todo';
            }
        }



        // === FIN FUNCIONES PARA SELECCI√ìN M√öLTIPLE Y EXPORTACI√ìN ===
    </script>
</body>
</html>
</html>